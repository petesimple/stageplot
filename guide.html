<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0d12" />
  <title>StagePlot v2 Guide</title>
  <style>
    :root{
      --bg:#0b0d12;
      --panel:#121826;
      --panel2:#0f1420;
      --line:#26324a;
      --text:#e9eefb;
      --muted:#a9b4cc;
      --accent:#4aa3ff;
      --ok:#40d98a;
      --warn:#ffcc66;
      --danger:#ff5a6a;

      --chip: rgba(255,255,255,.06);
      --chipBorder: rgba(255,255,255,.12);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 700px at 50% -10%, #1a2540, var(--bg));
      color: var(--text);
      line-height:1.5;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 20;
      border-bottom: 1px solid var(--line);
      background: rgba(10,12,18,.78);
      backdrop-filter: blur(10px);
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 12px 14px;
    }

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .title{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 240px;
    }

    .logo{
      width:34px; height:34px;
      border-radius:12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:center;
      color: var(--accent);
      font-weight: 900;
      user-select:none;
    }

    h1{
      font-size: 15px;
      margin:0;
      letter-spacing:.2px;
      line-height:1.2;
    }

    .sub{
      color: var(--muted);
      font-size: 12px;
      margin-top: 2px;
    }

    a.button, button, .btn{
      font: inherit;
      color: var(--text);
      background: var(--chip);
      border: 1px solid var(--chipBorder);
      border-radius: 12px;
      padding: 9px 11px;
      text-decoration:none;
      cursor:pointer;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    a.button:hover, button:hover, .btn:hover{ border-color: rgba(74,163,255,.8); }
    a.button:active, button:active, .btn:active{ transform: translateY(1px); }

    .primary{
      background: rgba(74,163,255,.14);
      border-color: rgba(74,163,255,.55);
    }
    .ok{
      background: rgba(64,217,138,.10);
      border-color: rgba(64,217,138,.35);
    }

    main{
      max-width: 980px;
      margin: 0 auto;
      padding: 14px 14px 26px 14px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .card{
      background: linear-gradient(180deg, rgba(18,24,38,.92), rgba(12,16,26,.92));
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      min-width: 0;
    }
    .card .hd{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .card .hd h2{
      margin:0;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .35px;
      font-weight: 800;
    }
    .card .bd{
      padding: 12px 12px 14px 12px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
      white-space:nowrap;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 860px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .muted{ color: var(--muted); }
    .hr{ height:1px; background: rgba(255,255,255,.08); margin: 12px 0; }

    ul{ margin: 8px 0 0 18px; }
    li{ margin: 6px 0; }

    .k{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      padding: 2px 7px;
      border-radius: 8px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      display:inline-block;
      margin: 0 2px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      width:100%;
    }

    input[type="text"], textarea{
      width:100%;
      color: var(--text);
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 9px 10px;
      outline:none;
      font: inherit;
    }
    textarea{ min-height: 78px; resize: vertical; }

    .qrWrap{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-start;
    }
    .qrBox{
      width: 240px;
      max-width: 100%;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      padding: 10px;
    }
    .qrCanvas{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius: 12px;
      background: #fff;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    canvas{ width: 100%; height: 100%; image-rendering: pixelated; }

    .tiny{
      font-size:12px;
      color: var(--muted);
    }

    .callout{
      border-left: 3px solid rgba(74,163,255,.75);
      background: rgba(74,163,255,.06);
      border-radius: 12px;
      padding: 10px 10px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <div class="logo" aria-hidden="true">SP</div>
        <div>
          <h1>StagePlot v2 Guide</h1>
          <div class="sub">How to build a clean one page stage plot, share it, and get back to the music.</div>
        </div>
      </div>

      <div class="row">
        <a class="button primary" href="./index.html">Back to app</a>
        <button class="button" id="btnPrintGuide" type="button">Print guide</button>
      </div>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <div class="hd">
      <h2>Quick links</h2>
      <span class="pill">fast travel for busy humans</span>
    </div>
    <div class="bd">
      <div class="row">
        <a class="btn" href="./index.html">Open the app</a>
        <button class="btn" id="btnCopyAppLink" type="button">Copy app link</button>
        <button class="btn" id="btnShareApp" type="button">Share app</button>
        <a class="btn ok" id="donateLink" href="#" target="_blank" rel="noopener">Donate</a>
      </div>

      <div class="hr"></div>

      <div class="callout">
        <div><strong>Donate link note</strong></div>
        <div class="muted" style="margin-top:6px;">
          I did not see your donate URL in this chat, so I left a safe placeholder.
          Open this file and set <span class="k">DONATE_URL</span> in the script near the bottom.
          Once you paste it, the Donate button and QR section can use it instantly.
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="hd">
      <h2>How to use StagePlot</h2>
      <span class="pill">zero drama, maximum clarity</span>
    </div>
    <div class="bd">
      <div class="grid2">
        <div>
          <h3 style="margin:0 0 6px 0; font-size:14px;">1) Set your stage</h3>
          <div class="muted">
            Choose a preset or enter custom Width and Depth. The stage always fits in the square at 100%.
            View Zoom is just your magnifying glass.
          </div>
          <ul>
            <li>Toggle units with the Units button (ft or m)</li>
            <li>Flip Stage View or Audience View to match how you think</li>
          </ul>

          <div class="hr"></div>

          <h3 style="margin:0 0 6px 0; font-size:14px;">2) Add items</h3>
          <div class="muted">
            Use the Item Library to drop musicians and gear onto the stage. Then drag to position.
          </div>
          <ul>
            <li>Click an item to select</li>
            <li>Shift, Ctrl, or Cmd click to multi select</li>
            <li>Duplicate selected items for quick copies</li>
          </ul>
        </div>

        <div>
          <h3 style="margin:0 0 6px 0; font-size:14px;">3) Edit details in the Info panel</h3>
          <div class="muted">
            Fill Label, Input, Mix, and Notes. StagePlot builds your Inputs and Monitor Mix lists automatically.
          </div>
          <ul>
            <li>Label example: "Pete Vox"</li>
            <li>Input example: "Ch 1"</li>
            <li>Mix example: "M1" or "IEM"</li>
          </ul>

          <div class="hr"></div>

          <h3 style="margin:0 0 6px 0; font-size:14px;">4) Size, scale, rotate, nudge</h3>
          <ul>
            <li>Width and Depth change the base footprint</li>
            <li>Scale multiplies the footprint</li>
            <li>On touch screens, pinch the selected item to scale</li>
            <li>Use the under stage Selected item tools for nudge and sizing</li>
          </ul>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div>
          <h3 style="margin:0 0 6px 0; font-size:14px;">Keyboard shortcuts</h3>
          <ul>
            <li><span class="k">Shift</span> + <span class="k">Arrow keys</span> nudges selected items</li>
            <li><span class="k">Delete</span> removes selected items</li>
            <li><span class="k">Esc</span> clears selection</li>
            <li><span class="k">Ctrl</span> or <span class="k">Cmd</span> + <span class="k">D</span> duplicates selection</li>
          </ul>
        </div>

        <div>
          <h3 style="margin:0 0 6px 0; font-size:14px;">Printing</h3>
          <div class="muted">
            Hit Print in the app. It temporarily resets view zoom to 100% so your stage does not print as a microscope photo.
          </div>
          <ul>
            <li>Pro move: fill Band and Show notes so FOH loves you forever</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="hd">
      <h2>Share with QR code</h2>
      <span class="pill">scan it, send it, done</span>
    </div>
    <div class="bd">
      <div class="qrWrap">
        <div class="qrBox">
          <div class="tiny" style="margin-bottom:8px;">App link QR</div>
          <div class="qrCanvas"><canvas id="qrApp" width="600" height="600" aria-label="QR code for app link"></canvas></div>
          <div class="row" style="margin-top:10px;">
            <button class="btn" id="btnCopyQrAppText" type="button">Copy link</button>
            <button class="btn" id="btnDownloadQrApp" type="button">Save QR</button>
          </div>
          <div class="tiny" style="margin-top:8px;" id="appUrlText"></div>
        </div>

        <div class="qrBox">
          <div class="tiny" style="margin-bottom:8px;">Donate QR</div>
          <div class="qrCanvas"><canvas id="qrDonate" width="600" height="600" aria-label="QR code for donate link"></canvas></div>
          <div class="row" style="margin-top:10px;">
            <button class="btn" id="btnCopyDonate" type="button">Copy donate link</button>
            <button class="btn" id="btnDownloadQrDonate" type="button">Save QR</button>
          </div>
          <div class="tiny" style="margin-top:8px;" id="donateUrlText"></div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="muted">
        Sharing tip: the QR codes in this guide point to the app itself and the donate link. For sharing a specific stage plot,
        use Export Project JSON inside the app and send that file to your bandmate or engineer.
      </div>
    </div>
  </section>

  <section class="card">
    <div class="hd">
      <h2>Troubleshooting</h2>
      <span class="pill">because phones be phonin</span>
    </div>
    <div class="bd">
      <ul>
        <li><strong>My items are hard to move</strong> - Use View Zoom to zoom in, or use Nudge controls for precision.</li>
        <li><strong>Pinch does not scale</strong> - Make sure the item is selected (blue outline) and pinch directly on it, not the empty stage.</li>
        <li><strong>I flipped the view and got confused</strong> - Flip is only your view. Your stored positions stay correct.</li>
        <li><strong>Lists are empty</strong> - Add Labels and Inputs or Mixes to items, then the tables fill automatically.</li>
      </ul>
    </div>
  </section>

  <section class="card">
    <div class="hd">
      <h2>Quick share text</h2>
      <span class="pill">copy paste for lazy legends</span>
    </div>
    <div class="bd">
      <div class="field">
        <label class="muted">Message template</label>
        <textarea id="shareTemplate" spellcheck="false"></textarea>
      </div>
      <div class="row">
        <button class="btn primary" id="btnCopyTemplate" type="button">Copy message</button>
        <button class="btn" id="btnShareTemplate" type="button">Share message</button>
      </div>
      <div class="tiny" style="margin-top:10px;">
        Replace the attached JSON file part with Export Project JSON from inside the app.
      </div>
    </div>
  </section>
</main>

<script>
(() => {
  // IMPORTANT: Paste your donate URL here.
  // Example: const DONATE_URL = "https://your-donate-link";
  const DONATE_URL = ""; // <- set this

  const $ = (id) => document.getElementById(id);

  const appUrl = (location.href || "").replace(/guide\.html.*$/i, "index.html");
  const donateUrl = DONATE_URL || "Set DONATE_URL in guide.html";

  $("appUrlText").textContent = appUrl;
  $("donateUrlText").textContent = donateUrl;

  const donateLink = $("donateLink");
  if(DONATE_URL){
    donateLink.href = DONATE_URL;
    donateLink.title = DONATE_URL;
  }else{
    donateLink.href = "#";
    donateLink.title = "Set DONATE_URL in this file";
    donateLink.addEventListener("click", (e) => {
      e.preventDefault();
      alert("Donate link is not set yet. Open guide.html and paste your donate URL into DONATE_URL near the bottom.");
    });
  }

  $("btnPrintGuide").addEventListener("click", () => window.print());

  $("btnCopyAppLink").addEventListener("click", async () => {
    await copyText(appUrl);
    toast("App link copied");
  });

  $("btnShareApp").addEventListener("click", async () => {
    await shareText("StagePlot v2", `StagePlot v2 link: ${appUrl}`, appUrl);
  });

  $("btnCopyQrAppText").addEventListener("click", async () => {
    await copyText(appUrl);
    toast("Link copied");
  });

  $("btnCopyDonate").addEventListener("click", async () => {
    if(!DONATE_URL){
      alert("Donate link is not set yet. Set DONATE_URL in this file.");
      return;
    }
    await copyText(DONATE_URL);
    toast("Donate link copied");
  });

  // Share template
  const template =
`Hey! Here is our StagePlot v2 link:
${appUrl}

If you need the exact layout, I will also send the exported project JSON file from inside the app.

Bonus button if you feel like supporting the project:
${DONATE_URL ? DONATE_URL : "https://www.paypal.com/donate/?hosted_button_id=4BP339J2UAL46"}`;

  $("shareTemplate").value = template;

  $("btnCopyTemplate").addEventListener("click", async () => {
    await copyText($("shareTemplate").value);
    toast("Message copied");
  });

  $("btnShareTemplate").addEventListener("click", async () => {
    await shareText("StagePlot v2", $("shareTemplate").value, appUrl);
  });

  // QR generation (simple QR, no external libs)
  // This is a compact QR encoder that supports byte mode, version auto up to v10, ECC M.
  // It is intentionally small and practical for share links. Not a full QR spec monster.
  function makeQR(canvas, text){
    const ctx = canvas.getContext("2d");
    ctx.fillStyle = "#fff";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    const qr = QRCodeMini.encode(text);
    const cells = qr.modules;
    const n = cells.length;

    const quiet = 4; // modules
    const total = n + quiet*2;

    const scale = Math.floor(canvas.width / total);
    const offset = Math.floor((canvas.width - total*scale)/2);

    ctx.fillStyle = "#fff";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.fillStyle = "#000";
    for(let r=0;r<n;r++){
      for(let c=0;c<n;c++){
        if(cells[r][c]){
          const x = offset + (c+quiet)*scale;
          const y = offset + (r+quiet)*scale;
          ctx.fillRect(x,y,scale,scale);
        }
      }
    }
  }

  makeQR($("qrApp"), appUrl);
  makeQR($("qrDonate"), DONATE_URL || ""); // blank if not set

  $("btnDownloadQrApp").addEventListener("click", () => downloadCanvas($("qrApp"), "stageplot-app-qr.png"));
  $("btnDownloadQrDonate").addEventListener("click", () => {
    if(!DONATE_URL){
      alert("Donate link is not set yet. Set DONATE_URL in this file first.");
      return;
    }
    downloadCanvas($("qrDonate"), "stageplot-donate-qr.png");
  });

  async function copyText(t){
    try{
      await navigator.clipboard.writeText(t);
    }catch(e){
      // fallback
      const ta = document.createElement("textarea");
      ta.value = t;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
    }
  }

  async function shareText(title, text, url){
    if(navigator.share){
      try{
        await navigator.share({ title, text, url });
        return;
      }catch(e){}
    }
    await copyText(text + (url ? "\n" + url : ""));
    toast("Sharing not available, copied instead");
  }

  function downloadCanvas(canvas, filename){
    const a = document.createElement("a");
    a.download = filename;
    a.href = canvas.toDataURL("image/png");
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // tiny toast
  let toastTimer = null;
  function toast(msg){
    let el = document.getElementById("toast");
    if(!el){
      el = document.createElement("div");
      el.id = "toast";
      el.style.position = "fixed";
      el.style.left = "50%";
      el.style.bottom = "18px";
      el.style.transform = "translateX(-50%)";
      el.style.padding = "10px 12px";
      el.style.borderRadius = "12px";
      el.style.background = "rgba(0,0,0,.72)";
      el.style.border = "1px solid rgba(255,255,255,.14)";
      el.style.color = "#fff";
      el.style.zIndex = "9999";
      el.style.fontSize = "13px";
      el.style.backdropFilter = "blur(8px)";
      document.body.appendChild(el);
    }
    el.textContent = msg;
    el.style.opacity = "1";
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => { el.style.opacity = "0"; }, 1200);
  }

  // ---------------------------------------------------------
  // QRCodeMini: lightweight QR encoder (byte mode, ECC M)
  // ---------------------------------------------------------
  const QRCodeMini = (() => {
    // Galois field arithmetic
    const EXP = new Array(512);
    const LOG = new Array(256);
    (function initGF(){
      let x = 1;
      for(let i=0;i<255;i++){
        EXP[i] = x;
        LOG[x] = i;
        x <<= 1;
        if(x & 0x100) x ^= 0x11d;
      }
      for(let i=255;i<512;i++) EXP[i] = EXP[i-255];
    })();

    function gfMul(a,b){
      if(a===0 || b===0) return 0;
      return EXP[LOG[a] + LOG[b]];
    }

    function rsGenPoly(deg){
      let poly = [1];
      for(let i=0;i<deg;i++){
        poly = rsPolyMul(poly, [1, EXP[i]]);
      }
      return poly;
    }

    function rsPolyMul(p,q){
      const out = new Array(p.length + q.length - 1).fill(0);
      for(let i=0;i<p.length;i++){
        for(let j=0;j<q.length;j++){
          out[i+j] ^= gfMul(p[i], q[j]);
        }
      }
      return out;
    }

    function rsCompute(data, ecLen){
      const gen = rsGenPoly(ecLen);
      const msg = data.slice();
      msg.push(...new Array(ecLen).fill(0));
      for(let i=0;i<data.length;i++){
        const coef = msg[i];
        if(coef !== 0){
          for(let j=0;j<gen.length;j++){
            msg[i+j] ^= gfMul(gen[j], coef);
          }
        }
      }
      return msg.slice(msg.length - ecLen);
    }

    function bytesFromString(s){
      // UTF-8
      const enc = new TextEncoder();
      return Array.from(enc.encode(s));
    }

    // Version table up to 10 (byte mode capacity, ecc M)
    const V = [
      null,
      { size:21, data:16, ec:10 },  // v1 M
      { size:25, data:28, ec:16 },  // v2 M
      { size:29, data:44, ec:26 },  // v3 M
      { size:33, data:64, ec:36 },  // v4 M
      { size:37, data:86, ec:48 },  // v5 M
      { size:41, data:108, ec:64 }, // v6 M
      { size:45, data:124, ec:72 }, // v7 M
      { size:49, data:154, ec:88 }, // v8 M
      { size:53, data:182, ec:110 },// v9 M
      { size:57, data:216, ec:130 } // v10 M
    ];

    function chooseVersion(byteLen){
      for(let v=1; v<=10; v++){
        if(byteLen <= V[v].data - 2) return v; // leave room for mode+len
      }
      return 10;
    }

    function pushBits(bits, val, len){
      for(let i=len-1;i>=0;i--){
        bits.push((val >> i) & 1);
      }
    }

    function encodeDataBytes(bytes, version){
      const cap = V[version].data;

      const bits = [];
      // mode 0100 (byte)
      pushBits(bits, 0b0100, 4);

      // length (8 bits for v1-9, 16 for v10+, but we only go to v10)
      const lenBits = (version <= 9) ? 8 : 16;
      pushBits(bits, bytes.length, lenBits);

      for(const b of bytes) pushBits(bits, b, 8);

      // terminator
      const maxBits = cap * 8;
      const remaining = maxBits - bits.length;
      const term = Math.min(4, remaining);
      pushBits(bits, 0, term);

      // pad to byte
      while(bits.length % 8) bits.push(0);

      // to bytes
      const out = [];
      for(let i=0;i<bits.length;i+=8){
        let x=0;
        for(let j=0;j<8;j++) x = (x<<1) | bits[i+j];
        out.push(x);
      }

      // pad bytes
      const PAD0 = 0xec, PAD1 = 0x11;
      let flip = true;
      while(out.length < cap){
        out.push(flip ? PAD0 : PAD1);
        flip = !flip;
      }
      return out;
    }

    function makeBaseMatrix(n){
      const m = Array.from({length:n}, () => Array(n).fill(null));
      const r = Array.from({length:n}, () => Array(n).fill(false)); // reserved

      function placeFinder(x,y){
        for(let dy=-1; dy<=7; dy++){
          for(let dx=-1; dx<=7; dx++){
            const xx = x+dx, yy=y+dy;
            if(xx<0||yy<0||xx>=n||yy>=n) continue;
            const onBorder = (dx===-1||dx===7||dy===-1||dy===7);
            const inBox = (dx>=0&&dx<=6&&dy>=0&&dy<=6);
            let val = false;
            if(onBorder) val = false;
            else if(inBox){
              const ring = (dx===0||dx===6||dy===0||dy===6);
              const center = (dx>=2&&dx<=4&&dy>=2&&dy<=4);
              val = ring || center;
            }
            m[yy][xx] = val;
            r[yy][xx] = true;
          }
        }
      }

      placeFinder(0,0);
      placeFinder(n-7,0);
      placeFinder(0,n-7);

      // timing patterns
      for(let i=8;i<n-8;i++){
        const v = (i % 2) === 0;
        if(!r[6][i]){ m[6][i]=v; r[6][i]=true; }
        if(!r[i][6]){ m[i][6]=v; r[i][6]=true; }
      }

      // dark module
      const dmY = 4*1 + 9; // for version 1..10, formula is (4*version+9, 8)
      const dmX = 8;
      if(dmY < n){
        m[dmY][dmX] = true;
        r[dmY][dmX] = true;
      }

      // format info reserved areas
      for(let i=0;i<9;i++){
        if(i!==6){ r[8][i]=true; r[i][8]=true; }
      }
      for(let i=n-8;i<n;i++){
        r[8][i]=true;
        r[i][8]=true;
      }
      r[8][8]=true;

      return { m, r };
    }

    function placeData(matrix, reserved, dataBits){
      const n = matrix.length;
      let bitIndex = 0;

      function nextBit(){
        return (bitIndex < dataBits.length) ? dataBits[bitIndex++] : 0;
      }

      let dirUp = true;
      for(let x=n-1; x>0; x-=2){
        if(x===6) x--; // skip timing column
        for(let dy=0; dy<n; dy++){
          const y = dirUp ? (n-1-dy) : dy;
          for(let xx=0; xx<2; xx++){
            const cx = x-xx;
            if(reserved[y][cx]) continue;
            matrix[y][cx] = nextBit() === 1;
          }
        }
        dirUp = !dirUp;
      }
    }

    // Format info for ECC M and mask 0
    // ECC M = 00, mask 000
    const FORMAT_MASK = 0b101010000010010;
    function formatBits(){
      // 5 bits: ecc(2)+mask(3) => 00 000
      let v = 0; // 00000
      // BCH(15,5)
      let b = v << 10;
      const poly = 0b10100110111;
      for(let i=14;i>=10;i--){
        if((b >> i) & 1) b ^= (poly << (i-10));
      }
      const code = ((v << 10) | (b & 0x3ff)) ^ FORMAT_MASK;
      const out = [];
      for(let i=14;i>=0;i--) out.push((code >> i) & 1);
      return out;
    }

    function applyMask0(matrix, reserved){
      const n = matrix.length;
      for(let y=0;y<n;y++){
        for(let x=0;x<n;x++){
          if(reserved[y][x]) continue;
          // mask 0: (x+y)%2==0
          if(((x+y)&1)===0) matrix[y][x] = !matrix[y][x];
        }
      }
    }

    function placeFormat(matrix, reserved){
      const n = matrix.length;
      const bits = formatBits();
      let i=0;

      // around top-left
      for(let x=0;x<=5;x++) matrix[8][x] = bits[i++]===1;
      matrix[8][7] = bits[i++]===1;
      matrix[8][8] = bits[i++]===1;
      matrix[7][8] = bits[i++]===1;
      for(let y=5;y>=0;y--) matrix[y][8] = bits[i++]===1;

      // top-right and bottom-left
      for(let x=n-1; x>=n-8; x--) matrix[8][x] = bits[i++]===1;
      for(let y=n-7; y<=n-1; y++) matrix[y][8] = bits[i++]===1;

      // mark reserved (defensive)
      for(let x=0;x<9;x++) reserved[8][x]=true;
      for(let y=0;y<9;y++) reserved[y][8]=true;
      for(let x=n-8;x<n;x++) reserved[8][x]=true;
      for(let y=n-7;y<n;y++) reserved[y][8]=true;
    }

    function bitsFromBytes(bytes){
      const out = [];
      for(const b of bytes){
        for(let i=7;i>=0;i--) out.push((b>>i)&1);
      }
      return out;
    }

    function encode(text){
      const bytes = bytesFromString(text);
      const version = chooseVersion(bytes.length);
      const data = encodeDataBytes(bytes, version);
      const ec = rsCompute(data, V[version].ec);
      const all = data.concat(ec);

      const { m, r } = makeBaseMatrix(V[version].size);

      // place data
      const bits = bitsFromBytes(all);
      placeData(m, r, bits);

      // mask and format
      applyMask0(m, r);
      placeFormat(m, r);

      // replace nulls with false
      for(let y=0;y<m.length;y++){
        for(let x=0;x<m.length;x++){
          if(m[y][x] == null) m[y][x] = false;
        }
      }

      return { modules: m, version };
    }

    return { encode };
  })();
})();
</script>
</body>
</html>
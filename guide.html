<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0d12" />
  <title>StagePlot v2 - Guide (v1.7.5)</title>
  <style>
    :root{
      --bg:#0b0d12;
      --panel:#121826;
      --panel2:#0f1420;
      --line:#26324a;
      --text:#e9eefb;
      --muted:#a9b4cc;
      --accent:#4aa3ff;
      --ok:#40d98a;
      --warn:#ffcc66;
      --danger:#ff5a6a;

      --chip: rgba(255,255,255,.06);
      --chipBorder: rgba(255,255,255,.12);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 700px at 50% -10%, #1a2540, var(--bg));
      color: var(--text);
      line-height:1.5;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 20;
      border-bottom: 1px solid var(--line);
      background: rgba(10,12,18,.78);
      backdrop-filter: blur(10px);
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 12px 14px;
    }
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .title{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 240px;
    }
    .logo{
      width:32px; height:32px;
      border-radius:10px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:center;
      color: var(--accent);
      font-weight: 900;
      user-select:none;
    }
    h1{
      font-size: 15px;
      margin:0;
      letter-spacing:.2px;
      line-height:1.2;
    }
    .sub{
      color: var(--muted);
      font-size: 12px;
      margin-top: 2px;
    }

    a.button, button, .btn{
      font: inherit;
      color: var(--text);
      background: var(--chip);
      border: 1px solid var(--chipBorder);
      border-radius: 12px;
      padding: 9px 10px;
      text-decoration:none;
      cursor:pointer;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    a.button:hover, button:hover, .btn:hover{ border-color: rgba(74,163,255,.8); }
    a.button:active, button:active, .btn:active{ transform: translateY(1px); }
    .primary{
      background: rgba(74,163,255,.14);
      border-color: rgba(74,163,255,.55);
    }
    .danger{
      background: rgba(255,90,106,.10);
      border-color: rgba(255,90,106,.35);
    }
    .ok{
      background: rgba(64,217,138,.10);
      border-color: rgba(64,217,138,.40);
    }

    main{
      max-width: 980px;
      margin: 0 auto;
      padding: 14px 14px 34px 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .card{
      background: linear-gradient(180deg, rgba(18,24,38,.92), rgba(12,16,26,.92));
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      min-width: 0;
    }
    .card .hd{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .card .hd h2{
      margin:0;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .35px;
      font-weight: 900;
    }
    .card .bd{ padding: 12px 12px 14px 12px; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
      white-space:nowrap;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .row.tight{ gap:8px; }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 860px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .miniHelp{ color: var(--muted); font-size: 12px; }
    .hr{ height:1px; background: rgba(255,255,255,.08); margin: 10px 0; }

    code, .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    code{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      padding: 2px 6px;
      border-radius: 8px;
    }

    ul{ margin: 8px 0 0 18px; padding:0; }
    li{ margin: 6px 0; }

    .linkList{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    @media (max-width: 620px){
      .linkList{ grid-template-columns: 1fr; }
    }
    .linkTile{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 10px;
    }
    .linkTile .t{
      font-weight: 900;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .linkTile .d{ color: var(--muted); font-size: 12px; }
    .linkTile .row{ margin-top: 10px; }

    /* QR Modal */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.60);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 999;
    }
    .modal.on{ display:flex; }
    .modalCard{
      width:min(520px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(18,24,38,.98), rgba(12,16,26,.98));
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHd{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalHd .t{
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .35px;
      font-weight: 900;
    }
    .modalBd{ padding: 14px 12px 14px 12px; }
    .qrBox{
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      padding: 14px;
      overflow:auto;
    }
    .qrCaption{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      word-break: break-word;
    }
    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(18,24,38,.95);
      border: 1px solid rgba(255,255,255,.14);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.40);
      color: var(--text);
      font-size: 13px;
      display:none;
      z-index: 1000;
    }
    .toast.on{ display:block; }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <div class="logo" aria-hidden="true">SP</div>
        <div>
          <h1>StagePlot v2 Guide</h1>
          <div class="sub">How to use it, how to share it, and how to keep the triangle from hiding in plain sight</div>
        </div>
      </div>
      <div class="row tight">
        <span class="pill">Guide v1.7.3</span>
        <a class="button primary" id="btnOpenApp" href="./index.html">Open the app</a>
        <button class="btn" id="btnShare">Share + QR</button>
        <a class="button ok" id="btnDonateTop" href="https://www.paypal.com/donate/?hosted_button_id=4BP339J2UAL46" target="_blank" rel="noopener">Donate</a>
      </div>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <div class="hd">
      <h2>Whats New in v1.7.3</h2>
      <span class="pill">Triangle + Fixes</span>
    </div>
    <div class="bd">
      <div class="grid2">
        <div>
          <div class="miniHelp"><b>New shape: Triangle</b></div>
          <ul>
            <li>Select an item, then choose <b>Triangle</b> in the shape control.</li>
            <li>Triangles use <code>clip-path</code>, so we show selection using a glow instead of outline.</li>
          </ul>

          <div class="hr"></div>

          <div class="miniHelp"><b>Circles stay circles</b></div>
          <ul>
            <li>Circle mode now enforces equal width and height so it does not turn into an oval.</li>
            <li>If you had older stretched circles, toggle shape off and back to circle to re-normalize.</li>
          </ul>
        </div>

        <div>
          <div class="miniHelp"><b>Triangle selection highlight</b></div>
          <ul>
            <li>If a triangle is selected, you should see a visible glow. No more invisible selection.</li>
            <li>Multi-select triangles also glow so you can see what is included.</li>
          </ul>

          <div class="hr"></div>

          <div class="miniHelp"><b>iOS double tap zoom reduction</b></div>
          <ul>
            <li>Stage area gestures are less likely to trigger Safari zoom.</li>
            <li>If something feels odd on iPhone, reload once after installing as a PWA.</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="hd">
      <h2>Quick Links</h2>
      <span class="pill">Fast stuff first</span>
    </div>
    <div class="bd">
      <div class="miniHelp">
        If you are in a hurry, this is the "get in, get it done, get paid" section.
      </div>

      <div class="linkList">
        <div class="linkTile">
          <div class="t">Open StagePlot</div>
          <div class="d">The main app page</div>
          <div class="row">
            <a class="button primary" href="./index.html">Open index.html</a>
          </div>
        </div>

        <div class="linkTile">
          <div class="t">Share + QR Code</div>
          <div class="d">Send your plot to bandmates or the venue</div>
          <div class="row">
            <button class="btn" id="btnShare2">Open Share panel</button>
          </div>
        </div>

        <div class="linkTile">
          <div class="t">Donate</div>
          <div class="d">Fuel the feature gremlins (they run on snacks)</div>
          <div class="row">
            <a class="button ok" href="https://www.paypal.com/donate/?hosted_button_id=4BP339J2UAL46" target="_blank" rel="noopener">PayPal Donate</a>
          </div>
        </div>

        <div class="linkTile">
          <div class="t">Print</div>
          <div class="d">One page handoff for FOH or the stage manager</div>
          <div class="row">
            <span class="pill">In app: Print button</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="hd">
      <h2>Getting Started</h2>
      <span class="pill">Make a stage plot in minutes</span>
    </div>
    <div class="bd">
      <div class="grid2">
        <div>
          <div class="miniHelp">1) Set your stage size</div>
          <ul>
            <li>Open the <b>Layout</b> section.</li>
            <li>Pick a preset: Small, Medium, Large.</li>
            <li>Or choose Custom and type <code>Width</code> and <code>Depth</code>.</li>
            <li>Toggle <code>ft/m</code> whenever you feel like living dangerously.</li>
          </ul>

          <div class="hr"></div>

          <div class="miniHelp">2) Add items</div>
          <ul>
            <li>Use the Item Library to add Vocal, Guitar, Keys, Drums, wedges, power, etc.</li>
            <li>Items appear centered, ready to drag.</li>
          </ul>
        </div>

        <div>
          <div class="miniHelp">3) Place items</div>
          <ul>
            <li>Drag an item to move it.</li>
            <li>Shift, Cmd, or Ctrl click to multi select.</li>
            <li>All the on-canvas tools are <b>below the stage</b> (nudge, center, resize, and friends).</li>
          </ul>

          <div class="hr"></div>

          <div class="miniHelp">4) Add inputs and mixes</div>
          <ul>
            <li>Select an item and fill out <code>Input</code> and <code>Mix</code>.</li>
            <li>The Inputs and Monitor Mix lists auto-build from your items.</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="hd">
      <h2>Shapes</h2>
      <span class="pill">Circle, Rectangle, Triangle</span>
    </div>
    <div class="bd">
      <div class="grid2">
        <div>
          <div class="miniHelp"><b>Circle</b></div>
          <ul>
            <li>Circle mode forces width and height to match so circles do not become ovals.</li>
            <li>Best for wedges, stools, mic stands, and that one percussionist who brought three shakers and a dream.</li>
          </ul>

          <div class="hr"></div>

          <div class="miniHelp"><b>Rectangle</b></div>
          <ul>
            <li>Default shape for most gear and people.</li>
            <li>Selection shows as an outline.</li>
          </ul>
        </div>

        <div>
          <div class="miniHelp"><b>Triangle</b></div>
          <ul>
            <li>Great for marking corners, risers, or directional props.</li>
            <li>Because triangles use <code>clip-path</code>, selection uses a glow highlight, not an outline.</li>
            <li>If you do not see the glow, you are probably selecting something else (or the triangle is being sneaky).</li>
          </ul>

          <div class="miniHelp" style="margin-top:10px;">
            Nerd note: <code>outline</code> is not reliable with <code>clip-path</code> in some browsers, so glow is the safer selection indicator.
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="hd">
      <h2>Selection, Multi Select, and Tools</h2>
      <span class="pill">The good stuff</span>
    </div>
    <div class="bd">
      <div class="grid2">
        <div>
          <div class="miniHelp">Selecting</div>
          <ul>
            <li>Click an item to select it.</li>
            <li>Shift, Cmd, or Ctrl click to add or remove items from the selection.</li>
            <li><code>Delete</code> or <code>Backspace</code> deletes selected items.</li>
            <li><code>Esc</code> clears selection.</li>
          </ul>

          <div class="hr"></div>

          <div class="miniHelp">Nudge</div>
          <ul>
            <li>Use the on-screen nudge arrows under the stage.</li>
            <li>Or use <code>Shift + Arrow Keys</code> for quick tiny moves.</li>
          </ul>
        </div>

        <div>
          <div class="miniHelp">Resize and Scale</div>
          <ul>
            <li>Set base footprint with <code>Width</code> and <code>Depth</code>.</li>
            <li>Use <code>Scale</code> to grow or shrink the footprint without changing the base size.</li>
            <li>On touch screens, use two-finger pinch on the selected item to scale.</li>
            <li>Rotation is available in the Info panel.</li>
          </ul>

          <div class="hr"></div>

          <div class="miniHelp">Colors</div>
          <ul>
            <li>StagePlot supports item box colors (and yes, multi select color changes is the fun part).</li>
            <li>If you set a color on multiple selected items, they all update together.</li>
          </ul>
        </div>
      </div>

      <div class="miniHelp" style="margin-top:10px;">
        Nerdy detail: View Zoom only changes what you see. It does not change the stage size or item sizes.
      </div>
    </div>
  </section>

  <section class="card">
    <div class="hd">
      <h2>Saving, Exporting, Importing</h2>
      <span class="pill">Backups that do not judge you</span>
    </div>
    <div class="bd">
      <div class="grid2">
        <div>
          <div class="miniHelp">Autosave</div>
          <ul>
            <li>Your work is saved to your browser automatically as you edit.</li>
            <li>If you refresh, it should come back like a loyal dog.</li>
          </ul>
        </div>
        <div>
          <div class="miniHelp">Export and Import Project JSON</div>
          <ul>
            <li>Use <code>Export Project JSON</code> to save a file you can share or archive.</li>
            <li>Use <code>Import Project JSON</code> to load it later on any device.</li>
            <li>If units differ, StagePlot keeps internal measurements consistent and handles the display.</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="hd">
      <h2>Printing a One Page Handoff</h2>
      <span class="pill">FOH friendly</span>
    </div>
    <div class="bd">
      <ul>
        <li>Hit <code>Print</code> in the header.</li>
        <li>StagePlot temporarily resets View Zoom to 100% so the print is clean and predictable.</li>
        <li>Save as PDF if you want to email it to a venue or keep it in your band folder.</li>
      </ul>
      <div class="miniHelp" style="margin-top:10px;">
        Pro tip: Put the band name and show notes in the Info panel so the printout tells the whole story.
      </div>
    </div>
  </section>

  <section class="card">
    <div class="hd">
      <h2>Share and QR Code</h2>
      <span class="pill">Send the plot link in style</span>
    </div>
    <div class="bd">
      <div class="miniHelp">
        This guide page can generate a QR code for your StagePlot link. Great for rehearsals, load-in, and that one bandmate who only reads QR codes because it feels like a side quest.
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnShare3">Open Share + QR</button>
        <button class="btn" id="btnCopyLink">Copy app link</button>
        <a class="button ok" href="https://www.paypal.com/donate/?hosted_button_id=4BP339J2UAL46" target="_blank" rel="noopener">Donate</a>
      </div>

      <div class="miniHelp" style="margin-top:10px;">
        Note: The QR uses the current page location. If you host StagePlot on GitHub Pages, this will point to that hosted URL automatically.
      </div>
    </div>
  </section>

  <section class="card">
    <div class="hd">
      <h2>Donate</h2>
      <span class="pill">Keep it alive</span>
    </div>
    <div class="bd">
      <div class="miniHelp">
        If StagePlot saved you 20 minutes of stage chaos, consider tossing a few bucks in the tip jar. It helps keep the project moving and keeps the app from turning into a sad little folder named "final_final_REAL2".
      </div>

      <div class="row" style="margin-top:12px;">
        <a class="button ok" href="https://www.paypal.com/donate/?hosted_button_id=4BP339J2UAL46" target="_blank" rel="noopener">Donate via PayPal</a>
        <button class="btn" id="btnCopyDonate">Copy donate link</button>
      </div>

      <div class="miniHelp" style="margin-top:10px;">
        Donate URL: <span class="mono" id="donateUrlText">https://www.paypal.com/donate/?hosted_button_id=4BP339J2UAL46</span>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="hd">
      <h2>Troubleshooting</h2>
      <span class="pill">When reality fights back</span>
    </div>
    <div class="bd">
      <ul>
        <li><b>I cannot find Layout</b> - On mobile it is first. On desktop it is at the top of the middle panel section.</li>
        <li><b>I cannot find the tools</b> - Scroll under the stage. All tooling sits below the stage area.</li>
        <li><b>My items look huge</b> - Check <code>View Zoom</code> and reset it to 100% in the app.</li>
        <li><b>I cannot pinch to scale</b> - Make sure the item is selected, then pinch directly on it using two fingers.</li>
        <li><b>My changes disappeared</b> - If the browser storage was cleared, import your exported JSON to restore.</li>
        <li><b>Triangle is selected but I cannot tell</b> - Look for the glow highlight, triangles do not use outline selection.</li>
      </ul>
    </div>
  </section>
</main>

<!-- Share/QR Modal -->
<div class="modal" id="qrModal" role="dialog" aria-modal="true" aria-label="Share and QR">
  <div class="modalCard">
    <div class="modalHd">
      <div class="t">Share + QR</div>
      <button class="btn danger" id="btnCloseQr">Close</button>
    </div>
    <div class="modalBd">
      <div class="qrBox" id="qrBox">
        <!-- QR renders here -->
      </div>
      <div class="qrCaption">
        Link: <span class="mono" id="shareUrlText"></span>
      </div>
      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnNativeShare">Share</button>
        <button class="btn" id="btnCopyShare">Copy link</button>
        <a class="button ok" href="https://www.paypal.com/donate/?hosted_button_id=4BP339J2UAL46" target="_blank" rel="noopener">Donate</a>
      </div>
      <div class="miniHelp" style="margin-top:10px;">
        If Share does not appear on your device, Copy link works everywhere.
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast">Copied</div>

<script>
/* Tiny QR generator (alphanumeric/byte) based on a compact implementation.
   It generates a QR as an SVG with quiet zone.
   Good enough for URLs and short text.
*/
(function(){
  const DONATE_URL = "https://www.paypal.com/donate/?hosted_button_id=4BP339J2UAL46";

  const elModal = document.getElementById("qrModal");
  const elQrBox = document.getElementById("qrBox");
  const elShareUrlText = document.getElementById("shareUrlText");
  const elToast = document.getElementById("toast");

  const btnShare = document.getElementById("btnShare");
  const btnShare2 = document.getElementById("btnShare2");
  const btnShare3 = document.getElementById("btnShare3");
  const btnCloseQr = document.getElementById("btnCloseQr");
  const btnNativeShare = document.getElementById("btnNativeShare");
  const btnCopyShare = document.getElementById("btnCopyShare");
  const btnCopyLink = document.getElementById("btnCopyLink");
  const btnCopyDonate = document.getElementById("btnCopyDonate");

  document.getElementById("donateUrlText").textContent = DONATE_URL;

  // Try to prefer index.html on same folder for sharing
  function getAppUrl(){
    try{
      const u = new URL(window.location.href);
      const path = u.pathname;
      const base = path.endsWith("/") ? path : path.substring(0, path.lastIndexOf("/") + 1);
      u.pathname = base + "index.html";
      u.search = "";
      u.hash = "";
      return u.toString();
    }catch(e){
      return "./index.html";
    }
  }

  function toast(msg){
    elToast.textContent = msg;
    elToast.classList.add("on");
    clearTimeout(toast._t);
    toast._t = setTimeout(() => elToast.classList.remove("on"), 1100);
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      toast("Copied");
      return true;
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      try{
        document.execCommand("copy");
        toast("Copied");
        return true;
      }catch(_){
        toast("Copy failed");
        return false;
      }finally{
        ta.remove();
      }
    }
  }

  function openModal(){
    const url = getAppUrl();
    elShareUrlText.textContent = url;

    elQrBox.innerHTML = "";
    elQrBox.appendChild(makeQrSvg(url, 6)); // scale
    elModal.classList.add("on");
  }
  function closeModal(){
    elModal.classList.remove("on");
  }

  btnShare.addEventListener("click", openModal);
  btnShare2.addEventListener("click", openModal);
  btnShare3.addEventListener("click", openModal);
  btnCloseQr.addEventListener("click", closeModal);

  elModal.addEventListener("click", (e) => {
    if(e.target === elModal) closeModal();
  });

  btnCopyShare.addEventListener("click", () => copyText(getAppUrl()));
  btnCopyLink.addEventListener("click", () => copyText(getAppUrl()));
  btnCopyDonate.addEventListener("click", () => copyText(DONATE_URL));

  btnNativeShare.addEventListener("click", async () => {
    const url = getAppUrl();
    if(navigator.share){
      try{
        await navigator.share({ title: "StagePlot v2", text: "StagePlot link", url });
      }catch(e){
        // user canceled or not allowed
      }
    }else{
      copyText(url);
    }
  });

  // ---------------- QR implementation (compact) ----------------
  // This is a small QR encoder for Version 3..10 range auto.
  // It uses Byte mode for simplicity and error correction level M.
  // Plenty for URLs.
  function makeQrSvg(text, scale){
    const qr = QRCode.encode(text, "M"); // returns modules boolean matrix
    const n = qr.size;
    const quiet = 4;
    const dim = (n + quiet*2);

    const s = scale || 6;
    const w = dim * s;
    const h = dim * s;

    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    svg.setAttribute("viewBox", `0 0 ${dim} ${dim}`);
    svg.setAttribute("width", w);
    svg.setAttribute("height", h);
    svg.style.maxWidth = "100%";
    svg.style.height = "auto";

    const bg = document.createElementNS(svg.namespaceURI, "rect");
    bg.setAttribute("x","0"); bg.setAttribute("y","0");
    bg.setAttribute("width", dim); bg.setAttribute("height", dim);
    bg.setAttribute("fill", "#ffffff");
    svg.appendChild(bg);

    const g = document.createElementNS(svg.namespaceURI, "g");
    g.setAttribute("fill", "#000000");
    svg.appendChild(g);

    let d = "";
    for(let y=0;y<n;y++){
      for(let x=0;x<n;x++){
        if(qr.get(x,y)){
          const xx = x + quiet;
          const yy = y + quiet;
          d += `M${xx} ${yy}h1v1h-1z `;
        }
      }
    }
    const path = document.createElementNS(svg.namespaceURI, "path");
    path.setAttribute("d", d.trim());
    g.appendChild(path);

    return svg;
  }

  // Minimal QR encoder (Byte mode, EC level L/M/Q/H)
  const QRCode = (function(){
    const EXP = new Array(512);
    const LOG = new Array(256);
    (function initGF(){
      let x = 1;
      for(let i=0;i<255;i++){
        EXP[i] = x;
        LOG[x] = i;
        x <<= 1;
        if(x & 0x100) x ^= 0x11d;
      }
      for(let i=255;i<512;i++) EXP[i] = EXP[i-255];
    })();

    function gfMul(a,b){
      if(a===0 || b===0) return 0;
      return EXP[LOG[a] + LOG[b]];
    }

    function polyMul(p,q){
      const r = new Array(p.length + q.length - 1).fill(0);
      for(let i=0;i<p.length;i++){
        for(let j=0;j<q.length;j++){
          r[i+j] ^= gfMul(p[i], q[j]);
        }
      }
      return r;
    }

    function reedSolomonGen(deg){
      let g = [1];
      for(let i=0;i<deg;i++){
        g = polyMul(g, [1, EXP[i]]);
      }
      return g;
    }

    function reedSolomonRemainder(data, ecLen){
      const gen = reedSolomonGen(ecLen);
      const msg = data.slice();
      msg.push(...new Array(ecLen).fill(0));
      for(let i=0;i<data.length;i++){
        const coef = msg[i];
        if(coef !== 0){
          for(let j=0;j<gen.length;j++){
            msg[i+j] ^= gfMul(gen[j], coef);
          }
        }
      }
      return msg.slice(msg.length - ecLen);
    }

    const CAP_M_BYTE = [0,
      14,26,42,62,84,106,122,152,180,213
    ];

    const EC_M = [0,
      10,16,26,36,48,64,72,88,110,130
    ];

    const TOTAL_CODEWORDS = [0,
      26,44,70,100,134,172,196,242,292,346
    ];

    function chooseVersion(byteLen){
      for(let v=1; v<=10; v++){
        if(byteLen <= CAP_M_BYTE[v]) return v;
      }
      return 10;
    }

    function bitBufferPush(bits, val, len){
      for(let i=len-1;i>=0;i--){
        bits.push((val >>> i) & 1);
      }
    }

    function bitsToBytes(bits){
      const out = [];
      for(let i=0;i<bits.length;i+=8){
        let b=0;
        for(let j=0;j<8;j++){
          b = (b<<1) | (bits[i+j] || 0);
        }
        out.push(b);
      }
      return out;
    }

    function makeMatrix(n){
      const m = new Array(n);
      for(let y=0;y<n;y++){
        m[y] = new Array(n).fill(null);
      }
      return m;
    }

    function setFinder(m, x, y){
      const n = m.length;
      for(let dy=-1; dy<=7; dy++){
        for(let dx=-1; dx<=7; dx++){
          const xx = x+dx, yy = y+dy;
          if(xx<0||yy<0||xx>=n||yy>=n) continue;
          const on =
            (dx>=0&&dx<=6&&dy>=0&&dy<=6) &&
            (dx===0||dx===6||dy===0||dy===6|| (dx>=2&&dx<=4&&dy>=2&&dy<=4));
          m[yy][xx] = on ? 1 : 0;
        }
      }
    }

    function setTiming(m){
      const n = m.length;
      for(let i=8;i<n-8;i++){
        if(m[6][i]===null) m[6][i] = (i%2===0)?1:0;
        if(m[i][6]===null) m[i][6] = (i%2===0)?1:0;
      }
    }

    function setDarkModule(m, v){
      m[4*v + 9][8] = 1;
    }

    function placeData(m, dataBits){
      const n = m.length;
      let i = 0;
      let dirUp = true;
      for(let x=n-1; x>0; x-=2){
        if(x===6) x--;
        for(let y0=0; y0<n; y0++){
          const y = dirUp ? (n-1-y0) : y0;
          for(let dx=0; dx<2; dx++){
            const xx = x-dx;
            if(m[y][xx] !== null) continue;
            const bit = dataBits[i++] || 0;
            m[y][xx] = bit;
          }
        }
        dirUp = !dirUp;
      }
    }

    function formatBits(ecLevel, maskId){
      const ecBits = (ecLevel==="M") ? 0 : (ecLevel==="L") ? 1 : (ecLevel==="H") ? 2 : 3;
      let data = (ecBits << 3) | maskId;

      let d = data << 10;
      const poly = 0x537;
      for(let i=14;i>=10;i--){
        if((d >>> i) & 1) d ^= poly << (i-10);
      }
      const bits = ((data << 10) | d) ^ 0x5412;
      return bits & 0x7fff;
    }

    function applyFormat(m, ecLevel, maskId){
      const n = m.length;
      const bits = formatBits(ecLevel, maskId);

      function bit(i){ return (bits >>> i) & 1; }

      const coords1 = [
        [8,0],[8,1],[8,2],[8,3],[8,4],[8,5],[8,7],[8,8],
        [7,8],[5,8],[4,8],[3,8],[2,8],[1,8],[0,8]
      ];
      for(let i=0;i<15;i++){
        const [x,y] = coords1[i];
        m[y][x] = bit(14-i);
      }

      const coords2 = [];
      for(let i=0;i<8;i++) coords2.push([n-1-i,8]);
      for(let i=0;i<7;i++) coords2.push([8,n-7+i]);
      for(let i=0;i<15;i++){
        const [x,y] = coords2[i];
        m[y][x] = bit(14-i);
      }

      m[8][6] = 1;
    }

    function encode(text, ecLevel){
      ecLevel = ecLevel || "M";
      const bytes = new TextEncoder().encode(text);
      const v = chooseVersion(bytes.length);
      const n = 21 + (v-1)*4;

      const total = TOTAL_CODEWORDS[v];
      const ecLen = EC_M[v];
      const dataLen = total - ecLen;

      const bits = [];
      bitBufferPush(bits, 0b0100, 4);
      const lenBits = (v <= 9) ? 8 : 16;
      bitBufferPush(bits, bytes.length, lenBits);
      for(const b of bytes) bitBufferPush(bits, b, 8);

      const maxBits = dataLen * 8;
      const remaining = maxBits - bits.length;
      bitBufferPush(bits, 0, Math.min(4, Math.max(0, remaining)));
      while(bits.length % 8) bits.push(0);

      let data = bitsToBytes(bits);

      const PAD0 = 0xec, PAD1 = 0x11;
      let padToggle = false;
      while(data.length < dataLen){
        data.push(padToggle ? PAD1 : PAD0);
        padToggle = !padToggle;
      }

      const ec = reedSolomonRemainder(data, ecLen);
      const codewords = data.concat(ec);

      const cwBits = [];
      for(const cw of codewords){
        for(let i=7;i>=0;i--) cwBits.push((cw>>>i)&1);
      }

      const m = makeMatrix(n);
      setFinder(m, 0, 0);
      setFinder(m, n-7, 0);
      setFinder(m, 0, n-7);
      setTiming(m);

      for(let i=0;i<9;i++){
        if(m[8][i]===null) m[8][i] = 0;
        if(m[i][8]===null) m[i][8] = 0;
      }
      for(let i=n-8;i<n;i++){
        if(m[8][i]===null) m[8][i] = 0;
        if(m[i][8]===null) m[i][8] = 0;
      }
      for(let i=n-7;i<n;i++){
        if(m[i][8]===null) m[i][8] = 0;
      }

      setDarkModule(m, v);

      const locked = new Array(n).fill(0).map(()=>new Array(n).fill(false));
      for(let y=0;y<n;y++){
        for(let x=0;x<n;x++){
          if(m[y][x] !== null) locked[y][x] = true;
        }
      }

      placeData(m, cwBits);

      const maskId = 0;
      for(let y=0;y<n;y++){
        for(let x=0;x<n;x++){
          if(locked[y][x]) continue;
          if(((x + y) & 1) === 0){
            m[y][x] = m[y][x] ? 0 : 1;
          }
        }
      }

      applyFormat(m, ecLevel, maskId);

      return {
        size: n,
        get: (x,y) => !!m[y][x]
      };
    }

    return { encode };
  })();
})();
</script>
</body>
</html>

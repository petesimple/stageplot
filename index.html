<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0d12" />
  <title>StagePlot v2 - v1.5.7 (lucky)</title>

  <style>
    :root{
      --bg:#0b0d12;
      --panel:#121826;
      --panel2:#0f1420;
      --line:#26324a;
      --text:#e9eefb;
      --muted:#a9b4cc;
      --accent:#4aa3ff;
      --ok:#40d98a;
      --warn:#ffcc66;
      --danger:#ff5a6a;

      --chip: rgba(255,255,255,.06);
      --chipBorder: rgba(255,255,255,.12);
      --shadow: 0 12px 30px rgba(0,0,0,.35);

      --stageBorder: rgba(255,255,255,.14);
      --stageGrid: rgba(255,255,255,.06);

      --sqPad: 10px; /* inner padding for the stage square so 100% never clips */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 700px at 50% -10%, #1a2540, var(--bg));
      color: var(--text);
      line-height:1.4;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 20;
      border-bottom: 1px solid var(--line);
      background: rgba(10,12,18,.78);
      backdrop-filter: blur(10px);
    }
    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 14px;
    }
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .title{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 240px;
    }
    .logo{
      width:30px; height:30px;
      border-radius:10px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:center;
      color: var(--accent);
      font-weight: 900;
      user-select:none;
    }
    h1{
      font-size: 15px;
      margin:0;
      letter-spacing:.2px;
      line-height:1.2;
    }
    .sub{
      color: var(--muted);
      font-size: 12px;
      margin-top: 2px;
    }

    .actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background: var(--ok); display:inline-block; }

    a.button, button, .btn{
      font: inherit;
      color: var(--text);
      background: var(--chip);
      border: 1px solid var(--chipBorder);
      border-radius: 12px;
      padding: 8px 10px;
      text-decoration:none;
      cursor:pointer;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    a.button:hover, button:hover, .btn:hover{ border-color: rgba(74,163,255,.8); }
    a.button:active, button:active, .btn:active{ transform: translateY(1px); }
    .primary{
      background: rgba(74,163,255,.14);
      border-color: rgba(74,163,255,.55);
    }
    .danger{
      background: rgba(255,90,106,.10);
      border-color: rgba(255,90,106,.35);
    }

    main{
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 14px 26px 14px;
      display:grid;
      grid-template-columns: 320px 1fr 340px;
      gap: 12px;
      align-items:start;
    }

    .card{
      background: linear-gradient(180deg, rgba(18,24,38,.92), rgba(12,16,26,.92));
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      min-width: 0;
    }
    .card .hd{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .card .hd h2{
      margin:0;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .35px;
      font-weight: 800;
    }
    .card .bd{
      padding: 12px 12px 14px 12px;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row.tight{ gap:8px; }
    .row > *{ flex: 0 0 auto; }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      width:100%;
      margin-bottom:10px;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
    }
    input[type="text"], input[type="number"], select, textarea{
      width:100%;
      color: var(--text);
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 9px 10px;
      outline:none;
      font: inherit;
    }
    textarea{ min-height: 70px; resize: vertical; }

    .seg{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .seg .btn{
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
    }
    .seg .btn.on{
      background: rgba(74,163,255,.18);
      border-color: rgba(74,163,255,.6);
    }

    .miniHelp{
      font-size:12px;
      color: var(--muted);
    }

    /* Stage panel */
    .stageWrap{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .stageSquare{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius: 18px;
      border: 1px solid var(--line);
      background:
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
      position: relative;
      overflow: hidden;
    }

    .stageSquareInner{
      position:absolute;
      inset: var(--sqPad);
      border-radius: 14px;
      overflow:hidden;
      background:
        radial-gradient(circle at 30% 20%, rgba(74,163,255,.08), transparent 40%),
        radial-gradient(circle at 70% 70%, rgba(64,217,138,.06), transparent 45%),
        rgba(0,0,0,.08);
      border: 1px solid rgba(255,255,255,.10);
    }

    .stageCanvas{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      transform-origin: center center;
      will-change: transform, width, height;
    }

    .stageRect{
      position:absolute;
      inset:0;
      border: 2px solid var(--stageBorder);
      border-radius: 10px;
      background:
        linear-gradient(to right, var(--stageGrid) 1px, transparent 1px),
        linear-gradient(to bottom, var(--stageGrid) 1px, transparent 1px);
      background-size: 10% 10%;
    }

    .upLabel{
      position:absolute;
      left:10px;
      top:10px;
      font-size:12px;
      color: rgba(233,238,251,.9);
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.12);
      padding: 4px 8px;
      border-radius: 999px;
      user-select:none;
    }
    .downLabel{
      position:absolute;
      right:10px;
      bottom:10px;
      font-size:12px;
      color: rgba(233,238,251,.85);
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      padding: 4px 8px;
      border-radius: 999px;
      user-select:none;
    }

    /* Items */
    .item{
      position:absolute;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      box-shadow: 0 8px 18px rgba(0,0,0,.28);
      user-select:none;
      touch-action:none;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 6px;
    }
    .item[data-kind="person"]{ background: rgba(74,163,255,.10); border-color: rgba(74,163,255,.35); }
    .item[data-kind="instr"]{ background: rgba(255,204,102,.08); border-color: rgba(255,204,102,.28); }
    .item[data-kind="gear"]{ background: rgba(255,255,255,.06); }
    .item[data-kind="power"]{ background: rgba(255,90,106,.08); border-color: rgba(255,90,106,.28); }

    .item .lbl{
      font-size: 12px;
      font-weight: 800;
      text-align:center;
      line-height:1.1;
      color: rgba(233,238,251,.95);
      text-shadow: 0 1px 0 rgba(0,0,0,.5);
      pointer-events:none;
      padding: 0 4px;
      word-break: break-word;
    }
    .item.selected{
      outline: 2px solid rgba(74,163,255,.85);
      outline-offset: 2px;
    }
    .item.multi{
      outline: 2px solid rgba(64,217,138,.75);
      outline-offset: 2px;
    }

    /* Library list */
    .libTop{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .libGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .libBtn{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-start;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
      transition: border-color .15s ease, background .15s ease, transform .05s ease;
      min-height: 46px;
    }
    .libBtn:hover{ border-color: rgba(74,163,255,.55); background: rgba(74,163,255,.06); }
    .libBtn:active{ transform: translateY(1px); }
    .libBtn .ic{
      width:26px; height:26px;
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-weight: 900;
      color: var(--accent);
      flex: 0 0 auto;
    }
    .libBtn .nm{
      font-size: 12px;
      font-weight: 800;
      line-height:1.1;
    }
    .libBtn .sm{
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }
    .libBtn .txt{ display:flex; flex-direction:column; }

    /* Lists (inputs/mixes) */
    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      margin-top: 8px;
    }
    .table th, .table td{
      text-align:left;
      padding: 8px 9px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-size: 12px;
      vertical-align: top;
    }
    .table th{
      color: var(--muted);
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing:.3px;
      font-size: 11px;
      background: rgba(255,255,255,.03);
    }
    .table tr:last-child td{ border-bottom:none; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

    .hr{
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 10px 0;
    }

    /* Tools under stage */
    .toolsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:start;
    }
    @media (max-width: 980px){
      .toolsGrid{ grid-template-columns: 1fr; }
    }

    /* Mobile accordion behavior */
    .accBtn{
      display:none;
      width:100%;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      margin-bottom: 10px;
      font-weight: 850;
    }
    .chev{ opacity:.85; }
    .accHidden{ display:none !important; }

    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
      .accBtn{ display:flex; }
      #libCard, #infoCard{ order: 2; }
      #stageCard{ order: 1; }
      #infoCard{ order: 3; }
    }

    /* Print */
    @media print{
      header{ display:none !important; }
      body{ background:#fff !important; color:#000 !important; }
      main{ display:block !important; max-width: 7.8in !important; padding: 0 !important; }
      .card{ box-shadow:none !important; background:#fff !important; border: 1px solid #ddd !important; margin-bottom: 10px !important; }
      .card .hd{ border-bottom:1px solid #ddd !important; }
      .pill, .actions, .accBtn, #libCard { display:none !important; }
      #stageCard .bd{ padding: 10px !important; }
      .stageSquare{ border: 1px solid #ddd !important; }
      .stageSquareInner{ inset: 8px !important; border: 1px solid #ddd !important; }
      .stageRect{ border-color:#111 !important; }
      .item{ box-shadow:none !important; border-color:#111 !important; background:#fff !important; }
      .item .lbl{ color:#000 !important; text-shadow:none !important; }
      a{ color:#000 !important; text-decoration:none !important; }
      /* keep tools visible in print? hide them so one-page is clean */
      .toolsUnderStage{ display:none !important; }
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <div class="logo" aria-hidden="true">SP</div>
        <div>
          <h1>StagePlot v2</h1>
          <div class="sub">v1.5.7 (lucky) - metric + import-safe + accordions + item scaling + tools under stage</div>
        </div>
      </div>

      <div class="actions">
        <span class="pill"><span class="dot"></span>Autosave friendly</span>
        <a class="button" href="./guide.html">Guide</a>
        <button class="button primary" id="btnPrint">Print</button>
        <button class="button" id="btnExport">Export Project JSON</button>
        <button class="button" id="btnImport">Import Project JSON</button>
      </div>
    </div>
  </div>
</header>

<main>
  <!-- LIBRARY -->
  <section class="card" id="libCard">
    <div class="hd">
      <h2>Item Library</h2>
      <span class="pill" id="libCount">0 items</span>
    </div>
    <div class="bd" id="libBody">
      <button class="accBtn" id="accLibBtn">
        <span>Library</span><span class="chev" id="accLibChev">â–¾</span>
      </button>

      <div id="libAccContent">
        <div class="libTop">
          <input id="libSearch" type="text" placeholder="Search (guitar, vox, wedge, power...)" />
          <select id="libFilter" style="max-width: 160px;">
            <option value="all">All</option>
            <option value="person">People</option>
            <option value="instr">Instruments</option>
            <option value="gear">Stage gear</option>
            <option value="power">Power</option>
          </select>
        </div>

        <div class="libGrid" id="libGrid"></div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn" id="btnMisc1">+ Misc 1</button>
          <button class="btn" id="btnMisc2">+ Misc 2</button>
          <button class="btn" id="btnMisc3">+ Misc 3</button>
          <button class="btn danger" id="btnDeleteSel">Delete Selected</button>
        </div>

        <div style="margin-top:10px" class="miniHelp">
          Tips: click to select - shift/cmd/ctrl click for multi select - drag to move.
        </div>
      </div>
    </div>
  </section>

  <!-- STAGE -->
  <section class="card" id="stageCard">
    <div class="hd">
      <h2>Stage</h2>
      <div class="row tight">
        <span class="pill" id="unitsPill">Units: ft</span>
        <button class="btn" id="btnUnits">Toggle ft/m</button>
        <button class="btn" id="btnFlip">Stage View</button>
        <button class="btn" id="btnClearSel">Clear</button>
      </div>
    </div>
    <div class="bd">
      <div class="stageWrap">
        <!-- Layout ALWAYS at the top -->
        <div class="card" style="box-shadow:none;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.02);">
          <div class="bd" style="padding:12px;">
            <div class="row tight" style="justify-content:space-between;">
              <div style="flex:1; min-width: 210px;">
                <div class="field" style="margin:0;">
                  <label>Stage preset</label>
                  <div class="seg">
                    <button class="btn" data-preset="small">Small</button>
                    <button class="btn" data-preset="med">Medium</button>
                    <button class="btn" data-preset="large">Large</button>
                    <button class="btn" data-preset="custom">Custom</button>
                  </div>
                </div>
              </div>

              <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
                <div class="field" style="width: 140px; margin:0;">
                  <label>Width (<span id="unitLabelW">ft</span>)</label>
                  <input type="number" min="1" step="0.1" id="stageW" />
                </div>
                <div class="field" style="width: 140px; margin:0;">
                  <label>Depth (<span id="unitLabelD">ft</span>)</label>
                  <input type="number" min="1" step="0.1" id="stageD" />
                </div>
              </div>
            </div>

            <div class="miniHelp" style="margin-top:10px;">
              The stage always fits in the square at 100% - View Zoom can intentionally zoom in for detail.
            </div>
          </div>
        </div>

        <!-- Stage square -->
        <div class="stageSquare" id="stageSquare">
          <div class="stageSquareInner" id="stageSquareInner">
            <div class="stageCanvas" id="stageCanvas">
              <div class="stageRect" id="stageRect"></div>
              <div class="upLabel" id="upLabel">UPSTAGE</div>
              <div class="downLabel" id="downLabel">AUDIENCE</div>
              <!-- items injected here -->
            </div>
          </div>
        </div>

        <!-- Tools UNDER the stage (requested) -->
        <div class="card toolsUnderStage" style="box-shadow:none;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.02);">
          <div class="bd" style="padding:12px;">
            <div class="toolsGrid">
              <div>
                <div class="field" style="margin:0;">
                  <label>View Zoom (inside square)</label>
                  <input type="range" min="50" max="200" value="100" id="viewZoom" />
                  <div class="row tight" style="justify-content:space-between;">
                    <span class="miniHelp">50%</span>
                    <span class="pill" id="viewZoomPill">100%</span>
                    <span class="miniHelp">200%</span>
                  </div>
                </div>
                <div class="row tight" style="margin-top:8px;">
                  <button class="btn" id="btnResetView">Reset View (100%)</button>
                </div>
              </div>

              <div>
                <div class="pill" style="display:flex; justify-content:space-between; width:100%; margin-bottom:10px;">
                  <span>Selected item tools</span>
                  <span class="mono" id="stageSelLabel">none</span>
                </div>

                <div class="field" style="margin:0 0 10px 0;">
                  <label>Item Scale (footprint)</label>
                  <input type="range" min="50" max="200" value="100" id="itemScaleStage" />
                  <div class="row tight" style="justify-content:space-between;">
                    <span class="miniHelp">50%</span>
                    <span class="pill" id="itemScaleStagePill">100%</span>
                    <span class="miniHelp">200%</span>
                  </div>
                </div>

                <div class="field" style="margin:0;">
                  <label>Rotation</label>
                  <input type="range" min="0" max="359" value="0" id="itemRotStage" />
                  <div class="row tight" style="justify-content:space-between;">
                    <span class="miniHelp">0Â°</span>
                    <span class="pill" id="itemRotStagePill">0Â°</span>
                    <button class="btn" id="btnRot0Stage" type="button">Reset</button>
                  </div>
                </div>

                <div class="miniHelp" style="margin-top:8px;">
                  Tip: these mirror the Info panel controls.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="miniHelp" id="stageMeta">
          Stage: <span class="mono" id="stageMetaText">24 x 16 ft</span>
        </div>
      </div>
    </div>
  </section>

  <!-- INFO -->
  <section class="card" id="infoCard">
    <div class="hd">
      <h2>One-Page Info</h2>
      <button class="btn" id="btnDup">Duplicate</button>
    </div>
    <div class="bd" id="infoBody">
      <button class="accBtn" id="accInfoBtn">
        <span>Info + Lists</span><span class="chev" id="accInfoChev">â–¾</span>
      </button>

      <div id="infoAccContent">
        <div class="field">
          <label>Band / Show name (prints at top)</label>
          <input type="text" id="bandName" placeholder="Example: Petesimple Trio - Oasis Patio" />
        </div>

        <div class="field">
          <label>Show notes (load-in, contact, backline, set length, etc.)</label>
          <textarea id="showNotes" placeholder="Example: Arrival 6:00 - downbeat 7:00 - FOH: Thomas - 2 wedges + 1 DI..."></textarea>
        </div>

        <div class="hr"></div>

        <div class="pill" style="display:flex; justify-content:space-between;">
          <span>Selected item</span>
          <span class="mono" id="selLabel">none</span>
        </div>

        <div class="field" style="margin-top:10px;">
          <label>Label</label>
          <input type="text" id="itemLabel" placeholder="Example: Pete Vox" />
        </div>

        <div class="row">
          <div class="field" style="width: 48%; min-width:140px;">
            <label>Input</label>
            <input type="text" id="itemInput" placeholder="Ch 1 / DI / Multi" />
          </div>
          <div class="field" style="width: 48%; min-width:140px;">
            <label>Mix</label>
            <input type="text" id="itemMix" placeholder="M1 / IEM / Wedge" />
          </div>
        </div>

        <div class="field">
          <label>Item notes</label>
          <textarea id="itemNotes" placeholder="Example: needs boom - DI after pedals - phantom ok"></textarea>
        </div>

        <div class="row">
          <div class="field" style="width: 48%; min-width:140px;">
            <label>Item Scale (footprint)</label>
            <input type="range" min="50" max="200" value="100" id="itemScale" />
            <div class="row tight" style="justify-content:space-between;">
              <span class="miniHelp">50%</span>
              <span class="pill" id="itemScalePill">100%</span>
              <span class="miniHelp">200%</span>
            </div>
          </div>

          <div class="field" style="width: 48%; min-width:140px;">
            <label>Rotation</label>
            <input type="range" min="0" max="359" value="0" id="itemRot" />
            <div class="row tight" style="justify-content:space-between;">
              <span class="miniHelp">0Â°</span>
              <span class="pill" id="itemRotPill">0Â°</span>
              <button class="btn" id="btnRot0" type="button">Reset</button>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="pill" style="display:flex; justify-content:space-between;">
          <span>Auto lists</span>
          <span class="miniHelp">from items</span>
        </div>

        <div class="field" style="margin-top:10px;">
          <label>Inputs</label>
          <table class="table" id="inputsTable"></table>
        </div>

        <div class="field">
          <label>Monitor mixes</label>
          <table class="table" id="mixesTable"></table>
        </div>

        <div class="miniHelp">
          Note: Scale changes item footprint. View Zoom changes your view inside the square.
        </div>
      </div>
    </div>
  </section>
</main>

<input type="file" id="fileImport" accept="application/json" style="display:none;" />

<script>
(() => {
  const APP_VERSION = "1.5.7 (lucky)";
  const FT_PER_M = 3.280839895;

  const els = {
    libGrid: document.getElementById("libGrid"),
    libSearch: document.getElementById("libSearch"),
    libFilter: document.getElementById("libFilter"),
    libCount: document.getElementById("libCount"),

    stageSquare: document.getElementById("stageSquare"),
    stageSquareInner: document.getElementById("stageSquareInner"),
    stageCanvas: document.getElementById("stageCanvas"),
    stageRect: document.getElementById("stageRect"),
    upLabel: document.getElementById("upLabel"),
    downLabel: document.getElementById("downLabel"),
    stageW: document.getElementById("stageW"),
    stageD: document.getElementById("stageD"),
    stageMetaText: document.getElementById("stageMetaText"),

    bandName: document.getElementById("bandName"),
    showNotes: document.getElementById("showNotes"),

    selLabel: document.getElementById("selLabel"),
    stageSelLabel: document.getElementById("stageSelLabel"),

    itemLabel: document.getElementById("itemLabel"),
    itemInput: document.getElementById("itemInput"),
    itemMix: document.getElementById("itemMix"),
    itemNotes: document.getElementById("itemNotes"),
    itemScale: document.getElementById("itemScale"),
    itemScalePill: document.getElementById("itemScalePill"),
    itemRot: document.getElementById("itemRot"),
    itemRotPill: document.getElementById("itemRotPill"),

    // stage-under tools (mirror)
    itemScaleStage: document.getElementById("itemScaleStage"),
    itemScaleStagePill: document.getElementById("itemScaleStagePill"),
    itemRotStage: document.getElementById("itemRotStage"),
    itemRotStagePill: document.getElementById("itemRotStagePill"),
    btnRot0Stage: document.getElementById("btnRot0Stage"),

    inputsTable: document.getElementById("inputsTable"),
    mixesTable: document.getElementById("mixesTable"),

    btnPrint: document.getElementById("btnPrint"),
    btnExport: document.getElementById("btnExport"),
    btnImport: document.getElementById("btnImport"),
    fileImport: document.getElementById("fileImport"),

    btnMisc1: document.getElementById("btnMisc1"),
    btnMisc2: document.getElementById("btnMisc2"),
    btnMisc3: document.getElementById("btnMisc3"),
    btnDeleteSel: document.getElementById("btnDeleteSel"),
    btnClearSel: document.getElementById("btnClearSel"),
    btnDup: document.getElementById("btnDup"),

    btnFlip: document.getElementById("btnFlip"),

    btnUnits: document.getElementById("btnUnits"),
    unitsPill: document.getElementById("unitsPill"),
    unitLabelW: document.getElementById("unitLabelW"),
    unitLabelD: document.getElementById("unitLabelD"),

    viewZoom: document.getElementById("viewZoom"),
    viewZoomPill: document.getElementById("viewZoomPill"),
    btnResetView: document.getElementById("btnResetView"),

    btnRot0: document.getElementById("btnRot0"),

    accLibBtn: document.getElementById("accLibBtn"),
    accInfoBtn: document.getElementById("accInfoBtn"),
    accLibChev: document.getElementById("accLibChev"),
    accInfoChev: document.getElementById("accInfoChev"),
    libAccContent: document.getElementById("libAccContent"),
    infoAccContent: document.getElementById("infoAccContent"),
  };

  const LIB = [
    { id:"vox", name:"Vocal", sub:"Person", kind:"person", w:2.0, h:2.0, ic:"ðŸŽ¤", label:"Vox" },
    { id:"gtr", name:"Guitar", sub:"Instrument", kind:"instr", w:2.2, h:1.8, ic:"ðŸŽ¸", label:"Gtr" },
    { id:"bass", name:"Bass", sub:"Instrument", kind:"instr", w:2.2, h:1.8, ic:"ðŸ…±ï¸", label:"Bass" },
    { id:"keys", name:"Keys", sub:"Instrument", kind:"instr", w:3.0, h:2.0, ic:"ðŸŽ¹", label:"Keys" },
    { id:"drums", name:"Drums", sub:"Instrument", kind:"instr", w:4.5, h:3.2, ic:"ðŸ¥", label:"Drums" },

    { id:"wedge", name:"Wedge", sub:"Gear", kind:"gear", w:1.6, h:1.2, ic:"ðŸ”Š", label:"Wedge" },
    { id:"amp", name:"Amp", sub:"Gear", kind:"gear", w:1.8, h:1.4, ic:"ðŸ”ˆ", label:"Amp" },
    { id:"mic", name:"Mic Stand", sub:"Gear", kind:"gear", w:1.0, h:1.0, ic:"ðŸŽ™ï¸", label:"Mic" },
    { id:"di", name:"DI Box", sub:"Gear", kind:"gear", w:1.0, h:0.8, ic:"â¬›", label:"DI" },
    { id:"riser", name:"Riser", sub:"Gear", kind:"gear", w:4.0, h:2.0, ic:"â¬œ", label:"Riser" },

    { id:"power", name:"Power", sub:"Electrical", kind:"power", w:1.3, h:1.0, ic:"âš¡", label:"PWR" },
  ];

  const LS_KEY = "stageplot_v2_state";
  const LS_UI  = "stageplot_v2_ui";

  let state = {
    version: APP_VERSION,
    units: "ft",
    stage: { w: 24, d: 16 }, // feet
    view: { flip:false },
    viewZoom: 1.0,
    bandName: "",
    showNotes: "",
    items: [],
    selectedIds: [],
    primaryId: null
  };

  const uid = () => Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

  function feetToDisplay(ft){
    if(state.units === "m") return ft / FT_PER_M;
    return ft;
  }
  function displayToFeet(v){
    const n = Number(v);
    if(!isFinite(n)) return 0;
    if(state.units === "m") return n * FT_PER_M;
    return n;
  }

  function save(){
    const toSave = {
      version: state.version,
      units: state.units,
      stage: state.stage,
      view: state.view,
      viewZoom: state.viewZoom,
      bandName: state.bandName,
      showNotes: state.showNotes,
      items: state.items
    };
    localStorage.setItem(LS_KEY, JSON.stringify(toSave));
  }

  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      const obj = JSON.parse(raw);
      state = migrateProject(obj);
    }catch(e){}
  }

  function migrateProject(obj){
    const migrated = {
      version: APP_VERSION,
      units: (obj && obj.units === "m") ? "m" : "ft",
      stage: { w: 24, d: 16 },
      view: { flip:false },
      viewZoom: 1.0,
      bandName: "",
      showNotes: "",
      items: [],
      selectedIds: [],
      primaryId: null
    };

    if(obj){
      if(obj.stage && typeof obj.stage.w === "number" && typeof obj.stage.d === "number"){
        migrated.stage.w = obj.stage.w;
        migrated.stage.d = obj.stage.d;
      }else{
        if(typeof obj.stageWidth === "number") migrated.stage.w = obj.stageWidth;
        if(typeof obj.stageDepth === "number") migrated.stage.d = obj.stageDepth;
      }

      if(obj.units === "m"){
        migrated.stage.w *= FT_PER_M;
        migrated.stage.d *= FT_PER_M;
      }

      if(obj.view && typeof obj.view.flip === "boolean") migrated.view.flip = obj.view.flip;

      if(typeof obj.viewZoom === "number"){
        migrated.viewZoom = obj.viewZoom;
      }else if(typeof obj.viewZoomPct === "number"){
        migrated.viewZoom = clamp(obj.viewZoomPct/100, 0.5, 2.0);
      }

      if(typeof obj.bandName === "string") migrated.bandName = obj.bandName;
      if(typeof obj.showNotes === "string") migrated.showNotes = obj.showNotes;

      if(Array.isArray(obj.items)){
        migrated.items = obj.items.map(it => {
          const out = {
            id: (it && it.id) ? it.id : uid(),
            type: it.type || it.kind || "misc",
            kind: it.kind || inferKind(it.type),
            label: it.label || it.name || "Item",
            x: Number(it.x)||0,
            y: Number(it.y)||0,
            w: Number(it.w)||2,
            h: Number(it.h)||2,
            rot: Number(it.rot)||0,
            scale: (it.scale==null ? 1.0 : Number(it.scale)) || 1.0,
            color: it.color || "",
            input: it.input || "",
            mix: it.mix || "",
            notes: it.notes || ""
          };

          if(obj.units === "m"){
            out.x *= FT_PER_M; out.y *= FT_PER_M;
            out.w *= FT_PER_M; out.h *= FT_PER_M;
          }

          out.scale = clamp(out.scale, 0.5, 2.0);
          out.rot = ((out.rot % 360) + 360) % 360;

          return out;
        });
      }
    }

    migrated.stage.w = clamp(migrated.stage.w, 4, 200);
    migrated.stage.d = clamp(migrated.stage.d, 4, 200);

    migrated.items.forEach(it => {
      it.x = clamp(it.x, 0, Math.max(0, migrated.stage.w - 0.25));
      it.y = clamp(it.y, 0, Math.max(0, migrated.stage.d - 0.25));
    });

    return migrated;
  }

  function inferKind(type){
    if(!type) return "gear";
    const t = String(type).toLowerCase();
    if(t.includes("vox") || t.includes("person")) return "person";
    if(t.includes("gtr") || t.includes("bass") || t.includes("keys") || t.includes("drum")) return "instr";
    if(t.includes("power")) return "power";
    return "gear";
  }

  function getSquareInnerSizePx(){
    const r = els.stageSquareInner.getBoundingClientRect();
    return { w: r.width, h: r.height };
  }

  function computeStagePixels(){
    const inner = getSquareInnerSizePx();
    const maxSize = Math.min(inner.w, inner.h);
    const safety = 2;
    const avail = Math.max(20, maxSize - safety);

    const pxPerFoot = Math.min(avail / state.stage.w, avail / state.stage.d);
    const stagePxW = state.stage.w * pxPerFoot;
    const stagePxH = state.stage.d * pxPerFoot;

    return { pxPerFoot, stagePxW, stagePxH };
  }

  function stagePointFromPointer(e){
    const canvasRect = els.stageCanvas.getBoundingClientRect();
    const px = e.clientX - canvasRect.left;
    const py = e.clientY - canvasRect.top;
    const { pxPerFoot } = computeStagePixels();

    const z = state.viewZoom;
    const basePx = px / z;
    const basePy = py / z;

    let fx = basePx / pxPerFoot;
    let fy = basePy / pxPerFoot;

    if(state.view.flip){
      fx = state.stage.w - fx;
      fy = state.stage.d - fy;
    }
    return { x: fx, y: fy };
  }

  function itemDrawPos(it){
    const w = it.w * it.scale;
    const h = it.h * it.scale;

    if(!state.view.flip){
      return { x: it.x, y: it.y, rot: it.rot, w, h };
    }
    const x = state.stage.w - (it.x + w);
    const y = state.stage.d - (it.y + h);
    const rot = (it.rot + 180) % 360;
    return { x, y, rot, w, h };
  }

  function updateUnitsUI(){
    els.unitsPill.textContent = "Units: " + state.units;
    els.unitLabelW.textContent = state.units;
    els.unitLabelD.textContent = state.units;

    els.stageW.value = (Math.round(feetToDisplay(state.stage.w)*100)/100);
    els.stageD.value = (Math.round(feetToDisplay(state.stage.d)*100)/100);

    els.stageMetaText.textContent = `${(Math.round(feetToDisplay(state.stage.w)*100)/100)} x ${(Math.round(feetToDisplay(state.stage.d)*100)/100)} ${state.units}`;
  }

  function updateViewUI(){
    els.viewZoom.value = Math.round(state.viewZoom * 100);
    els.viewZoomPill.textContent = Math.round(state.viewZoom*100) + "%";
    els.btnFlip.textContent = state.view.flip ? "Audience View" : "Stage View";
    els.upLabel.textContent = state.view.flip ? "AUDIENCE" : "UPSTAGE";
    els.downLabel.textContent = state.view.flip ? "UPSTAGE" : "AUDIENCE";
  }

  function getPrimary(){
    if(state.primaryId){
      return state.items.find(x => x.id === state.primaryId) || null;
    }
    if(state.selectedIds.length){
      const id = state.selectedIds[0];
      return state.items.find(x => x.id === id) || null;
    }
    return null;
  }

  function updateSelectionUI(){
    const primary = getPrimary();
    const label = primary ? primary.label : "none";
    els.selLabel.textContent = label;
    els.stageSelLabel.textContent = label;

    const disabled = !primary;
    [
      els.itemLabel, els.itemInput, els.itemMix, els.itemNotes,
      els.itemScale, els.itemRot, els.btnRot0, els.btnDup,
      els.itemScaleStage, els.itemRotStage, els.btnRot0Stage
    ].forEach(el => el.disabled = disabled);

    if(!primary){
      els.itemLabel.value = "";
      els.itemInput.value = "";
      els.itemMix.value = "";
      els.itemNotes.value = "";

      els.itemScale.value = 100;
      els.itemScalePill.textContent = "100%";
      els.itemRot.value = 0;
      els.itemRotPill.textContent = "0Â°";

      els.itemScaleStage.value = 100;
      els.itemScaleStagePill.textContent = "100%";
      els.itemRotStage.value = 0;
      els.itemRotStagePill.textContent = "0Â°";
      return;
    }

    els.itemLabel.value = primary.label || "";
    els.itemInput.value = primary.input || "";
    els.itemMix.value = primary.mix || "";
    els.itemNotes.value = primary.notes || "";

    const sPct = Math.round((primary.scale || 1)*100);
    const rDeg = Math.round(primary.rot || 0);

    els.itemScale.value = sPct;
    els.itemScalePill.textContent = sPct + "%";
    els.itemRot.value = rDeg;
    els.itemRotPill.textContent = rDeg + "Â°";

    els.itemScaleStage.value = sPct;
    els.itemScaleStagePill.textContent = sPct + "%";
    els.itemRotStage.value = rDeg;
    els.itemRotStagePill.textContent = rDeg + "Â°";
  }

  function setSelection(ids, primaryId=null){
    state.selectedIds = Array.from(new Set(ids));
    state.primaryId = primaryId || (state.selectedIds[0] || null);
    updateSelectionUI();
    render();
    save();
  }

  function clearSelection(){
    state.selectedIds = [];
    state.primaryId = null;
    updateSelectionUI();
    render();
    save();
  }

  function renderLibrary(){
    const q = (els.libSearch.value || "").trim().toLowerCase();
    const f = els.libFilter.value || "all";

    const filtered = LIB.filter(x => {
      if(f !== "all" && x.kind !== f) return false;
      if(!q) return true;
      const hay = (x.name + " " + x.sub + " " + x.label + " " + x.id).toLowerCase();
      return hay.includes(q);
    });

    els.libGrid.innerHTML = "";
    filtered.forEach(x => {
      const btn = document.createElement("div");
      btn.className = "libBtn";
      btn.innerHTML = `
        <div class="ic" aria-hidden="true">${x.ic}</div>
        <div class="txt">
          <div class="nm">${x.name}</div>
          <div class="sm">${x.sub}</div>
        </div>
      `;
      btn.addEventListener("click", () => addFromLib(x));
      els.libGrid.appendChild(btn);
    });

    els.libCount.textContent = `${state.items.length} items`;
  }

  function render(){
    const { pxPerFoot, stagePxW, stagePxH } = computeStagePixels();

    els.stageCanvas.style.width = stagePxW + "px";
    els.stageCanvas.style.height = stagePxH + "px";
    els.stageCanvas.style.transform = `translate(-50%,-50%) scale(${state.viewZoom})`;

    Array.from(els.stageCanvas.querySelectorAll(".item")).forEach(n => n.remove());

    for(const it of state.items){
      const d = itemDrawPos(it);
      const el = document.createElement("div");
      el.className = "item";
      el.dataset.id = it.id;
      el.dataset.kind = it.kind || inferKind(it.type);

      const isSel = state.selectedIds.includes(it.id);
      if(isSel) el.classList.add("multi");
      if(state.primaryId === it.id) el.classList.add("selected");

      if(it.color){
        el.style.background = `color-mix(in srgb, ${it.color} 18%, rgba(255,255,255,.06))`;
        el.style.borderColor = `color-mix(in srgb, ${it.color} 42%, rgba(255,255,255,.14))`;
      }

      el.style.left = (d.x * pxPerFoot) + "px";
      el.style.top  = (d.y * pxPerFoot) + "px";
      el.style.width  = (d.w * pxPerFoot) + "px";
      el.style.height = (d.h * pxPerFoot) + "px";
      el.style.transform = `rotate(${d.rot}deg)`;

      const lbl = document.createElement("div");
      lbl.className = "lbl";
      lbl.textContent = it.label || "Item";
      el.appendChild(lbl);

      el.addEventListener("pointerdown", onItemPointerDown);

      el.addEventListener("click", (ev) => {
        ev.stopPropagation();
        const mod = ev.shiftKey || ev.metaKey || ev.ctrlKey;
        if(!mod){
          setSelection([it.id], it.id);
          openInfoAccordionIfMobile();
          return;
        }
        const set = new Set(state.selectedIds);
        if(set.has(it.id)) set.delete(it.id); else set.add(it.id);
        const arr = Array.from(set);
        setSelection(arr, state.primaryId && set.has(state.primaryId) ? state.primaryId : (arr[0] || null));
        openInfoAccordionIfMobile();
      });

      els.stageCanvas.appendChild(el);
    }

    renderTables();
    els.stageMetaText.textContent = `${(Math.round(feetToDisplay(state.stage.w)*100)/100)} x ${(Math.round(feetToDisplay(state.stage.d)*100)/100)} ${state.units}`;
  }

  function renderTables(){
    const rows = state.items
      .filter(it => (it.input || "").trim() || (it.label || "").trim())
      .map(it => ({ input: (it.input||"").trim(), label: (it.label||"").trim(), notes:(it.notes||"").trim() }))
      .sort((a,b) => (a.input||"").localeCompare(b.input||"", undefined, { numeric:true, sensitivity:"base" }));

    els.inputsTable.innerHTML = `
      <thead><tr><th style="width:28%;">Input</th><th>Source</th></tr></thead>
      <tbody></tbody>
    `;
    const tb = els.inputsTable.querySelector("tbody");
    if(!rows.length){
      tb.innerHTML = `<tr><td colspan="2" style="color: rgba(169,180,204,.95);">No inputs yet - add items and fill in Input.</td></tr>`;
    }else{
      rows.forEach(r => {
        tb.insertAdjacentHTML("beforeend", `
          <tr>
            <td class="mono">${escapeHtml(r.input || "-")}</td>
            <td>${escapeHtml(r.label || "-")}${r.notes ? `<div style="color:rgba(169,180,204,.95); font-size:11px; margin-top:2px;">${escapeHtml(r.notes)}</div>`:""}</td>
          </tr>
        `);
      });
    }

    const mixMap = new Map();
    state.items.forEach(it => {
      const m = (it.mix||"").trim();
      if(!m) return;
      if(!mixMap.has(m)) mixMap.set(m, []);
      mixMap.get(m).push(it);
    });
    const mixes = Array.from(mixMap.entries()).sort((a,b) => a[0].localeCompare(b[0], undefined, { numeric:true, sensitivity:"base" }));

    els.mixesTable.innerHTML = `
      <thead><tr><th style="width:20%;">Mix</th><th>Members</th></tr></thead>
      <tbody></tbody>
    `;
    const mb = els.mixesTable.querySelector("tbody");
    if(!mixes.length){
      mb.innerHTML = `<tr><td colspan="2" style="color: rgba(169,180,204,.95);">No mixes yet - fill in Mix on items (M1, IEM, Wedge...).</td></tr>`;
    }else{
      mixes.forEach(([mix, items]) => {
        const members = items.map(it => escapeHtml(it.label || "Item")).join(", ");
        mb.insertAdjacentHTML("beforeend", `
          <tr>
            <td class="mono">${escapeHtml(mix)}</td>
            <td>${members}</td>
          </tr>
        `);
      });
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  function addFromLib(def){
    const it = {
      id: uid(),
      type: def.id,
      kind: def.kind,
      label: def.label || def.name,
      x: (state.stage.w/2) - (def.w/2),
      y: (state.stage.d/2) - (def.h/2),
      w: def.w,
      h: def.h,
      rot: 0,
      scale: 1.0,
      color: "",
      input: "",
      mix: "",
      notes: ""
    };
    it.x = clamp(it.x, 0, Math.max(0, state.stage.w - it.w));
    it.y = clamp(it.y, 0, Math.max(0, state.stage.d - it.h));

    state.items.push(it);
    setSelection([it.id], it.id);
    renderLibrary();
    render();
    save();
    openInfoAccordionIfMobile();
  }

  function addMisc(size){
    const base = (size===1) ? { w:2.0, h:1.4 } : (size===2) ? { w:3.0, h:2.0 } : { w:4.0, h:2.8 };
    addFromLib({ id:`misc${size}`, name:"Misc", sub:"Gear", kind:"gear", w:base.w, h:base.h, ic:"â¬›", label:`Misc` });
  }

  function deleteSelected(){
    if(!state.selectedIds.length) return;
    const set = new Set(state.selectedIds);
    state.items = state.items.filter(it => !set.has(it.id));
    clearSelection();
    renderLibrary();
    render();
    save();
  }

  function duplicateSelected(){
    if(!state.selectedIds.length) return;
    const newIds = [];
    const sel = state.items.filter(it => state.selectedIds.includes(it.id));
    sel.forEach(it => {
      const copy = JSON.parse(JSON.stringify(it));
      copy.id = uid();
      copy.x = clamp(copy.x + 0.5, 0, Math.max(0, state.stage.w - copy.w*copy.scale));
      copy.y = clamp(copy.y + 0.5, 0, Math.max(0, state.stage.d - copy.h*copy.scale));
      state.items.push(copy);
      newIds.push(copy.id);
    });
    setSelection(newIds, newIds[0] || null);
    renderLibrary();
    render();
    save();
    openInfoAccordionIfMobile();
  }

  let drag = null;

  function onItemPointerDown(e){
    e.preventDefault();
    e.stopPropagation();

    const id = e.currentTarget.dataset.id;
    const mod = e.shiftKey || e.metaKey || e.ctrlKey;

    if(!state.selectedIds.includes(id) && !mod){
      setSelection([id], id);
      openInfoAccordionIfMobile();
    }else if(!state.selectedIds.includes(id) && mod){
      const arr = Array.from(new Set([...state.selectedIds, id]));
      setSelection(arr, state.primaryId || id);
      openInfoAccordionIfMobile();
    }else{
      openInfoAccordionIfMobile();
    }

    const start = stagePointFromPointer(e);
    const selectedSet = new Set(state.selectedIds);

    const offsets = {};
    state.items.forEach(it => {
      if(!selectedSet.has(it.id)) return;
      offsets[it.id] = { dx: it.x - start.x, dy: it.y - start.y };
    });

    drag = { pointerId: e.pointerId, start, offsets, selectedSet };
    e.currentTarget.setPointerCapture(e.pointerId);
    window.addEventListener("pointermove", onDragMove);
    window.addEventListener("pointerup", onDragUp, { once:true });
  }

  function onDragMove(e){
    if(!drag) return;
    const p = stagePointFromPointer(e);

    state.items.forEach(it => {
      if(!drag.selectedSet.has(it.id)) return;
      const off = drag.offsets[it.id] || { dx:0, dy:0 };
      const w = it.w * it.scale;
      const h = it.h * it.scale;

      it.x = clamp(p.x + off.dx, 0, Math.max(0, state.stage.w - w));
      it.y = clamp(p.y + off.dy, 0, Math.max(0, state.stage.d - h));
    });

    render();
    save();
  }

  function onDragUp(){
    drag = null;
    window.removeEventListener("pointermove", onDragMove);
  }

  function loadUIState(){
    try{
      const raw = localStorage.getItem(LS_UI);
      if(!raw) return { libOpen:true, infoOpen:true };
      const obj = JSON.parse(raw);
      return { libOpen: !!obj.libOpen, infoOpen: !!obj.infoOpen };
    }catch(e){
      return { libOpen:true, infoOpen:true };
    }
  }
  function saveUIState(ui){
    localStorage.setItem(LS_UI, JSON.stringify(ui));
  }
  function applyAccordions(){
    const isMobile = window.matchMedia("(max-width: 980px)").matches;
    const ui = loadUIState();

    if(!isMobile){
      els.libAccContent.classList.remove("accHidden");
      els.infoAccContent.classList.remove("accHidden");
      els.accLibChev.textContent = "â–¾";
      els.accInfoChev.textContent = "â–¾";
      return;
    }

    if(ui.libOpen){
      els.libAccContent.classList.remove("accHidden");
      els.accLibChev.textContent = "â–¾";
    }else{
      els.libAccContent.classList.add("accHidden");
      els.accLibChev.textContent = "â–¸";
    }

    if(ui.infoOpen){
      els.infoAccContent.classList.remove("accHidden");
      els.accInfoChev.textContent = "â–¾";
    }else{
      els.infoAccContent.classList.add("accHidden");
      els.accInfoChev.textContent = "â–¸";
    }
  }

  function toggleLibAccordion(){
    const ui = loadUIState();
    ui.libOpen = !ui.libOpen;
    saveUIState(ui);
    applyAccordions();
  }
  function toggleInfoAccordion(){
    const ui = loadUIState();
    ui.infoOpen = !ui.infoOpen;
    saveUIState(ui);
    applyAccordions();
  }
  function openInfoAccordionIfMobile(){
    const isMobile = window.matchMedia("(max-width: 980px)").matches;
    if(!isMobile) return;
    const ui = loadUIState();
    if(!ui.infoOpen){
      ui.infoOpen = true;
      saveUIState(ui);
      applyAccordions();
    }
  }

  els.stageSquareInner.addEventListener("click", (e) => {
    if(e.target.closest(".item")) return;
    clearSelection();
  });

  document.querySelectorAll('[data-preset]').forEach(btn => {
    btn.addEventListener("click", () => {
      const p = btn.getAttribute("data-preset");
      document.querySelectorAll('[data-preset]').forEach(b => b.classList.remove("on"));
      btn.classList.add("on");
      if(p === "small"){ setStageFeet(20, 14); }
      if(p === "med"){ setStageFeet(24, 16); }
      if(p === "large"){ setStageFeet(30, 20); }
    });
  });
  document.querySelector('[data-preset="med"]').classList.add("on");

  function setStageFeet(wFeet, dFeet){
    state.stage.w = clamp(wFeet, 4, 200);
    state.stage.d = clamp(dFeet, 4, 200);
    updateUnitsUI();
    render();
    save();
  }

  els.stageW.addEventListener("change", () => {
    const wFeet = displayToFeet(els.stageW.value);
    setStageFeet(wFeet, state.stage.d);
  });
  els.stageD.addEventListener("change", () => {
    const dFeet = displayToFeet(els.stageD.value);
    setStageFeet(state.stage.w, dFeet);
  });

  els.btnUnits.addEventListener("click", () => {
    state.units = (state.units === "ft") ? "m" : "ft";
    updateUnitsUI();
    save();
  });

  els.viewZoom.addEventListener("input", () => {
    state.viewZoom = clamp(Number(els.viewZoom.value)/100, 0.5, 2.0);
    updateViewUI();
    render();
    save();
  });
  els.btnResetView.addEventListener("click", () => {
    state.viewZoom = 1.0;
    updateViewUI();
    render();
    save();
  });

  els.btnFlip.addEventListener("click", () => {
    state.view.flip = !state.view.flip;
    updateViewUI();
    render();
    save();
  });

  els.bandName.addEventListener("input", () => { state.bandName = els.bandName.value; save(); });
  els.showNotes.addEventListener("input", () => { state.showNotes = els.showNotes.value; save(); });

  function setPrimaryScaleFromPct(pct){
    const it = getPrimary(); if(!it) return;
    it.scale = clamp(Number(pct)/100, 0.5, 2.0);
    updateSelectionUI();
    render();
    save();
  }
  function setPrimaryRotFromDeg(deg){
    const it = getPrimary(); if(!it) return;
    it.rot = ((Number(deg)||0) % 360 + 360) % 360;
    updateSelectionUI();
    render();
    save();
  }

  els.itemLabel.addEventListener("input", () => {
    const it = getPrimary(); if(!it) return;
    it.label = els.itemLabel.value;
    updateSelectionUI();
    render();
    save();
  });
  els.itemInput.addEventListener("input", () => {
    const it = getPrimary(); if(!it) return;
    it.input = els.itemInput.value;
    render();
    save();
  });
  els.itemMix.addEventListener("input", () => {
    const it = getPrimary(); if(!it) return;
    it.mix = els.itemMix.value;
    render();
    save();
  });
  els.itemNotes.addEventListener("input", () => {
    const it = getPrimary(); if(!it) return;
    it.notes = els.itemNotes.value;
    render();
    save();
  });

  // Info sliders
  els.itemScale.addEventListener("input", () => setPrimaryScaleFromPct(els.itemScale.value));
  els.itemRot.addEventListener("input", () => setPrimaryRotFromDeg(els.itemRot.value));

  // Stage-under sliders (mirror)
  els.itemScaleStage.addEventListener("input", () => setPrimaryScaleFromPct(els.itemScaleStage.value));
  els.itemRotStage.addEventListener("input", () => setPrimaryRotFromDeg(els.itemRotStage.value));

  els.btnRot0.addEventListener("click", () => setPrimaryRotFromDeg(0));
  els.btnRot0Stage.addEventListener("click", () => setPrimaryRotFromDeg(0));

  els.libSearch.addEventListener("input", renderLibrary);
  els.libFilter.addEventListener("change", renderLibrary);

  els.btnMisc1.addEventListener("click", () => addMisc(1));
  els.btnMisc2.addEventListener("click", () => addMisc(2));
  els.btnMisc3.addEventListener("click", () => addMisc(3));

  els.btnDeleteSel.addEventListener("click", deleteSelected);
  els.btnClearSel.addEventListener("click", clearSelection);
  els.btnDup.addEventListener("click", duplicateSelected);

  els.btnExport.addEventListener("click", () => {
    const project = {
      version: APP_VERSION,
      exportedAt: new Date().toISOString(),
      internalUnits: "ft",
      units: state.units,
      stage: { w: state.stage.w, d: state.stage.d },
      view: state.view,
      viewZoom: state.viewZoom,
      bandName: state.bandName,
      showNotes: state.showNotes,
      items: state.items
    };

    const blob = new Blob([JSON.stringify(project, null, 2)], { type:"application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `stageplot-project-${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  });

  els.btnImport.addEventListener("click", () => els.fileImport.click());
  els.fileImport.addEventListener("change", async () => {
    const file = els.fileImport.files && els.fileImport.files[0];
    if(!file) return;

    try{
      const text = await file.text();
      const obj = JSON.parse(text);

      let imported = obj;
      if(imported && imported.internalUnits === "ft"){
        imported = { ...imported, units: "ft" };
      }

      const next = migrateProject(imported);

      if(obj && (obj.units === "ft" || obj.units === "m")){
        next.units = obj.units;
      }else{
        next.units = state.units;
      }

      state = next;
      state.selectedIds = [];
      state.primaryId = null;

      els.bandName.value = state.bandName || "";
      els.showNotes.value = state.showNotes || "";
      updateUnitsUI();
      updateViewUI();
      updateSelectionUI();
      renderLibrary();
      render();
      save();

      alert("Imported project successfully.");
    }catch(e){
      alert("Import failed. That file does not look like valid StagePlot JSON.");
    }finally{
      els.fileImport.value = "";
    }
  });

  els.btnPrint.addEventListener("click", () => {
    const prev = state.viewZoom;
    state.viewZoom = 1.0;
    updateViewUI();
    render();

    setTimeout(() => {
      window.print();
      state.viewZoom = prev;
      updateViewUI();
      render();
      save();
    }, 50);
  });

  window.addEventListener("keydown", (e) => {
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
    const typing = (tag === "input" || tag === "textarea" || tag === "select");
    if(typing) return;

    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "d"){
      e.preventDefault();
      duplicateSelected();
    }
    if(e.key === "Escape"){
      clearSelection();
    }
    if((e.shiftKey) && ["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)){
      e.preventDefault();
      nudgeSelected(e.key);
    }
    if(e.key === "Backspace" || e.key === "Delete"){
      e.preventDefault();
      deleteSelected();
    }
  });

  function nudgeSelected(key){
    if(!state.selectedIds.length) return;
    const step = 0.25;
    const set = new Set(state.selectedIds);
    state.items.forEach(it => {
      if(!set.has(it.id)) return;
      const w = it.w * it.scale;
      const h = it.h * it.scale;
      if(key === "ArrowUp") it.y = clamp(it.y - step, 0, Math.max(0, state.stage.d - h));
      if(key === "ArrowDown") it.y = clamp(it.y + step, 0, Math.max(0, state.stage.d - h));
      if(key === "ArrowLeft") it.x = clamp(it.x - step, 0, Math.max(0, state.stage.w - w));
      if(key === "ArrowRight") it.x = clamp(it.x + step, 0, Math.max(0, state.stage.w - w));
    });
    render();
    save();
  }

  els.accLibBtn.addEventListener("click", toggleLibAccordion);
  els.accInfoBtn.addEventListener("click", toggleInfoAccordion);

  window.addEventListener("resize", () => {
    applyAccordions();
    render();
  });

  load();
  els.bandName.value = state.bandName || "";
  els.showNotes.value = state.showNotes || "";
  updateUnitsUI();
  updateViewUI();
  updateSelectionUI();
  renderLibrary();
  applyAccordions();
  render();
})();
</script>
</body>
</html>
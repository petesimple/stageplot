<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0d12" />
  <title>StagePlot v2 (v1.6.2 - MT)</title>
  <style>
    :root{
      --bg:#0b0d12;
      --panel:#121826;
      --panel2:#0f1420;
      --line:#26324a;
      --text:#e9eefb;
      --muted:#a9b4cc;
      --accent:#4aa3ff;
      --ok:#40d98a;
      --warn:#ffcc66;
      --danger:#ff5a6a;

      --chip: rgba(255,255,255,.06);
      --chipBorder: rgba(255,255,255,.12);
      --shadow: 0 12px 30px rgba(0,0,0,.35);

      --stageBg: rgba(255,255,255,.03);
      --stageBorder: rgba(255,255,255,.12);
      --grid: rgba(255,255,255,.06);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 700px at 50% -10%, #1a2540, var(--bg));
      color: var(--text);
      line-height:1.4;
      overflow:hidden;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 30;
      border-bottom: 1px solid var(--line);
      background: rgba(10,12,18,.78);
      backdrop-filter: blur(10px);
    }

    .wrap{
      max-width: 1260px;
      margin: 0 auto;
      padding: 10px 12px;
    }

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .title{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 260px;
    }

    .logo{
      width:34px; height:34px;
      border-radius: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:center;
      color: var(--accent);
      font-weight: 900;
      user-select:none;
    }

    h1{
      font-size: 15px;
      margin:0;
      letter-spacing:.2px;
      line-height:1.2;
    }
    .sub{
      color: var(--muted);
      font-size: 12px;
      margin-top: 2px;
    }

    a.button, button, .btn{
      font: inherit;
      color: var(--text);
      background: var(--chip);
      border: 1px solid var(--chipBorder);
      border-radius: 12px;
      padding: 9px 10px;
      text-decoration:none;
      cursor:pointer;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    a.button:hover, button:hover, .btn:hover{ border-color: rgba(74,163,255,.8); }
    a.button:active, button:active, .btn:active{ transform: translateY(1px); }
    .primary{
      background: rgba(74,163,255,.14);
      border-color: rgba(74,163,255,.55);
    }
    .ok{
      background: rgba(64,217,138,.10);
      border-color: rgba(64,217,138,.40);
    }
    .danger{
      background: rgba(255,90,106,.10);
      border-color: rgba(255,90,106,.35);
    }

    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    main{
      height: calc(100vh - 64px);
      max-width: 1260px;
      margin: 0 auto;
      padding: 10px 12px 12px 12px;
      display:grid;
      grid-template-columns: 290px 1fr 320px;
      gap:10px;
    }

    @media (max-width: 1100px){
      main{ grid-template-columns: 290px 1fr; }
      .right{ display:none; }
    }
    @media (max-width: 860px){
      main{ grid-template-columns: 1fr; height:auto; overflow:auto; }
      body{ overflow:auto; }
      .left{ order: 2; }
      .stageCard{ order: 1; }
      .right{ order: 3; display:block; }
    }

    .card{
      background: linear-gradient(180deg, rgba(18,24,38,.92), rgba(12,16,26,.92));
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      min-width: 0;
      display:flex;
      flex-direction:column;
    }
    .card .hd{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .card .hd h2{
      margin:0;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .35px;
      font-weight: 900;
    }
    .card .bd{ padding: 10px 10px; overflow:auto; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
      white-space:nowrap;
    }

    .miniHelp{ color: var(--muted); font-size: 12px; }
    .hr{ height:1px; background: rgba(255,255,255,.08); margin: 10px 0; }

    label{ font-size: 12px; color: var(--muted); display:block; margin-bottom:6px; }
    input[type="text"], input[type="number"], select, textarea{
      width:100%;
      font: inherit;
      color: var(--text);
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding: 9px 10px;
      outline: none;
    }
    textarea{ min-height: 84px; resize: vertical; }

    input[type="range"]{ width: 100%; }

    .two{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .three{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    @media (max-width: 520px){
      .two, .three{ grid-template-columns: 1fr; }
    }

    .libGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }
    .libBtn{
      justify-content:flex-start;
      padding: 10px 10px;
      border-radius: 14px;
      font-weight: 800;
      gap:10px;
    }
    .libBtn .ic{
      width:18px; height:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:.95;
    }
    .libBtn .tx{ font-size: 13px; }
    .libBtn small{ display:block; font-weight:600; color: var(--muted); font-size: 11px; margin-top:2px; }

    .stageWrap{
      position: relative;
      height: 100%;
      min-height: 420px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .stageTopTools{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }

    .stageOuter{
      position: relative;
      flex: 1;
      min-height: 360px;
      border-radius: 18px;
      border: 1px solid var(--stageBorder);
      background:
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.0)),
        radial-gradient(1200px 700px at 50% -20%, rgba(74,163,255,.12), rgba(0,0,0,0));
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }

    .stageGrid{
      position:absolute;
      inset:0;
      background-image:
        linear-gradient(to right, var(--grid) 1px, transparent 1px),
        linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
      background-size: 40px 40px;
      opacity:.35;
      pointer-events:none;
      transform: scale(var(--viewZoom, 1));
      transform-origin: top left;
    }

    .stage{
      position:absolute;
      inset:0;
      transform: scale(var(--viewZoom, 1));
      transform-origin: top left;
    }

    .stageFrame{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      width: var(--stageWpx, 780px);
      height: var(--stageHpx, 420px);
      border-radius: 20px;
      border: 2px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.02);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }

    .stageFrame::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius: 18px;
      background:
        radial-gradient(900px 520px at 50% 120%, rgba(64,217,138,.08), rgba(0,0,0,0));
      pointer-events:none;
    }

    .stageTag{
      position:absolute;
      left: 14px;
      top: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
      pointer-events:none;
    }

    .item{
      position:absolute;
      left: 0; top: 0;
      width: 90px;
      height: 54px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      box-shadow: 0 10px 22px rgba(0,0,0,.28);
      cursor: grab;
      user-select:none;
      touch-action:none;
      transform-origin: center;
    }
    .item:active{ cursor: grabbing; }

    .item.selected{
      outline: 2px solid rgba(74,163,255,.75);
      outline-offset: 2px;
      border-color: rgba(74,163,255,.55);
    }

    /* Label (MT idea) */
    .item-label{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%) scale(var(--labelScale, 1));
      transform-origin: center;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      pointer-events:none;
      user-select:none;
      max-width: 92%;
    }
    .item-label .name{
      font-weight: 900;
      line-height: 1;
      white-space: nowrap;
      text-shadow: 0 2px 10px rgba(0,0,0,.55);
      font-size: 12px;
    }
    .item-label .icon{
      width: 22px;
      height: 22px;
      flex: 0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      filter: drop-shadow(0 2px 10px rgba(0,0,0,.45));
    }
    .item-label .icon svg{ width: 100%; height: 100%; }

    .itemFoot{
      position:absolute;
      left:10px;
      right:10px;
      bottom:8px;
      display:flex;
      justify-content:space-between;
      gap:6px;
      color: rgba(255,255,255,.65);
      font-size: 11px;
      pointer-events:none;
      opacity: .9;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--muted);
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(18,24,38,.95);
      border: 1px solid rgba(255,255,255,.14);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.40);
      color: var(--text);
      font-size: 13px;
      display:none;
      z-index: 1000;
    }
    .toast.on{ display:block; }

    /* Print */
    @media print{
      header, .left, .right, .stageTopTools{ display:none !important; }
      body{ background:#fff; overflow:visible; }
      main{ grid-template-columns: 1fr; height:auto; padding:0; max-width:none; }
      .card{ box-shadow:none; border:0; border-radius:0; }
      .stageOuter{ border:0; box-shadow:none; }
      .stageGrid{ display:none; }
      .stageFrame{ border: 2px solid #000; background:#fff; }
      .item{ box-shadow:none; }
      .item.selected{ outline:none; }
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <div class="logo" aria-hidden="true">SP</div>
        <div>
          <h1>StagePlot v2</h1>
          <div class="sub">v1.6.2 - MT (Mark Toggle labels: name/icon/both + unified label scale)</div>
        </div>
      </div>
      <div class="row">
        <button class="btn" id="btnNew">New</button>
        <button class="btn" id="btnExport">Export JSON</button>
        <button class="btn" id="btnImport">Import JSON</button>
        <button class="btn primary" id="btnPrint">Print</button>
        <a class="button" href="./guide.html" title="Guide">Guide</a>
      </div>
    </div>
  </div>
</header>

<main>
  <!-- LEFT: Library + Stage Settings -->
  <section class="card left">
    <div class="hd">
      <h2>Item Library</h2>
      <span class="pill">Tap to add</span>
    </div>
    <div class="bd">
      <div class="miniHelp">Adds an item centered on the stage. Drag it into place.</div>
      <div class="hr"></div>

      <div class="libGrid" id="libGrid"></div>

      <div class="hr"></div>

      <div class="two">
        <div>
          <label>Stage Width (ft)</label>
          <input type="number" id="stageW" min="8" max="60" step="0.5" />
        </div>
        <div>
          <label>Stage Depth (ft)</label>
          <input type="number" id="stageH" min="6" max="40" step="0.5" />
        </div>
      </div>

      <div class="two" style="margin-top:10px;">
        <div>
          <label>View Zoom</label>
          <input type="range" id="viewZoom" min="0.6" max="1.6" step="0.02" />
          <div class="miniHelp"><span class="kbd" id="viewZoomVal">100%</span> - affects view only (not stage or item sizes)</div>
        </div>
        <div>
          <label>Grid</label>
          <div class="row">
            <button class="btn" id="btnGrid">Toggle grid</button>
            <button class="btn" id="btnCenterStage">Center view</button>
          </div>
          <div class="miniHelp">Shift+Arrows nudges selected items</div>
        </div>
      </div>

      <div class="hr"></div>

      <label>Show Notes (prints well)</label>
      <textarea id="showNotes" placeholder="Load-in notes, contact, power notes, backline, etc."></textarea>
      <div class="miniHelp" style="margin-top:8px;">Tip: Use Export JSON for sharing across devices.</div>
    </div>
  </section>

  <!-- CENTER: Stage -->
  <section class="card stageCard">
    <div class="hd">
      <h2>Stage</h2>
      <span class="pill" id="selPill">No selection</span>
    </div>
    <div class="bd">
      <div class="stageWrap">
        <div class="stageTopTools">
          <div class="row">
            <button class="btn" id="btnFront">Bring front</button>
            <button class="btn" id="btnBack">Send back</button>
            <button class="btn danger" id="btnDelete">Delete</button>
          </div>
          <div class="row">
            <button class="btn" id="btnAlignH">Align row</button>
            <button class="btn" id="btnAlignV">Align col</button>
            <button class="btn" id="btnDistributeH">Distribute H</button>
          </div>
        </div>

        <div class="stageOuter" id="stageOuter">
          <div class="stageGrid" id="stageGrid"></div>
          <div class="stage" id="stage">
            <div class="stageFrame" id="stageFrame">
              <div class="stageTag" id="stageTag">Stage</div>
            </div>
          </div>
        </div>

        <div class="miniHelp">
          Selection: click item. Multi-select: <span class="kbd">Shift</span>/<span class="kbd">Cmd</span>/<span class="kbd">Ctrl</span> + click.
          Delete: <span class="kbd">Backspace</span>/<span class="kbd">Delete</span>. Clear: <span class="kbd">Esc</span>.
        </div>
      </div>
    </div>
  </section>

  <!-- RIGHT: Inspector -->
  <section class="card right">
    <div class="hd">
      <h2>Inspector</h2>
      <span class="pill">Edit selected</span>
    </div>
    <div class="bd" id="inspector">
      <div class="miniHelp">Select an item to edit its label mode (name/icon/both) and scale them together.</div>
      <div class="hr"></div>

      <div class="two">
        <div>
          <label>Name</label>
          <input type="text" id="iName" placeholder="e.g., Vox 1" />
        </div>
        <div>
          <label>Icon</label>
          <select id="iIcon"></select>
        </div>
      </div>

      <div class="two" style="margin-top:10px;">
        <div>
          <label>Label Mode (MT)</label>
          <select id="iLabelMode">
            <option value="name">Name</option>
            <option value="icon">Icon</option>
            <option value="both">Both</option>
          </select>
          <div class="miniHelp" style="margin-top:6px;">This makes icons interchangeable with names.</div>
        </div>
        <div>
          <label>Label Scale (MT)</label>
          <input type="range" id="iLabelScale" min="0.6" max="2.0" step="0.02" />
          <div class="miniHelp"><span class="kbd" id="iLabelScaleVal">1.00x</span> - scales name/icon together</div>
        </div>
      </div>

      <div class="three" style="margin-top:10px;">
        <div>
          <label>Width (ft)</label>
          <input type="number" id="iW" step="0.1" min="0.5" />
        </div>
        <div>
          <label>Depth (ft)</label>
          <input type="number" id="iH" step="0.1" min="0.5" />
        </div>
        <div>
          <label>Rotate (deg)</label>
          <input type="number" id="iRot" step="1" />
        </div>
      </div>

      <div class="two" style="margin-top:10px;">
        <div>
          <label>Scale Footprint</label>
          <input type="range" id="iScale" min="0.5" max="2.0" step="0.02" />
          <div class="miniHelp"><span class="kbd" id="iScaleVal">1.00x</span></div>
        </div>
        <div>
          <label>Color</label>
          <select id="iColor">
            <option value="">Default</option>
            <option value="#4aa3ff">Blue</option>
            <option value="#40d98a">Green</option>
            <option value="#ffcc66">Yellow</option>
            <option value="#ff5a6a">Red</option>
            <option value="#b388ff">Purple</option>
            <option value="#ffffff">White</option>
          </select>
        </div>
      </div>

      <div class="hr"></div>

      <div class="two">
        <div>
          <label>Input</label>
          <input type="text" id="iInput" placeholder="e.g., XLR 3" />
        </div>
        <div>
          <label>Mix</label>
          <input type="text" id="iMix" placeholder="e.g., Wedge 2" />
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>Notes</label>
        <textarea id="iNotes" placeholder="Mic placement, power needs, etc."></textarea>
      </div>

      <div class="hr"></div>
      <div class="row">
        <button class="btn" id="btnNudgeUp">Nudge ↑</button>
        <button class="btn" id="btnNudgeDown">Nudge ↓</button>
        <button class="btn" id="btnNudgeLeft">Nudge ←</button>
        <button class="btn" id="btnNudgeRight">Nudge →</button>
      </div>
      <div class="miniHelp" style="margin-top:8px;">Tip: Use multi-select then change Label Mode or Label Scale to apply to all selected items.</div>
    </div>
  </section>
</main>

<div class="toast" id="toast">Saved</div>

<input type="file" id="fileImport" accept="application/json" hidden />

<script>
(() => {
  // ------------------ Version ------------------
  const APP_VERSION = "1.6.2 (MT)";

  // ------------------ Utilities ------------------
  const $ = (id) => document.getElementById(id);
  const toastEl = $("toast");
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("on");
    clearTimeout(toast._t);
    toast._t = setTimeout(() => toastEl.classList.remove("on"), 1100);
  }
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  // ------------------ Icon Library ------------------
  // Icons are SVG strings keyed by name
  const ICONS = {
    "mic": `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 14a4 4 0 0 0 4-4V6a4 4 0 0 0-8 0v4a4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="2"/><path d="M19 10a7 7 0 0 1-14 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M12 17v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M8 21h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`,
    "guitar": `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 3l7 7-2 2-7-7 2-2Z" fill="currentColor" opacity=".9"/><path d="M12.4 6.6 10.9 8.1a4.5 4.5 0 0 0-4.9 7.5L4 17.7l2.3 2.3 2.1-2.1a4.5 4.5 0 0 0 7.5-4.9l1.5-1.5-5-5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>`,
    "keys": `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 7h16v10H4V7Z" stroke="currentColor" stroke-width="2"/><path d="M7 7v10M10 7v10M13 7v10M16 7v10" stroke="currentColor" stroke-width="1.5" opacity=".8"/></svg>`,
    "drums": `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 7h12l-1 12H7L6 7Z" stroke="currentColor" stroke-width="2"/><path d="M6 7c0-2 3-3 6-3s6 1 6 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M5 10h14" stroke="currentColor" stroke-width="1.5" opacity=".8"/></svg>`,
    "wedge": `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 18 8 6h12l-4 12H4Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="M8 12h10" stroke="currentColor" stroke-width="1.5" opacity=".8"/></svg>`,
    "amp": `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 7h14v12H5V7Z" stroke="currentColor" stroke-width="2"/><path d="M8 10h8M8 13h8" stroke="currentColor" stroke-width="1.5" opacity=".8"/><path d="M9 16h.01M12 16h.01M15 16h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>`,
    "power": `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M7 4.5a8 8 0 1 0 10 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`,
    "di": `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 7h12v10H6V7Z" stroke="currentColor" stroke-width="2"/><path d="M9 10h6M9 13h6" stroke="currentColor" stroke-width="1.5" opacity=".8"/><path d="M6 12H4M20 12h-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`,
    "blank": `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 6h12v12H6V6Z" stroke="currentColor" stroke-width="2" opacity=".8"/></svg>`
  };

  function getIconSvg(key){
    return ICONS[key] || ICONS.blank;
  }

  const LIB = [
    { type:"Vocal", iconKey:"mic", w:2.5, h:1.5, color:"#4aa3ff" },
    { type:"Guitar", iconKey:"guitar", w:3.0, h:1.8, color:"#40d98a" },
    { type:"Keys",  iconKey:"keys", w:3.2, h:1.8, color:"#ffcc66" },
    { type:"Drums", iconKey:"drums", w:4.5, h:3.0, color:"#b388ff" },
    { type:"Wedge", iconKey:"wedge", w:2.2, h:1.4, color:"#ffffff" },
    { type:"Amp",   iconKey:"amp", w:2.3, h:1.6, color:"#ff5a6a" },
    { type:"DI",    iconKey:"di", w:2.0, h:1.2, color:"#4aa3ff" },
    { type:"Power", iconKey:"power", w:1.4, h:1.4, color:"#ffcc66" },
  ];

  // ------------------ State ------------------
  const STORAGE_KEY = "stageplot_v2_state_mt";
  const state = {
    version: APP_VERSION,
    stage: { wFt: 24, hFt: 14 },
    viewZoom: 1.0,
    showGrid: true,
    showNotes: "",
    items: [],
    zCounter: 1,
    selection: [],
  };

  // Stage scaling: 1ft -> px
  const PX_PER_FT = 28; // tuned for pleasant default
  function stagePx(){
    return {
      w: state.stage.wFt * PX_PER_FT,
      h: state.stage.hFt * PX_PER_FT
    };
  }

  // ------------------ DOM ------------------
  const stageOuter = $("stageOuter");
  const stage = $("stage");
  const stageFrame = $("stageFrame");
  const stageGrid = $("stageGrid");
  const selPill = $("selPill");

  // Left
  const stageW = $("stageW");
  const stageH = $("stageH");
  const viewZoom = $("viewZoom");
  const viewZoomVal = $("viewZoomVal");
  const showNotes = $("showNotes");

  // Inspector
  const iName = $("iName");
  const iIcon = $("iIcon");
  const iLabelMode = $("iLabelMode");
  const iLabelScale = $("iLabelScale");
  const iLabelScaleVal = $("iLabelScaleVal");

  const iW = $("iW");
  const iH = $("iH");
  const iRot = $("iRot");
  const iScale = $("iScale");
  const iScaleVal = $("iScaleVal");
  const iColor = $("iColor");
  const iInput = $("iInput");
  const iMix = $("iMix");
  const iNotes = $("iNotes");

  // Buttons
  $("btnNew").addEventListener("click", onNew);
  $("btnExport").addEventListener("click", onExport);
  $("btnImport").addEventListener("click", () => $("fileImport").click());
  $("fileImport").addEventListener("change", onImportFile);
  $("btnPrint").addEventListener("click", () => window.print());

  $("btnDelete").addEventListener("click", deleteSelection);
  $("btnFront").addEventListener("click", bringFront);
  $("btnBack").addEventListener("click", sendBack);
  $("btnAlignH").addEventListener("click", alignRow);
  $("btnAlignV").addEventListener("click", alignCol);
  $("btnDistributeH").addEventListener("click", distributeH);

  $("btnGrid").addEventListener("click", () => { state.showGrid = !state.showGrid; save(); render(); });
  $("btnCenterStage").addEventListener("click", () => { state.viewZoom = 1.0; save(); render(); });

  $("btnNudgeUp").addEventListener("click", () => nudge(0, -0.15));
  $("btnNudgeDown").addEventListener("click", () => nudge(0, 0.15));
  $("btnNudgeLeft").addEventListener("click", () => nudge(-0.15, 0));
  $("btnNudgeRight").addEventListener("click", () => nudge(0.15, 0));

  // ------------------ Build UI ------------------
  function buildLibrary(){
    const grid = $("libGrid");
    grid.innerHTML = "";
    for(const item of LIB){
      const b = document.createElement("button");
      b.className = "btn libBtn";
      b.innerHTML = `
        <span class="ic">${wrapSvg(getIconSvg(item.iconKey))}</span>
        <span class="tx">${escapeHtml(item.type)}<small>${item.w}ft x ${item.h}ft</small></span>
      `;
      b.addEventListener("click", () => addItem(item));
      grid.appendChild(b);
    }
  }

  function buildIconSelect(){
    iIcon.innerHTML = "";
    Object.keys(ICONS).forEach((k) => {
      const opt = document.createElement("option");
      opt.value = k;
      opt.textContent = k;
      iIcon.appendChild(opt);
    });
  }

  function wrapSvg(svgStr){
    // color inherits from currentColor
    return `<span style="color:rgba(233,238,251,.92);display:inline-flex">${svgStr}</span>`;
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ------------------ Core: Add / Render ------------------
  function addItem(proto){
    const { w, h } = stagePx();
    // center inside stage frame
    const x = (state.stage.wFt/2) - (proto.w/2);
    const y = (state.stage.hFt/2) - (proto.h/2);

    const it = {
      id: uid(),
      type: proto.type,
      name: proto.type,
      iconKey: proto.iconKey,
      // MT label interchange
      labelMode: "both",      // name | icon | both
      labelScale: 1.0,        // scales both together
      // geometry in feet (stage units)
      xFt: x,
      yFt: y,
      wFt: proto.w,
      hFt: proto.h,
      rot: 0,
      scale: 1.0,
      color: proto.color || "",
      input: "",
      mix: "",
      notes: "",
      z: ++state.zCounter,
    };

    state.items.push(it);
    state.selection = [it.id];
    save();
    render();
  }

  function render(){
    // stage frame sizing
    const px = stagePx();
    stageFrame.style.setProperty("--stageWpx", px.w + "px");
    stageFrame.style.setProperty("--stageHpx", px.h + "px");

    // view zoom
    stageOuter.style.setProperty("--viewZoom", state.viewZoom);
    stageGrid.style.display = state.showGrid ? "block" : "none";

    // left controls
    stageW.value = state.stage.wFt;
    stageH.value = state.stage.hFt;
    viewZoom.value = state.viewZoom;
    viewZoomVal.textContent = Math.round(state.viewZoom * 100) + "%";
    showNotes.value = state.showNotes || "";

    // stage contents
    stage.innerHTML = "";
    stage.appendChild(stageFrame); // keep the frame
    stageFrame.querySelector("#stageTag").textContent = `Stage - ${state.stage.wFt}ft x ${state.stage.hFt}ft`;

    for(const it of state.items.slice().sort((a,b)=>a.z-b.z)){
      const el = document.createElement("div");
      el.className = "item";
      el.dataset.id = it.id;

      // size/pos
      const wPx = it.wFt * PX_PER_FT;
      const hPx = it.hFt * PX_PER_FT;
      const xPx = it.xFt * PX_PER_FT;
      const yPx = it.yFt * PX_PER_FT;

      el.style.width = wPx + "px";
      el.style.height = hPx + "px";
      el.style.left = (frameLeftPx() + xPx) + "px";
      el.style.top = (frameTopPx() + yPx) + "px";
      el.style.zIndex = it.z;

      const bg = it.color ? hexToRgba(it.color, 0.14) : "rgba(255,255,255,.06)";
      const border = it.color ? hexToRgba(it.color, 0.55) : "rgba(255,255,255,.16)";
      el.style.background = bg;
      el.style.borderColor = border;

      el.style.transform = `rotate(${it.rot}deg) scale(${it.scale})`;

      // label (MT)
      const label = document.createElement("div");
      label.className = "item-label";
      label.style.setProperty("--labelScale", it.labelScale ?? 1);

      const mode = it.labelMode || "name";
      if(mode === "icon" || mode === "both"){
        const ic = document.createElement("div");
        ic.className = "icon";
        ic.innerHTML = getIconSvg(it.iconKey);
        label.appendChild(ic);
      }
      if(mode === "name" || mode === "both"){
        const nm = document.createElement("div");
        nm.className = "name";
        nm.textContent = it.name || it.type || "";
        label.appendChild(nm);
      }
      el.appendChild(label);

      const foot = document.createElement("div");
      foot.className = "itemFoot";
      foot.innerHTML = `<span>${escapeHtml(it.input||"")}</span><span>${escapeHtml(it.mix||"")}</span>`;
      el.appendChild(foot);

      // selection state
      if(state.selection.includes(it.id)) el.classList.add("selected");

      // events
      el.addEventListener("pointerdown", onItemPointerDown);
      el.addEventListener("click", (e) => {
        // click selection (allow multi)
        if(isMultiKey(e)) toggleSelection(it.id);
        else setSelection([it.id]);
      });

      stage.appendChild(el);
    }

    updateSelectionPill();
    syncInspector();
  }

  function frameLeftPx(){
    // stageFrame is centered. Compute its left/top relative to stage container (0,0)
    const outer = stageOuter.getBoundingClientRect();
    const w = state.stage.wFt * PX_PER_FT;
    const left = (outer.width / state.viewZoom - w) / 2;
    return left;
  }
  function frameTopPx(){
    const outer = stageOuter.getBoundingClientRect();
    const h = state.stage.hFt * PX_PER_FT;
    const top = (outer.height / state.viewZoom - h) / 2;
    return top;
  }

  // ------------------ Selection ------------------
  function updateSelectionPill(){
    const n = state.selection.length;
    if(n === 0) selPill.textContent = "No selection";
    else if(n === 1){
      const it = getSelectedItems()[0];
      selPill.textContent = `Selected: ${it?.name || it?.type || "Item"}`;
    }else{
      selPill.textContent = `Selected: ${n} items`;
    }
  }

  function setSelection(ids){
    state.selection = ids.slice();
    save();
    render();
  }

  function toggleSelection(id){
    const s = new Set(state.selection);
    if(s.has(id)) s.delete(id); else s.add(id);
    state.selection = [...s];
    save();
    render();
  }

  function clearSelection(){
    state.selection = [];
    save();
    render();
  }

  function getSelectedItems(){
    const set = new Set(state.selection);
    return state.items.filter(it => set.has(it.id));
  }

  function isMultiKey(e){
    return e.shiftKey || e.metaKey || e.ctrlKey;
  }

  // ------------------ Dragging ------------------
  let drag = null;

  function onItemPointerDown(e){
    const el = e.currentTarget;
    const id = el.dataset.id;
    const it = state.items.find(x => x.id === id);
    if(!it) return;

    // if not in selection, select it (unless multi key)
    if(!state.selection.includes(id) && !isMultiKey(e)) setSelection([id]);
    if(isMultiKey(e)) toggleSelection(id);

    const outerRect = stageOuter.getBoundingClientRect();
    const start = { x: e.clientX, y: e.clientY };

    // capture initial positions for all selected items
    const selected = getSelectedItems();
    const init = selected.map(s => ({ id:s.id, xFt:s.xFt, yFt:s.yFt }));

    el.setPointerCapture(e.pointerId);
    drag = { pointerId: e.pointerId, start, outerRect, init };

    e.preventDefault();
    e.stopPropagation();
  }

  window.addEventListener("pointermove", (e) => {
    if(!drag) return;
    const dx = (e.clientX - drag.start.x) / state.viewZoom;
    const dy = (e.clientY - drag.start.y) / state.viewZoom;

    const dxFt = dx / PX_PER_FT;
    const dyFt = dy / PX_PER_FT;

    const frameW = state.stage.wFt;
    const frameH = state.stage.hFt;

    // move each selected item
    for(const item0 of drag.init){
      const it = state.items.find(x => x.id === item0.id);
      if(!it) continue;
      it.xFt = clamp(item0.xFt + dxFt, 0, frameW - it.wFt);
      it.yFt = clamp(item0.yFt + dyFt, 0, frameH - it.hFt);
    }

    render(); // live
  });

  window.addEventListener("pointerup", (e) => {
    if(!drag) return;
    drag = null;
    save();
  });

  // Click empty stage clears selection
  stageOuter.addEventListener("click", (e) => {
    if(e.target === stageOuter || e.target === stageGrid) clearSelection();
  });

  // ------------------ Inspector Sync ------------------
  function syncInspector(){
    const sel = getSelectedItems();
    if(sel.length === 0){
      disableInspector(true);
      return;
    }
    disableInspector(false);

    // If multi selection - show mixed state where needed (keep simple)
    const first = sel[0];

    iName.value = same(sel, x => x.name) ? (first.name || "") : "";
    iIcon.value = same(sel, x => x.iconKey) ? (first.iconKey || "blank") : "blank";

    iLabelMode.value = same(sel, x => x.labelMode) ? (first.labelMode || "name") : "name";
    iLabelScale.value = (same(sel, x => x.labelScale) ? (first.labelScale ?? 1) : 1);
    iLabelScaleVal.textContent = (parseFloat(iLabelScale.value).toFixed(2)) + "x";

    iW.value = same(sel, x => x.wFt) ? first.wFt : "";
    iH.value = same(sel, x => x.hFt) ? first.hFt : "";
    iRot.value = same(sel, x => x.rot) ? first.rot : "";

    iScale.value = same(sel, x => x.scale) ? (first.scale ?? 1) : 1;
    iScaleVal.textContent = (parseFloat(iScale.value).toFixed(2)) + "x";

    iColor.value = same(sel, x => x.color) ? (first.color || "") : "";

    iInput.value = same(sel, x => x.input) ? (first.input || "") : "";
    iMix.value = same(sel, x => x.mix) ? (first.mix || "") : "";
    iNotes.value = same(sel, x => x.notes) ? (first.notes || "") : "";
  }

  function disableInspector(disabled){
    const ids = ["iName","iIcon","iLabelMode","iLabelScale","iW","iH","iRot","iScale","iColor","iInput","iMix","iNotes"];
    ids.forEach(id => { $(id).disabled = disabled; });
  }

  function same(arr, getter){
    const v0 = getter(arr[0]);
    for(let i=1;i<arr.length;i++){
      if(getter(arr[i]) !== v0) return false;
    }
    return true;
  }

  function applyToSelection(fn){
    const sel = getSelectedItems();
    if(sel.length === 0) return;
    sel.forEach(fn);
    save();
    render();
  }

  // Inspector listeners
  iName.addEventListener("input", () => applyToSelection(it => it.name = iName.value));
  iIcon.addEventListener("change", () => applyToSelection(it => it.iconKey = iIcon.value));

  // MT: label mode + label scale
  iLabelMode.addEventListener("change", () => applyToSelection(it => it.labelMode = iLabelMode.value));
  iLabelScale.addEventListener("input", () => {
    iLabelScaleVal.textContent = (parseFloat(iLabelScale.value).toFixed(2)) + "x";
    applyToSelection(it => it.labelScale = parseFloat(iLabelScale.value));
  });

  iW.addEventListener("input", () => {
    const v = parseFloat(iW.value);
    if(!Number.isFinite(v)) return;
    applyToSelection(it => it.wFt = clamp(v, 0.5, 20));
  });
  iH.addEventListener("input", () => {
    const v = parseFloat(iH.value);
    if(!Number.isFinite(v)) return;
    applyToSelection(it => it.hFt = clamp(v, 0.5, 20));
  });
  iRot.addEventListener("input", () => {
    const v = parseFloat(iRot.value);
    if(!Number.isFinite(v)) return;
    applyToSelection(it => it.rot = v);
  });

  iScale.addEventListener("input", () => {
    iScaleVal.textContent = (parseFloat(iScale.value).toFixed(2)) + "x";
    applyToSelection(it => it.scale = parseFloat(iScale.value));
  });

  iColor.addEventListener("change", () => applyToSelection(it => it.color = iColor.value));
  iInput.addEventListener("input", () => applyToSelection(it => it.input = iInput.value));
  iMix.addEventListener("input", () => applyToSelection(it => it.mix = iMix.value));
  iNotes.addEventListener("input", () => applyToSelection(it => it.notes = iNotes.value));

  // ------------------ Stage controls ------------------
  stageW.addEventListener("input", () => {
    const v = parseFloat(stageW.value);
    if(!Number.isFinite(v)) return;
    state.stage.wFt = clamp(v, 8, 60);
    constrainAllToStage();
    save(); render();
  });
  stageH.addEventListener("input", () => {
    const v = parseFloat(stageH.value);
    if(!Number.isFinite(v)) return;
    state.stage.hFt = clamp(v, 6, 40);
    constrainAllToStage();
    save(); render();
  });
  viewZoom.addEventListener("input", () => {
    const v = parseFloat(viewZoom.value);
    state.viewZoom = clamp(v, 0.6, 1.6);
    save(); render();
  });
  showNotes.addEventListener("input", () => {
    state.showNotes = showNotes.value;
    save();
  });

  function constrainAllToStage(){
    for(const it of state.items){
      it.xFt = clamp(it.xFt, 0, state.stage.wFt - it.wFt);
      it.yFt = clamp(it.yFt, 0, state.stage.hFt - it.hFt);
    }
  }

  // ------------------ Nudge / Keyboard ------------------
  function nudge(dxFt, dyFt){
    applyToSelection(it => {
      it.xFt = clamp(it.xFt + dxFt, 0, state.stage.wFt - it.wFt);
      it.yFt = clamp(it.yFt + dyFt, 0, state.stage.hFt - it.hFt);
    });
  }

  window.addEventListener("keydown", (e) => {
    // ignore while typing
    const tag = (document.activeElement?.tagName || "").toLowerCase();
    if(tag === "input" || tag === "textarea" || tag === "select") return;

    if(e.key === "Escape"){ clearSelection(); }
    if(e.key === "Backspace" || e.key === "Delete"){ deleteSelection(); }

    if(e.shiftKey){
      if(e.key === "ArrowUp") nudge(0, -0.10);
      if(e.key === "ArrowDown") nudge(0, 0.10);
      if(e.key === "ArrowLeft") nudge(-0.10, 0);
      if(e.key === "ArrowRight") nudge(0.10, 0);
    }
  });

  // ------------------ Arrange helpers ------------------
  function deleteSelection(){
    const set = new Set(state.selection);
    if(set.size === 0) return;
    state.items = state.items.filter(it => !set.has(it.id));
    state.selection = [];
    save(); render();
  }

  function bringFront(){
    const sel = getSelectedItems();
    if(sel.length === 0) return;
    const maxZ = Math.max(0, ...state.items.map(i => i.z));
    sel.forEach((it, idx) => it.z = maxZ + 1 + idx);
    state.zCounter = maxZ + sel.length + 2;
    save(); render();
  }

  function sendBack(){
    const sel = getSelectedItems();
    if(sel.length === 0) return;
    const minZ = Math.min(...state.items.map(i => i.z));
    sel.forEach((it, idx) => it.z = minZ - 1 - idx);
    save(); render();
  }

  function alignRow(){
    const sel = getSelectedItems();
    if(sel.length < 2) return;
    const avgY = sel.reduce((a,b)=>a+b.yFt,0)/sel.length;
    sel.forEach(it => it.yFt = clamp(avgY, 0, state.stage.hFt - it.hFt));
    save(); render();
  }

  function alignCol(){
    const sel = getSelectedItems();
    if(sel.length < 2) return;
    const avgX = sel.reduce((a,b)=>a+b.xFt,0)/sel.length;
    sel.forEach(it => it.xFt = clamp(avgX, 0, state.stage.wFt - it.wFt));
    save(); render();
  }

  function distributeH(){
    const sel = getSelectedItems().slice().sort((a,b)=>a.xFt-b.xFt);
    if(sel.length < 3) return;
    const left = sel[0].xFt;
    const right = sel[sel.length-1].xFt;
    const step = (right - left) / (sel.length - 1);
    sel.forEach((it, i) => it.xFt = clamp(left + step*i, 0, state.stage.wFt - it.wFt));
    save(); render();
  }

  // ------------------ New / Export / Import ------------------
  function onNew(){
    if(!confirm("Start a new stage plot? This clears current items (autosave will be replaced).")) return;
    state.items = [];
    state.selection = [];
    state.stage = { wFt: 24, hFt: 14 };
    state.viewZoom = 1.0;
    state.showGrid = true;
    state.showNotes = "";
    state.zCounter = 1;
    save(); render();
  }

  function onExport(){
    const payload = JSON.stringify(state, null, 2);
    const blob = new Blob([payload], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    const stamp = new Date().toISOString().slice(0,19).replaceAll(":","-");
    a.download = `stageplot_v2_${APP_VERSION.replaceAll(" ","").replaceAll("(","").replaceAll(")","")}_${stamp}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    toast("Exported JSON");
  }

  function onImportFile(e){
    const file = e.target.files?.[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const incoming = JSON.parse(reader.result);
        importState(incoming);
        toast("Imported");
      }catch(err){
        alert("Import failed: not valid JSON");
      }finally{
        e.target.value = "";
      }
    };
    reader.readAsText(file);
  }

  function importState(incoming){
    // Basic shape checks, then normalize missing MT fields
    if(!incoming || typeof incoming !== "object") throw new Error("bad");
    const next = structuredClone(incoming);

    if(!next.stage) next.stage = { wFt: 24, hFt: 14 };
    if(!Array.isArray(next.items)) next.items = [];
    if(!Array.isArray(next.selection)) next.selection = [];

    // Normalize items to include MT label fields
    next.items.forEach(it => {
      if(!it.id) it.id = uid();
      if(!it.iconKey) it.iconKey = "blank";
      if(!it.name) it.name = it.type || "Item";
      if(!it.labelMode) it.labelMode = "name";
      if(typeof it.labelScale !== "number") it.labelScale = 1.0;
      if(typeof it.scale !== "number") it.scale = 1.0;
      if(typeof it.rot !== "number") it.rot = 0;
      if(typeof it.z !== "number") it.z = ++state.zCounter;
      if(typeof it.wFt !== "number") it.wFt = 2.5;
      if(typeof it.hFt !== "number") it.hFt = 1.5;
      if(typeof it.xFt !== "number") it.xFt = 0;
      if(typeof it.yFt !== "number") it.yFt = 0;
    });

    // apply
    state.version = APP_VERSION;
    state.stage = { wFt: clamp(next.stage.wFt ?? 24, 8, 60), hFt: clamp(next.stage.hFt ?? 14, 6, 40) };
    state.viewZoom = clamp(next.viewZoom ?? 1.0, 0.6, 1.6);
    state.showGrid = !!(next.showGrid ?? true);
    state.showNotes = next.showNotes ?? "";
    state.items = next.items;
    state.selection = [];
    state.zCounter = Math.max(1, ...state.items.map(i => i.z || 1)) + 1;

    constrainAllToStage();
    save();
    render();
  }

  // ------------------ Save / Load ------------------
  function save(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }catch(e){
      // ignore
    }
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const incoming = JSON.parse(raw);
      importState(incoming);
    }catch(e){
      // ignore
    }
  }

  // ------------------ Color helper ------------------
  function hexToRgba(hex, a){
    if(!hex) return `rgba(255,255,255,${a})`;
    const h = hex.replace("#","").trim();
    const is3 = h.length === 3;
    const r = parseInt(is3 ? h[0]+h[0] : h.slice(0,2), 16);
    const g = parseInt(is3 ? h[1]+h[1] : h.slice(2,4), 16);
    const b = parseInt(is3 ? h[2]+h[2] : h.slice(4,6), 16);
    return `rgba(${r},${g},${b},${a})`;
  }

  // ------------------ Init ------------------
  buildLibrary();
  buildIconSelect();

  // defaults UI
  iScale.value = 1.0;
  iScaleVal.textContent = "1.00x";
  iLabelScale.value = 1.0;
  iLabelScaleVal.textContent = "1.00x";

  // load autosave if present, else start clean
  load();
  if(state.items.length === 0){
    // add a couple starters
    addItem(LIB[0]);
    addItem(LIB[1]);
    // restore selection on first item
    state.selection = [state.items[0].id];
    save();
  }
  render();
})();
</script>
</body>
</html>

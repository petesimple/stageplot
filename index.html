<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0d12" />
  <title>StagePlot v2</title>

  <style>
    :root{
      --bg:#0b0d12;
      --panel:#121826;
      --panel2:#0f1420;
      --line:#26324a;
      --text:#e9eefb;
      --muted:#a9b4cc;
      --accent:#4aa3ff;
      --ok:#40d98a;
      --warn:#ffcc66;
      --danger:#ff5a6a;
      --grid:rgba(255,255,255,.06);

      --stageBg:#0f1420;
      --stageBorder:rgba(255,255,255,.10);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 700px at 50% -10%, #1a2540, var(--bg));
      color: var(--text);
      line-height: 1.35;
      overflow-x:hidden;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 20;
      border-bottom: 1px solid var(--line);
      background: rgba(10,12,18,.75);
      backdrop-filter: blur(10px);
    }
    .wrap{
      max-width: 1280px;
      margin: 0 auto;
      padding: 12px 14px;
    }
    .top{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 240px;
    }
    .logo{
      width:32px; height:32px;
      border-radius:12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--accent);
      font-weight: 900;
      user-select:none;
    }
    .titleBlock{ display:flex; flex-direction:column; gap:2px; }
    h1{
      font-size: 16px;
      margin: 0;
      letter-spacing: .2px;
    }
    .sub{
      font-size: 12px;
      color: var(--muted);
      margin:0;
    }

    .actions{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    button, a.button{
      font: inherit;
      color: var(--text);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 8px 10px;
      text-decoration:none;
      cursor:pointer;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    button:hover, a.button:hover{ border-color: rgba(74,163,255,.8); }
    button:active, a.button:active{ transform: translateY(1px); }
    .primary{
      background: rgba(74,163,255,.14);
      border-color: rgba(74,163,255,.55);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background: var(--ok); display:inline-block; }

    /* Layout */
    .app{
      max-width: 1280px;
      margin: 0 auto;
      padding: 14px;
      display:grid;
      grid-template-columns: 330px 1fr 360px;
      gap: 12px;
      align-items:start;
    }

    .card{
      background: linear-gradient(180deg, rgba(18,24,38,.9), rgba(12,16,26,.9));
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .card .hd h2{
      margin:0;
      font-size: 13px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .3px;
      font-weight: 800;
    }
    .card .bd{
      padding: 12px 14px 14px 14px;
    }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row.tight{ gap:8px; }
    .row.between{ justify-content:space-between; }
    .muted{ color: var(--muted); }
    .small{ font-size: 12px; color: var(--muted); }
    .sep{
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 12px 0;
      border:0;
    }

    label{
      font-size: 12px;
      color: var(--muted);
      display:block;
      margin-bottom: 4px;
    }
    input[type="text"], input[type="number"], select, textarea{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline: none;
      font: inherit;
    }
    input[type="number"]{ appearance:textfield; }
    textarea{ min-height: 84px; resize: vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(74,163,255,.75);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }

    .miniBtn{
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      color: var(--text);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
    }
    .miniBtn:hover{ border-color: rgba(74,163,255,.7); }
    .miniBtn.primary{ border-color: rgba(74,163,255,.55); background: rgba(74,163,255,.14); }
    .miniBtn.danger{ border-color: rgba(255,90,106,.55); background: rgba(255,90,106,.12); }
    .miniBtn.ok{ border-color: rgba(64,217,138,.40); background: rgba(64,217,138,.10); }

    /* Stage area */
    .stageShell{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* The square viewport */
    .stageViewport{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius: 18px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      position:relative;
    }

    .stageCanvas{
      position:absolute;
      inset: 10px;
      border-radius: 14px;
      background: var(--stageBg);
      border: 1px solid var(--stageBorder);
      overflow:hidden;
    }

    .gridOverlay{
      position:absolute;
      inset:0;
      background-image:
        linear-gradient(var(--grid) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid) 1px, transparent 1px);
      background-size: 24px 24px;
      opacity: .55;
      pointer-events:none;
    }

    /* Inner stage world that we can zoom/pan inside the fixed square */
    .stageWorld{
      position:absolute;
      inset:0;
      transform-origin: 50% 50%;
      touch-action: none;
    }

    .stageLabel{
      position:absolute;
      left: 12px;
      top: 10px;
      font-size: 12px;
      color: rgba(233,238,251,.92);
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(6px);
      user-select:none;
      pointer-events:none;
    }

    .audienceTag{
      position:absolute;
      left: 50%;
      bottom: 10px;
      transform: translateX(-50%);
      font-size: 11px;
      color: rgba(233,238,251,.85);
      padding: 5px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      user-select:none;
      pointer-events:none;
    }

    /* Item tokens */
    .item{
      position:absolute;
      min-width: 72px;
      min-height: 44px;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      cursor: grab;
      user-select:none;
      touch-action:none;
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:center;
      justify-content:center;
      text-align:center;
    }
    .item:active{ cursor: grabbing; }
    .item .name{ font-weight: 800; font-size: 12px; }
    .item .meta{ font-size: 11px; color: rgba(233,238,251,.80); }
    .item.selected{
      border-color: rgba(74,163,255,.85);
      box-shadow: 0 0 0 2px rgba(74,163,255,.20), 0 14px 22px rgba(0,0,0,.35);
    }

    /* Mobile */
    .accordionBtn{
      display:none;
      width:100%;
      justify-content:space-between;
    }
    .accBody{ display:block; }

    @media (max-width: 1080px){
      .app{
        grid-template-columns: 1fr;
      }
      .accordionBtn{ display:flex; }
      .accBody{ display:none; }
      .accBody.open{ display:block; }
      .card{ border-radius: 18px; }
    }

    /* Sliders */
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }

    .kbd{
      display:inline-flex;
      align-items:center;
      padding: 2px 8px;
      border-radius: 10px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 12px;
      color: rgba(233,238,251,.92);
      white-space:nowrap;
      margin: 0 2px;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(18,24,38,.92);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      z-index: 50;
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease;
      font-size: 13px;
      max-width: 92vw;
    }
    .toast.show{ opacity: 1; }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="top">
        <div class="brand">
          <div class="logo" aria-hidden="true">SP</div>
          <div class="titleBlock">
            <h1>StagePlot v2</h1>
            <p class="sub">v1.5.5 (metric) - fast stage plots, no spreadsheet punishment</p>
          </div>
        </div>

        <div class="actions">
          <span class="pill"><span class="dot"></span>Autosave on</span>
          <a class="button" href="./guide.html">Guide</a>
          <button class="primary" id="printBtn">Print</button>
          <button id="exportBtn">Export Project</button>
          <button id="importBtn">Import Project</button>
          <input id="importFile" type="file" accept="application/json" style="display:none;" />
        </div>
      </div>
    </div>
  </header>

  <div class="app">
    <!-- LEFT: STAGE + TOOLS (layout at top; tools below) -->
    <section class="card" id="stageCard">
      <div class="hd">
        <h2>Stage</h2>
        <button class="accordionBtn" type="button" data-acc="stageAcc">
          Stage controls <span class="muted">tap</span>
        </button>
      </div>
      <div class="bd accBody open" id="stageAcc">

        <!-- Stage layout ALWAYS first -->
        <div class="row between">
          <div>
            <div style="font-weight:800;">Stage layout</div>
            <div class="small">Width x Depth in <span id="unitWord">ft</span></div>
          </div>
          <div class="pill"><span class="dot"></span><span id="unitPill">Feet</span></div>
        </div>

        <div class="grid3" style="margin-top:10px;">
          <button class="miniBtn" type="button" data-preset="small">Small</button>
          <button class="miniBtn" type="button" data-preset="medium">Medium</button>
          <button class="miniBtn" type="button" data-preset="large">Large</button>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div>
            <label for="stageW">Width (<span class="unitShort">ft</span>)</label>
            <input id="stageW" type="number" min="1" step="0.1" />
          </div>
          <div>
            <label for="stageD">Depth (<span class="unitShort">ft</span>)</label>
            <input id="stageD" type="number" min="1" step="0.1" />
          </div>
        </div>

        <div class="row tight" style="margin-top:10px;">
          <button class="miniBtn" type="button" id="flipBtn">Toggle Audience View</button>
          <button class="miniBtn danger" type="button" id="clearBtn">Clear All</button>
        </div>

        <hr class="sep" />

        <!-- Tools BELOW layout -->
        <div style="font-weight:800; margin-bottom:6px;">Tools</div>

        <div class="grid2">
          <div>
            <label for="unitsSel">Units</label>
            <select id="unitsSel">
              <option value="ft">Feet</option>
              <option value="m">Meters</option>
            </select>
            <div class="small" style="margin-top:6px;">
              This changes stage size + nudges + labels.
            </div>
          </div>
          <div>
            <label for="viewZoom">View Zoom (<span id="viewZoomVal">100%</span>)</label>
            <input id="viewZoom" type="range" min="50" max="180" step="1" value="100" />
            <div class="row tight" style="margin-top:8px;">
              <button class="miniBtn ok" type="button" id="resetViewBtn">Reset View (100%)</button>
            </div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <div class="small">
            Tip: Scale changes an item. View Zoom changes your “camera” inside the stage square.
          </div>
        </div>

      </div>
    </section>

    <!-- CENTER: STAGE CANVAS -->
    <section class="stageShell">
      <div class="stageViewport" aria-label="Stage viewport">
        <div class="stageCanvas" id="stageCanvas">
          <div class="gridOverlay"></div>
          <div class="stageLabel" id="stageDims">Stage 24 x 16 ft</div>
          <div class="audienceTag" id="audTag">Audience</div>

          <div class="stageWorld" id="stageWorld">
            <!-- items live here -->
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>Quick add</h2>
          <span class="pill"><span class="dot"></span>Tap to drop</span>
        </div>
        <div class="bd">
          <div class="grid3">
            <button class="miniBtn primary" type="button" data-add="Vocal">+ Vocal</button>
            <button class="miniBtn primary" type="button" data-add="Guitar">+ Guitar</button>
            <button class="miniBtn primary" type="button" data-add="Keys">+ Keys</button>
          </div>
          <div class="grid3" style="margin-top:10px;">
            <button class="miniBtn" type="button" data-add="Bass">+ Bass</button>
            <button class="miniBtn" type="button" data-add="Drums">+ Drums</button>
            <button class="miniBtn" type="button" data-add="Wedge">+ Wedge</button>
          </div>
          <div class="grid3" style="margin-top:10px;">
            <button class="miniBtn" type="button" data-add="Mic">+ Mic</button>
            <button class="miniBtn" type="button" data-add="DI">+ DI</button>
            <button class="miniBtn" type="button" data-add="Power">+ Power</button>
          </div>
          <div class="grid3" style="margin-top:10px;">
            <button class="miniBtn" type="button" data-add="Amp">+ Amp</button>
            <button class="miniBtn" type="button" data-add="IEM">+ IEM</button>
            <button class="miniBtn" type="button" data-add="Misc">+ Misc</button>
          </div>
          <div class="small" style="margin-top:10px;">
            Want more item types? We can wire back the full library panel anytime - keeping this build lean for v1.5.x.
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: ONE-PAGE INFO -->
    <section class="card" id="infoCard">
      <div class="hd">
        <h2>One-page info</h2>
        <button class="accordionBtn" type="button" data-acc="infoAcc">
          Info panel <span class="muted">tap</span>
        </button>
      </div>
      <div class="bd accBody open" id="infoAcc">
        <div class="grid2">
          <div>
            <label for="bandName">Band / Act name</label>
            <input id="bandName" type="text" placeholder="Optional" />
          </div>
          <div>
            <label for="showDate">Show date</label>
            <input id="showDate" type="text" placeholder="Optional" />
          </div>
        </div>

        <hr class="sep" />

        <div class="row between">
          <div>
            <div style="font-weight:800;">Selected item</div>
            <div class="small" id="selHint">Tap an item on the stage</div>
          </div>
          <button class="miniBtn" type="button" id="dupBtn">Duplicate</button>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div>
            <label for="itemLabel">Label</label>
            <input id="itemLabel" type="text" placeholder="e.g., Pete Vox" />
          </div>
          <div>
            <label for="itemType">Type</label>
            <input id="itemType" type="text" placeholder="e.g., Vocal" />
          </div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div>
            <label for="itemInput">Input</label>
            <input id="itemInput" type="text" placeholder="e.g., Ch 1 / DI" />
          </div>
          <div>
            <label for="itemMix">Mix</label>
            <input id="itemMix" type="text" placeholder="e.g., M1 / IEM" />
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="itemNotes">Item notes</label>
          <textarea id="itemNotes" placeholder="boom stand, DI after pedals, phantom power..."></textarea>
        </div>

        <div style="margin-top:10px;">
          <label for="itemScale">Scale (<span id="itemScaleVal">100%</span>)</label>
          <input id="itemScale" type="range" min="60" max="180" step="1" value="100" />
        </div>

        <div class="row tight" style="margin-top:10px;">
          <button class="miniBtn" type="button" id="centerBtn">Center item</button>
          <button class="miniBtn danger" type="button" id="delBtn">Delete</button>
        </div>

        <hr class="sep" />

        <div>
          <label for="showNotes">Show notes (prints)</label>
          <textarea id="showNotes" placeholder="load-in, parking, contact, backline, set length..."></textarea>
        </div>

        <div class="small" style="margin-top:10px;">
          Nudges: <span class="kbd">Shift</span> + <span class="kbd">Arrow</span> uses 0.25 (ft) or 0.1 (m).
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /**********************
     * v1.5.5 (metric)
     * - Units toggle (ft/m)
     * - Stage layout always top; tools below (this change)
     * - View Zoom inside fixed square viewport
     * - Basic stage items + one-page info
     **********************/

    // ---- constants ----
    const VERSION = "1.5.5 (metric)";
    const LS_KEY = "stageplot_v2_project";
    const LS_UI  = "stageplot_v2_ui";

    // Presets defined in FEET (we convert if in meters)
    const PRESETS_FT = {
      small:  { w: 20, d: 14 },
      medium: { w: 24, d: 16 },
      large:  { w: 32, d: 20 }
    };

    // Unit conversions
    const FT_TO_M = 0.3048;
    const M_TO_FT = 1 / FT_TO_M;

    // Nudges
    const NUDGE_FT = 0.25;
    const NUDGE_M  = 0.10;

    // ---- state ----
    let state = {
      units: "ft",       // "ft" | "m"
      stageW: 24,        // in current units
      stageD: 16,        // in current units
      flipped: false,
      viewZoom: 100,     // percent
      bandName: "",
      showDate: "",
      showNotes: "",
      items: [],
      selectedId: null
    };

    // item model:
    // { id, type, label, input, mix, notes, x, y, w, h, scale }
    // x/y/w/h stored as normalized (0..1) of stage width/depth (unit-agnostic)

    // ---- DOM ----
    const stageWEl = document.getElementById("stageW");
    const stageDEl = document.getElementById("stageD");
    const stageDimsEl = document.getElementById("stageDims");
    const stageWorld = document.getElementById("stageWorld");
    const stageCanvas = document.getElementById("stageCanvas");
    const audTag = document.getElementById("audTag");

    const unitsSel = document.getElementById("unitsSel");
    const unitPill = document.getElementById("unitPill");
    const unitWord = document.getElementById("unitWord");
    const unitShortEls = document.querySelectorAll(".unitShort");

    const viewZoomEl = document.getElementById("viewZoom");
    const viewZoomValEl = document.getElementById("viewZoomVal");
    const resetViewBtn = document.getElementById("resetViewBtn");

    const flipBtn = document.getElementById("flipBtn");
    const clearBtn = document.getElementById("clearBtn");

    const bandNameEl = document.getElementById("bandName");
    const showDateEl = document.getElementById("showDate");
    const showNotesEl = document.getElementById("showNotes");

    const selHint = document.getElementById("selHint");
    const itemLabelEl = document.getElementById("itemLabel");
    const itemTypeEl = document.getElementById("itemType");
    const itemInputEl = document.getElementById("itemInput");
    const itemMixEl = document.getElementById("itemMix");
    const itemNotesEl = document.getElementById("itemNotes");
    const itemScaleEl = document.getElementById("itemScale");
    const itemScaleValEl = document.getElementById("itemScaleVal");

    const dupBtn = document.getElementById("dupBtn");
    const delBtn = document.getElementById("delBtn");
    const centerBtn = document.getElementById("centerBtn");

    const printBtn = document.getElementById("printBtn");
    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");
    const importFile = document.getElementById("importFile");

    const toastEl = document.getElementById("toast");

    // Accordions on mobile
    document.querySelectorAll(".accordionBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-acc");
        const body = document.getElementById(id);
        body.classList.toggle("open");
        saveUI();
      });
    });

    function saveUI(){
      const ui = {
        stageOpen: document.getElementById("stageAcc").classList.contains("open"),
        infoOpen: document.getElementById("infoAcc").classList.contains("open"),
      };
      localStorage.setItem(LS_UI, JSON.stringify(ui));
    }
    function loadUI(){
      try{
        const ui = JSON.parse(localStorage.getItem(LS_UI) || "null");
        if(!ui) return;
        document.getElementById("stageAcc").classList.toggle("open", !!ui.stageOpen);
        document.getElementById("infoAcc").classList.toggle("open", !!ui.infoOpen);
      }catch(e){}
    }

    // ---- helpers ----
    const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }

    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    function round1(v){ return Math.round(v * 10) / 10; }

    function unitLabel(){
      return state.units === "m" ? "m" : "ft";
    }

    function setUnitsUI(){
      unitsSel.value = state.units;
      const isM = state.units === "m";
      unitPill.textContent = isM ? "Meters" : "Feet";
      unitWord.textContent = isM ? "m" : "ft";
      unitShortEls.forEach(el => el.textContent = isM ? "m" : "ft");
      renderStageDims();
      renderNudgeHint();
    }

    function renderNudgeHint(){
      // we only show in text - already placed in UI, but could be expanded later
    }

    function renderStageDims(){
      stageWEl.value = state.stageW;
      stageDEl.value = state.stageD;
      stageDimsEl.textContent = `Stage ${state.stageW} x ${state.stageD} ${unitLabel()}`;
      audTag.textContent = state.flipped ? "Stage" : "Audience";
    }

    function applyViewZoom(){
      const z = state.viewZoom / 100;
      stageWorld.style.transform = `scale(${z}) rotate(${state.flipped ? 180 : 0}deg)`;
      viewZoomEl.value = state.viewZoom;
      viewZoomValEl.textContent = `${state.viewZoom}%`;
    }

    function save(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }
    function load(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return;
        const parsed = JSON.parse(raw);
        if(parsed && parsed.items) state = parsed;
      }catch(e){}
    }

    // Convert current stageW/D when switching units
    function convertStageNumbers(toUnits){
      const from = state.units;
      if(from === toUnits) return;

      if(from === "ft" && toUnits === "m"){
        state.stageW = round1(state.stageW * FT_TO_M);
        state.stageD = round1(state.stageD * FT_TO_M);
      }else if(from === "m" && toUnits === "ft"){
        state.stageW = round1(state.stageW * M_TO_FT);
        state.stageD = round1(state.stageD * M_TO_FT);
      }
      state.units = toUnits;
    }

    function presetToCurrentUnits(p){
      if(state.units === "ft") return { w: p.w, d: p.d };
      return { w: round1(p.w * FT_TO_M), d: round1(p.d * FT_TO_M) };
    }

    // ---- Items / Rendering ----
    function defaultItemDims(type){
      // relative sizes (normalized)
      // Keeping simple: these are proportions of stage, tuned to look good.
      const map = {
        "Vocal":  { w: 0.12, h: 0.08 },
        "Guitar": { w: 0.14, h: 0.09 },
        "Keys":   { w: 0.16, h: 0.10 },
        "Bass":   { w: 0.14, h: 0.09 },
        "Drums":  { w: 0.18, h: 0.13 },
        "Wedge":  { w: 0.12, h: 0.07 },
        "Mic":    { w: 0.10, h: 0.06 },
        "DI":     { w: 0.10, h: 0.06 },
        "Power":  { w: 0.12, h: 0.07 },
        "Amp":    { w: 0.14, h: 0.09 },
        "IEM":    { w: 0.12, h: 0.07 },
        "Misc":   { w: 0.14, h: 0.09 },
      };
      return map[type] || { w: 0.14, h: 0.09 };
    }

    function addItem(type){
      const d = defaultItemDims(type);
      const id = uid();
      const item = {
        id,
        type,
        label: type,
        input: "",
        mix: "",
        notes: "",
        x: 0.5, y: 0.5,
        w: d.w, h: d.h,
        scale: 100
      };
      state.items.push(item);
      select(id);
      nudgeSelectedToVisible();
      save();
      render();
    }

    function getSelected(){
      return state.items.find(it => it.id === state.selectedId) || null;
    }

    function select(id){
      state.selectedId = id;
      const it = getSelected();
      if(!it){
        selHint.textContent = "Tap an item on the stage";
        itemLabelEl.value = "";
        itemTypeEl.value = "";
        itemInputEl.value = "";
        itemMixEl.value = "";
        itemNotesEl.value = "";
        itemScaleEl.value = 100;
        itemScaleValEl.textContent = "100%";
        return;
      }
      selHint.textContent = `Selected: ${it.label || it.type}`;
      itemLabelEl.value = it.label || "";
      itemTypeEl.value = it.type || "";
      itemInputEl.value = it.input || "";
      itemMixEl.value = it.mix || "";
      itemNotesEl.value = it.notes || "";
      itemScaleEl.value = it.scale || 100;
      itemScaleValEl.textContent = `${it.scale || 100}%`;
      save();
    }

    function deleteSelected(){
      if(!state.selectedId) return;
      state.items = state.items.filter(it => it.id !== state.selectedId);
      state.selectedId = null;
      select(null);
      save();
      render();
    }

    function duplicateSelected(){
      const it = getSelected();
      if(!it) return;
      const copy = JSON.parse(JSON.stringify(it));
      copy.id = uid();
      copy.x = clamp(copy.x + 0.04, 0.08, 0.92);
      copy.y = clamp(copy.y + 0.04, 0.08, 0.92);
      state.items.push(copy);
      select(copy.id);
      save();
      render();
    }

    function centerSelected(){
      const it = getSelected();
      if(!it) return;
      it.x = 0.5;
      it.y = 0.5;
      save();
      render();
    }

    function nudgeSelectedToVisible(){
      const it = getSelected();
      if(!it) return;
      it.x = clamp(it.x, 0.08, 0.92);
      it.y = clamp(it.y, 0.08, 0.92);
    }

    function render(){
      renderStageDims();
      setUnitsUI();
      applyViewZoom();

      stageWorld.innerHTML = "";
      const rect = stageWorld.getBoundingClientRect();

      // stageWorld uses absolute coords within stageCanvas; items positioned as percentage
      state.items.forEach(it => {
        const el = document.createElement("div");
        el.className = "item" + (it.id === state.selectedId ? " selected" : "");
        el.setAttribute("data-id", it.id);

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = it.label || it.type || "Item";

        const meta = document.createElement("div");
        meta.className = "meta";
        const bits = [];
        if(it.input) bits.push(it.input);
        if(it.mix) bits.push(it.mix);
        meta.textContent = bits.join(" • ");

        el.appendChild(name);
        el.appendChild(meta);

        // size/pos
        const sc = (it.scale || 100) / 100;
        const w = (it.w * sc) * 100;
        const h = (it.h * sc) * 100;

        el.style.left = `${it.x * 100}%`;
        el.style.top  = `${it.y * 100}%`;
        el.style.width  = `${w}%`;
        el.style.height = `${h}%`;
        el.style.transform = "translate(-50%, -50%)";

        // pointer events
        el.addEventListener("pointerdown", onItemPointerDown);

        el.addEventListener("click", (e) => {
          e.stopPropagation();
          select(it.id);
          render(); // update selection highlight
        });

        stageWorld.appendChild(el);
      });
    }

    // ---- Dragging ----
    let drag = null;

    function onItemPointerDown(e){
      const id = e.currentTarget.getAttribute("data-id");
      select(id);
      render();

      const it = getSelected();
      if(!it) return;

      e.currentTarget.setPointerCapture(e.pointerId);

      const worldRect = stageWorld.getBoundingClientRect();
      const px = e.clientX - worldRect.left;
      const py = e.clientY - worldRect.top;

      drag = {
        id,
        startX: it.x,
        startY: it.y,
        startPX: px,
        startPY: py,
        worldW: worldRect.width,
        worldH: worldRect.height,
        pointerId: e.pointerId
      };

      window.addEventListener("pointermove", onPointerMove);
      window.addEventListener("pointerup", onPointerUp, { once:true });
    }

    function onPointerMove(e){
      if(!drag) return;
      const it = getSelected();
      if(!it) return;

      const worldRect = stageWorld.getBoundingClientRect();
      const px = e.clientX - worldRect.left;
      const py = e.clientY - worldRect.top;

      const dx = (px - drag.startPX) / worldRect.width;
      const dy = (py - drag.startPY) / worldRect.height;

      it.x = clamp(drag.startX + dx, 0.04, 0.96);
      it.y = clamp(drag.startY + dy, 0.04, 0.96);
      render();
      save();
    }

    function onPointerUp(){
      window.removeEventListener("pointermove", onPointerMove);
      drag = null;
    }

    // ---- Events ----
    // click empty stage to clear selection
    stageCanvas.addEventListener("click", () => {
      state.selectedId = null;
      select(null);
      render();
      save();
    });

    // stage inputs
    stageWEl.addEventListener("input", () => {
      state.stageW = clamp(parseFloat(stageWEl.value || "1"), 1, 9999);
      renderStageDims();
      save();
    });
    stageDEl.addEventListener("input", () => {
      state.stageD = clamp(parseFloat(stageDEl.value || "1"), 1, 9999);
      renderStageDims();
      save();
    });

    // presets
    document.querySelectorAll("[data-preset]").forEach(b => {
      b.addEventListener("click", () => {
        const key = b.getAttribute("data-preset");
        const p = PRESETS_FT[key];
        const v = presetToCurrentUnits(p);
        state.stageW = v.w;
        state.stageD = v.d;
        toast(`Stage preset: ${key}`);
        save();
        render();
      });
    });

    // tools
    unitsSel.addEventListener("change", () => {
      const to = unitsSel.value;
      convertStageNumbers(to);
      toast(`Units: ${to === "m" ? "meters" : "feet"}`);
      save();
      render();
    });

    viewZoomEl.addEventListener("input", () => {
      state.viewZoom = parseInt(viewZoomEl.value, 10);
      applyViewZoom();
      save();
    });

    resetViewBtn.addEventListener("click", () => {
      state.viewZoom = 100;
      applyViewZoom();
      save();
      toast("View reset to 100%");
    });

    flipBtn.addEventListener("click", () => {
      state.flipped = !state.flipped;
      applyViewZoom();
      save();
      toast(state.flipped ? "Audience View" : "Stage View");
    });

    clearBtn.addEventListener("click", () => {
      if(!confirm("Clear everything? This removes all items and notes.")) return;
      state.items = [];
      state.selectedId = null;
      state.bandName = "";
      state.showDate = "";
      state.showNotes = "";
      bandNameEl.value = "";
      showDateEl.value = "";
      showNotesEl.value = "";
      select(null);
      save();
      render();
      toast("Cleared");
    });

    // quick add
    document.querySelectorAll("[data-add]").forEach(b => {
      b.addEventListener("click", (e) => {
        e.preventDefault();
        addItem(b.getAttribute("data-add"));
      });
    });

    // info fields
    bandNameEl.addEventListener("input", () => { state.bandName = bandNameEl.value; save(); });
    showDateEl.addEventListener("input", () => { state.showDate = showDateEl.value; save(); });
    showNotesEl.addEventListener("input", () => { state.showNotes = showNotesEl.value; save(); });

    itemLabelEl.addEventListener("input", () => {
      const it = getSelected(); if(!it) return;
      it.label = itemLabelEl.value;
      save(); render();
    });
    itemTypeEl.addEventListener("input", () => {
      const it = getSelected(); if(!it) return;
      it.type = itemTypeEl.value;
      save(); render();
    });
    itemInputEl.addEventListener("input", () => {
      const it = getSelected(); if(!it) return;
      it.input = itemInputEl.value;
      save(); render();
    });
    itemMixEl.addEventListener("input", () => {
      const it = getSelected(); if(!it) return;
      it.mix = itemMixEl.value;
      save(); render();
    });
    itemNotesEl.addEventListener("input", () => {
      const it = getSelected(); if(!it) return;
      it.notes = itemNotesEl.value;
      save();
    });

    itemScaleEl.addEventListener("input", () => {
      const it = getSelected(); if(!it) return;
      it.scale = parseInt(itemScaleEl.value, 10);
      itemScaleValEl.textContent = `${it.scale}%`;
      save(); render();
    });

    dupBtn.addEventListener("click", duplicateSelected);
    delBtn.addEventListener("click", deleteSelected);
    centerBtn.addEventListener("click", centerSelected);

    // keyboard nudges
    window.addEventListener("keydown", (e) => {
      if(!(e.shiftKey && ["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(e.key))) return;
      const it = getSelected();
      if(!it) return;
      e.preventDefault();

      const step = (state.units === "m") ? NUDGE_M : NUDGE_FT;
      // Convert "real" nudge into normalized delta relative to stage size
      const dx = step / state.stageW;
      const dy = step / state.stageD;

      if(e.key === "ArrowLeft")  it.x -= dx;
      if(e.key === "ArrowRight") it.x += dx;
      if(e.key === "ArrowUp")    it.y -= dy;
      if(e.key === "ArrowDown")  it.y += dy;

      it.x = clamp(it.x, 0.04, 0.96);
      it.y = clamp(it.y, 0.04, 0.96);

      save();
      render();
    });

    // export/import
    exportBtn.addEventListener("click", () => {
      const payload = {
        version: VERSION,
        exportedAt: new Date().toISOString(),
        state
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
      const a = document.createElement("a");
      const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
      a.href = URL.createObjectURL(blob);
      a.download = `StagePlot_project_${stamp}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
      toast("Exported project JSON");
    });

    importBtn.addEventListener("click", () => importFile.click());

    importFile.addEventListener("change", async () => {
      const file = importFile.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);

        // Accept either raw state or wrapped payload
        const next = data.state && data.state.items ? data.state : data;
        if(!next || !next.items) throw new Error("Invalid project format.");

        state = next;

        // Refresh form fields
        bandNameEl.value = state.bandName || "";
        showDateEl.value = state.showDate || "";
        showNotesEl.value = state.showNotes || "";

        select(state.selectedId || null);
        save();
        render();
        toast("Imported project");
      }catch(err){
        alert("Could not import that file. Make sure it is a StagePlot project JSON.");
      }finally{
        importFile.value = "";
      }
    });

    // printing (simple: let browser print)
    printBtn.addEventListener("click", () => {
      toast("Opening print...");
      setTimeout(() => window.print(), 100);
    });

    // ---- init ----
    loadUI();
    load();

    // Ensure defaults present
    if(!state.units) state.units = "ft";
    if(!state.stageW) state.stageW = 24;
    if(!state.stageD) state.stageD = 16;
    if(!state.viewZoom) state.viewZoom = 100;
    if(!Array.isArray(state.items)) state.items = [];

    // bind UI from state
    bandNameEl.value = state.bandName || "";
    showDateEl.value = state.showDate || "";
    showNotesEl.value = state.showNotes || "";
    viewZoomEl.value = state.viewZoom || 100;

    select(state.selectedId || null);
    render();
    save();
  </script>
</body>
</html>
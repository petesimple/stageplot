<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0d12" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" href="stageplotlogo.png" />
  <title>StagePlot v2 - v1.5.5 (metric)</title>

  <style>
    :root{
      --bg:#0b0d12;
      --panel:#121826;
      --panel2:#0f1420;
      --line:#26324a;
      --text:#e9eefb;
      --muted:#a9b4cc;
      --accent:#4aa3ff;
      --ok:#40d98a;
      --warn:#ffcc66;
      --danger:#ff5a6a;
      --grid:rgba(255,255,255,.06);

      --stageBorder:rgba(255,255,255,.14);
      --stageFill:rgba(255,255,255,.03);
      --sel:rgba(74,163,255,.9);
      --handle:rgba(74,163,255,.95);

      --pillBg:rgba(255,255,255,.06);
      --btnBg:rgba(255,255,255,.06);
      --btnBd:rgba(255,255,255,.12);
      --btnBdHover:rgba(74,163,255,.75);

      --shadow:0 12px 30px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 700px at 50% -10%, #1a2540, var(--bg));
      color: var(--text);
      line-height:1.35;
    }

    header{
      position: sticky;
      top:0;
      z-index: 30;
      border-bottom:1px solid var(--line);
      background: rgba(10,12,18,.75);
      backdrop-filter: blur(10px);
    }

    .wrap{
      max-width: 1280px;
      margin: 0 auto;
      padding: 12px 14px;
    }

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .title{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 260px;
    }

    .logo{
      width:30px; height:30px;
      border-radius:10px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--accent);
      font-weight: 900;
      user-select:none;
    }

    .title h1{
      margin:0;
      font-size: 15px;
      letter-spacing:.2px;
    }
    .sub{
      margin-top:2px;
      color: var(--muted);
      font-size: 12px;
    }

    .actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: var(--pillBg);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background: var(--ok); display:inline-block; }

    a.button, button{
      font: inherit;
      color: var(--text);
      background: var(--btnBg);
      border: 1px solid var(--btnBd);
      border-radius: 12px;
      padding: 8px 10px;
      text-decoration:none;
      cursor:pointer;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    a.button:hover, button:hover{ border-color: var(--btnBdHover); }
    a.button:active, button:active{ transform: translateY(1px); }
    a.button.primary{
      background: rgba(74,163,255,.14);
      border-color: rgba(74,163,255,.55);
    }

    .layout{
      max-width: 1280px;
      margin: 0 auto;
      padding: 12px 14px 24px 14px;
      display:grid;
      grid-template-columns: 320px 1fr 360px;
      gap: 12px;
      align-items:start;
    }

    .card{
      background: linear-gradient(180deg, rgba(18,24,38,.9), rgba(12,16,26,.9));
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      min-width: 0;
    }
    .card .hd{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .card .hd h2{
      margin:0;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .35px;
      font-weight: 780;
    }
    .card .bd{ padding: 10px 12px 12px 12px; }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row.tight{ gap:8px; }
    .row + .row{ margin-top: 10px; }

    label.small{
      color: var(--muted);
      font-size: 12px;
      display:block;
      margin-bottom:6px;
    }

    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline:none;
      font: inherit;
    }
    textarea{ min-height: 84px; resize: vertical; }

    .split2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .split3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

    .hint{
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
    }

    .hr{
      border:0;
      border-top:1px solid rgba(255,255,255,.08);
      margin: 12px 0;
    }

    .kbd{
      display:inline-flex;
      align-items:center;
      padding: 2px 8px;
      border-radius: 10px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 12px;
      color: rgba(233,238,251,.92);
      white-space:nowrap;
      margin: 0 2px;
    }

    /* Stage area */
    .stageShell{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .stageMeta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .stageMeta .muted{ color: var(--muted); font-size: 12px; }
    .stageMeta .tag{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }

    .stageSquare{
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      position: relative;
      box-shadow: 0 10px 24px rgba(0,0,0,.28) inset;
    }

    .stageViewport{
      position:absolute;
      inset: 10px;
      border-radius: 14px;
      border: 1px solid var(--stageBorder);
      background: var(--stageFill);
      overflow:hidden; /* important - zoom inside square */
    }

    .stageInner{
      position:absolute;
      left:50%;
      top:50%;
      transform-origin: center center;
      /* transform set by JS */
    }

    .stageGrid{
      position:absolute;
      inset: 0;
      background-image:
        linear-gradient(to right, var(--grid) 1px, transparent 1px),
        linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
      background-size: 32px 32px;
      pointer-events:none;
      opacity:.7;
    }

    .stageLabelTop, .stageLabelBottom{
      position:absolute;
      left:0;
      right:0;
      text-align:center;
      color: rgba(233,238,251,.85);
      font-size: 12px;
      pointer-events:none;
      text-shadow: 0 2px 8px rgba(0,0,0,.45);
      user-select:none;
    }
    .stageLabelTop{ top: 8px; }
    .stageLabelBottom{ bottom: 8px; }

    .item{
      position:absolute;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.08);
      box-shadow: 0 6px 14px rgba(0,0,0,.25);
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 6px;
      user-select:none;
      cursor: grab;
      transform-origin: center center;
    }
    .item:active{ cursor: grabbing; }

    .item .lbl{
      font-size: 12px;
      line-height: 1.1;
      font-weight: 700;
      letter-spacing:.1px;
      text-shadow: 0 2px 10px rgba(0,0,0,.35);
      max-width: 100%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .item .subLbl{
      font-size: 10px;
      opacity:.9;
      margin-top:2px;
      color: rgba(233,238,251,.92);
    }

    .item.selected{
      outline: 2px solid var(--sel);
      outline-offset: 2px;
    }

    .handles{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .handle{
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--handle);
      box-shadow: 0 4px 10px rgba(0,0,0,.35);
      position:absolute;
      pointer-events:auto;
      cursor: nwse-resize;
    }
    .handle.br{ right:-6px; bottom:-6px; }
    .rotateDot{
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(64,217,138,.95);
      position:absolute;
      left: 50%;
      top: -18px;
      transform: translateX(-50%);
      pointer-events:auto;
      cursor: grab;
    }

    /* Library */
    .libSearch{ display:flex; gap:10px; align-items:center; }
    .libSearch input{ flex: 1; }

    .libList{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 56vh;
      overflow:auto;
      padding-right: 4px;
    }
    .libItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .libItem .name{ font-weight: 800; font-size: 13px; }
    .libItem .meta{ color: var(--muted); font-size: 12px; margin-top:2px; }

    .tiny{
      font-size: 12px;
      color: var(--muted);
    }

    .sliderRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    input[type="range"]{ width: 100%; }

    .badge{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }

    /* Mobile accordions */
    .accBtn{
      width:100%;
      justify-content:space-between;
    }
    .accIcon{
      opacity:.85;
      font-weight: 900;
    }

    @media (max-width: 1080px){
      .layout{
        grid-template-columns: 1fr;
      }
      .libList{ max-height: 34vh; }
    }

    @media print{
      header{ display:none !important; }
      body{ background:#fff !important; color:#000 !important; }
      .layout{ display:block !important; max-width: 7.8in !important; padding: 0 !important; }
      .card{ box-shadow:none !important; background:#fff !important; border:1px solid #ddd !important; }
      .card .hd{ border-bottom:1px solid #ddd !important; }
      .stageSquare{ border:1px solid #ddd !important; background:#fff !important; }
      .stageViewport{ border:1px solid #ddd !important; background:#fff !important; }
      .stageGrid{ display:none !important; }
      button, a.button{ display:none !important; }
      .libCard{ display:none !important; }
      .infoCard .hd .badge{ display:none !important; }
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="top">
        <div class="title">
          <div class="logo" aria-hidden="true">SP</div>
          <div>
            <h1>StagePlot v2</h1>
            <div class="sub">v1.5.5 (metric) - fast stage plots that do not feel like taxes</div>
          </div>
        </div>

        <div class="actions">
          <span class="pill"><span class="dot"></span>Autosave on</span>
          <a class="button" href="./guide.html">Guide</a>
          <button class="button primary" id="printBtn">Print</button>
          <button class="button" id="exportBtn">Export project</button>
          <button class="button" id="importBtn">Import project</button>
          <input id="importFile" type="file" accept="application/json" hidden />
        </div>
      </div>
    </div>
  </header>

  <div class="layout">
    <!-- LEFT: Stage + View -->
    <section class="card">
      <div class="hd">
        <h2>Stage and view</h2>
        <span class="badge" id="unitsBadge">Units: ft</span>
      </div>
      <div class="bd">
        <div class="split2">
          <div>
            <label class="small">Stage preset</label>
            <select id="stagePreset">
              <option value="small">Small (20 x 12)</option>
              <option value="medium" selected>Medium (24 x 16)</option>
              <option value="large">Large (32 x 20)</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div>
            <label class="small">Units</label>
            <select id="unitsSelect">
              <option value="ft" selected>Feet (ft)</option>
              <option value="m">Meters (m)</option>
            </select>
          </div>
        </div>

        <div class="split2" style="margin-top:10px;">
          <div>
            <label class="small" id="wLabel">Stage width (ft)</label>
            <input id="stageW" type="number" inputmode="decimal" step="0.1" min="1" value="24" />
          </div>
          <div>
            <label class="small" id="dLabel">Stage depth (ft)</label>
            <input id="stageD" type="number" inputmode="decimal" step="0.1" min="1" value="16" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="button" id="flipBtn">Flip stage / audience view</button>
          <button class="button" id="centerBtn">Center selection</button>
          <button class="button" id="dupBtn">Duplicate</button>
          <button class="button" id="delBtn">Delete</button>
        </div>

        <div class="hr"></div>

        <label class="small">View zoom (inside the square)</label>
        <div class="sliderRow">
          <input id="viewZoom" type="range" min="50" max="200" value="100" />
          <span class="pill" id="viewZoomVal">100%</span>
          <button class="button" id="resetViewBtn">Reset view</button>
        </div>
        <div class="hint">
          View Zoom changes your camera, not item sizes. The stage stays inside the square at 100%.
        </div>

        <div class="hr"></div>

        <div class="stageShell">
          <div class="stageMeta">
            <div class="muted" id="stageMetaText">Stage: 24 ft x 16 ft</div>
            <div class="tag" id="viewTag">Stage view</div>
          </div>

          <div class="stageSquare" id="stageSquare">
            <div class="stageViewport" id="stageViewport">
              <div class="stageGrid"></div>
              <div class="stageLabelTop" id="labelTop">UPSTAGE</div>
              <div class="stageLabelBottom" id="labelBottom">AUDIENCE</div>

              <div class="stageInner" id="stageInner">
                <!-- items inserted here -->
              </div>
            </div>
          </div>

          <div class="hint">
            Tips: Shift + Arrow nudges. Cmd/Ctrl + D duplicates. Click empty stage to clear selection.
          </div>
        </div>
      </div>
    </section>

    <!-- MIDDLE: Library -->
    <section class="card libCard" id="libCard">
      <div class="hd">
        <h2>Item library</h2>
        <span class="tiny">Search + add</span>
      </div>
      <div class="bd">
        <div class="libSearch">
          <input id="libSearch" type="text" placeholder="Search: vocal, guitar, keys, wedge, power, drums..." />
          <select id="libCat" style="width:140px;">
            <option value="all" selected>All</option>
            <option value="people">People</option>
            <option value="instruments">Instruments</option>
            <option value="stage">Stage gear</option>
            <option value="audio">Audio</option>
            <option value="power">Power</option>
            <option value="misc">Misc</option>
          </select>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="button" id="misc1">+ Misc 1</button>
          <button class="button" id="misc2">+ Misc 2</button>
          <button class="button" id="misc3">+ Misc 3</button>
        </div>

        <div class="hr"></div>

        <div class="libList" id="libList"></div>
      </div>
    </section>

    <!-- RIGHT: Info -->
    <section class="card infoCard">
      <div class="hd">
        <h2>One-page info</h2>
        <span class="badge" id="selBadge">No selection</span>
      </div>
      <div class="bd">
        <label class="small">Band name (optional)</label>
        <input id="bandName" type="text" placeholder="Example: Petesimple Trio" />

        <div class="hr"></div>

        <div id="selPanel" style="display:none;">
          <div class="split2">
            <div>
              <label class="small">Label</label>
              <input id="itLabel" type="text" placeholder="Example: Pete Vox" />
            </div>
            <div>
              <label class="small">Color</label>
              <input id="itColor" type="color" value="#4aa3ff" style="height:40px; padding:6px 8px;" />
            </div>
          </div>

          <div class="split2" style="margin-top:10px;">
            <div>
              <label class="small">Input</label>
              <input id="itInput" type="text" placeholder="Example: Ch 1" />
            </div>
            <div>
              <label class="small">Mix</label>
              <input id="itMix" type="text" placeholder="Example: M1" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="button" id="rotReset">Reset rotation</button>
            <button class="button" id="scaleReset">Reset scale</button>
          </div>

          <div style="margin-top:10px;">
            <label class="small">Scale (item footprint)</label>
            <div class="sliderRow">
              <input id="itScale" type="range" min="50" max="200" value="100" />
              <span class="pill" id="itScaleVal">100%</span>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label class="small">Notes</label>
            <textarea id="itNotes" placeholder="Boom stand, DI after pedals, phantom power, etc."></textarea>
          </div>

          <div class="hr"></div>
        </div>

        <label class="small">Show notes</label>
        <textarea id="showNotes" placeholder="Load-in, parking, contact, set length, backline notes..."></textarea>

        <div class="hr"></div>

        <div class="row">
          <button class="button" id="clearAllBtn">Reset project</button>
          <a class="button" href="https://petesimple.github.io/stageplot/" target="_blank" rel="noopener">Open live app</a>
        </div>

        <div class="hint">
          Export project makes a JSON file. Share it in text, email, or AirDrop. Import restores everything.
        </div>
      </div>
    </section>
  </div>

  <script>
    /* =========================================================
      StagePlot v1.5.5 (metric)
      - Adds unit toggle ft/m
      - Keeps internal storage in feet for backwards compatibility
      - Displays stage dims in selected units
      - Maintains "stage always fits inside the square at 100%" by:
        fitScale (auto) * viewZoom (user) inside a clipped viewport
    ========================================================= */

    const VERSION = "1.5.5 (metric)";
    const STORAGE_KEY = "stageplot_v2_project";
    const STORAGE_KEY_UI = "stageplot_v2_ui";

    // internal units are feet
    const FT_PER_M = 3.280839895;

    const DEFAULTS = {
      units: "ft",
      preset: "medium",
      stageWft: 24,
      stageDft: 16,
      audienceView: false,
      viewZoom: 100,
      bandName: "",
      showNotes: "",
      items: [],
      nextId: 1
    };

    const PRESETS_FT = {
      small:  { w: 20, d: 12 },
      medium: { w: 24, d: 16 },
      large:  { w: 32, d: 20 }
    };

    const LIB = [
      { id:"vocal", name:"Vocal", cat:"people", w:2.0, h:1.2, label:"Vox" },
      { id:"guitar", name:"Guitar", cat:"instruments", w:2.0, h:1.2, label:"Gtr" },
      { id:"bass", name:"Bass", cat:"instruments", w:2.0, h:1.2, label:"Bass" },
      { id:"keys", name:"Keys", cat:"instruments", w:2.4, h:1.4, label:"Keys" },
      { id:"drums", name:"Drums", cat:"instruments", w:3.2, h:2.2, label:"Drums" },
      { id:"wedge", name:"Wedge monitor", cat:"audio", w:1.6, h:1.1, label:"Wedge" },
      { id:"iem", name:"IEM pack", cat:"audio", w:1.4, h:1.0, label:"IEM" },
      { id:"mic", name:"Mic stand", cat:"audio", w:1.0, h:1.0, label:"Mic" },
      { id:"di", name:"DI box", cat:"audio", w:1.0, h:0.8, label:"DI" },
      { id:"amp", name:"Guitar amp", cat:"stage", w:1.6, h:1.2, label:"Amp" },
      { id:"cab", name:"Bass cab", cat:"stage", w:1.8, h:1.3, label:"Cab" },
      { id:"riser", name:"Riser", cat:"stage", w:4.0, h:2.5, label:"Riser" },
      { id:"power", name:"Power drop", cat:"power", w:1.2, h:1.0, label:"Power" },
      { id:"outlet", name:"Outlet", cat:"power", w:1.2, h:1.0, label:"Outlet" }
    ];

    // DOM
    const stagePreset = document.getElementById("stagePreset");
    const unitsSelect = document.getElementById("unitsSelect");
    const unitsBadge = document.getElementById("unitsBadge");
    const stageW = document.getElementById("stageW");
    const stageD = document.getElementById("stageD");
    const wLabel = document.getElementById("wLabel");
    const dLabel = document.getElementById("dLabel");
    const stageMetaText = document.getElementById("stageMetaText");
    const viewTag = document.getElementById("viewTag");
    const flipBtn = document.getElementById("flipBtn");
    const centerBtn = document.getElementById("centerBtn");
    const dupBtn = document.getElementById("dupBtn");
    const delBtn = document.getElementById("delBtn");

    const stageSquare = document.getElementById("stageSquare");
    const stageViewport = document.getElementById("stageViewport");
    const stageInner = document.getElementById("stageInner");
    const labelTop = document.getElementById("labelTop");
    const labelBottom = document.getElementById("labelBottom");

    const viewZoom = document.getElementById("viewZoom");
    const viewZoomVal = document.getElementById("viewZoomVal");
    const resetViewBtn = document.getElementById("resetViewBtn");

    const libSearch = document.getElementById("libSearch");
    const libCat = document.getElementById("libCat");
    const libList = document.getElementById("libList");
    const misc1 = document.getElementById("misc1");
    const misc2 = document.getElementById("misc2");
    const misc3 = document.getElementById("misc3");

    const bandName = document.getElementById("bandName");
    const showNotes = document.getElementById("showNotes");
    const selBadge = document.getElementById("selBadge");
    const selPanel = document.getElementById("selPanel");

    const itLabel = document.getElementById("itLabel");
    const itColor = document.getElementById("itColor");
    const itInput = document.getElementById("itInput");
    const itMix = document.getElementById("itMix");
    const itScale = document.getElementById("itScale");
    const itScaleVal = document.getElementById("itScaleVal");
    const itNotes = document.getElementById("itNotes");
    const rotReset = document.getElementById("rotReset");
    const scaleReset = document.getElementById("scaleReset");

    const printBtn = document.getElementById("printBtn");
    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");
    const importFile = document.getElementById("importFile");

    const clearAllBtn = document.getElementById("clearAllBtn");

    // State
    let project = loadProject();
    let ui = loadUI();

    let selectedIds = new Set();
    let primaryId = null;

    // Drag state
    let drag = null; // {id, startX, startY, itemStartXft, itemStartYft}
    let resize = null; // {id, startX, startY, w0ft, h0ft, scale0}
    let rotate = null; // {id, startX, startY, a0}

    // Rendering scale
    // pixels per foot baseline before auto fitScale
    const PPF = 28;

    init();

    function init(){
      // Apply saved values to controls
      stagePreset.value = project.preset;
      unitsSelect.value = project.units || "ft";
      viewZoom.value = String(project.viewZoom || 100);
      bandName.value = project.bandName || "";
      showNotes.value = project.showNotes || "";

      applyUnitsUI();
      setStageInputsFromProject();

      renderLibrary();
      renderAll();

      // Events
      stagePreset.addEventListener("change", () => {
        project.preset = stagePreset.value;
        if(project.preset !== "custom"){
          const p = PRESETS_FT[project.preset] || PRESETS_FT.medium;
          project.stageWft = p.w;
          project.stageDft = p.d;
          setStageInputsFromProject();
        }
        saveAndRender();
      });

      unitsSelect.addEventListener("change", () => {
        // convert visible inputs to new units but keep internal feet
        const prev = project.units || "ft";
        const next = unitsSelect.value;

        // Read current input values as "prev units" and store to feet
        const wVal = safeNum(stageW.value, displayFromFt(project.stageWft, prev));
        const dVal = safeNum(stageD.value, displayFromFt(project.stageDft, prev));
        project.stageWft = ftFromDisplay(wVal, prev);
        project.stageDft = ftFromDisplay(dVal, prev);

        project.units = next;
        applyUnitsUI();
        setStageInputsFromProject();
        saveAndRender();
      });

      stageW.addEventListener("input", () => {
        project.preset = "custom";
        stagePreset.value = "custom";
        project.stageWft = ftFromDisplay(safeNum(stageW.value, 24), project.units);
        saveAndRender();
      });

      stageD.addEventListener("input", () => {
        project.preset = "custom";
        stagePreset.value = "custom";
        project.stageDft = ftFromDisplay(safeNum(stageD.value, 16), project.units);
        saveAndRender();
      });

      bandName.addEventListener("input", () => {
        project.bandName = bandName.value;
        saveProject(project);
      });
      showNotes.addEventListener("input", () => {
        project.showNotes = showNotes.value;
        saveProject(project);
      });

      flipBtn.addEventListener("click", () => {
        project.audienceView = !project.audienceView;
        saveAndRender();
      });

      centerBtn.addEventListener("click", centerSelection);
      dupBtn.addEventListener("click", duplicateSelection);
      delBtn.addEventListener("click", deleteSelection);

      viewZoom.addEventListener("input", () => {
        project.viewZoom = safeNum(viewZoom.value, 100);
        viewZoomVal.textContent = `${project.viewZoom}%`;
        saveProject(project);
        applyStageTransform();
      });

      resetViewBtn.addEventListener("click", () => {
        project.viewZoom = 100;
        viewZoom.value = "100";
        viewZoomVal.textContent = "100%";
        saveProject(project);
        applyStageTransform();
      });

      libSearch.addEventListener("input", renderLibrary);
      libCat.addEventListener("change", renderLibrary);

      misc1.addEventListener("click", () => addMisc(1));
      misc2.addEventListener("click", () => addMisc(2));
      misc3.addEventListener("click", () => addMisc(3));

      printBtn.addEventListener("click", () => {
        // best practice: force a reflow and ensure transform applied
        applyStageTransform();
        setTimeout(() => window.print(), 30);
      });

      exportBtn.addEventListener("click", exportProject);
      importBtn.addEventListener("click", () => importFile.click());
      importFile.addEventListener("change", importProject);

      clearAllBtn.addEventListener("click", () => {
        if(!confirm("Reset project? This clears items and notes in this browser.")) return;
        project = structuredClone(DEFAULTS);
        selectedIds.clear();
        primaryId = null;
        stagePreset.value = project.preset;
        unitsSelect.value = project.units;
        viewZoom.value = "100";
        bandName.value = "";
        showNotes.value = "";
        applyUnitsUI();
        setStageInputsFromProject();
        saveAndRender(true);
      });

      // Stage interactions
      stageViewport.addEventListener("pointerdown", onStagePointerDown);
      window.addEventListener("pointermove", onPointerMove);
      window.addEventListener("pointerup", onPointerUp);

      // Keyboard
      window.addEventListener("keydown", onKeyDown);

      // Resize observer for fitScale
      const ro = new ResizeObserver(() => applyStageTransform());
      ro.observe(stageSquare);
      ro.observe(stageViewport);

      // initial UI
      viewZoomVal.textContent = `${project.viewZoom || 100}%`;
      applyStageTransform();
    }

    function applyUnitsUI(){
      const u = project.units || "ft";
      unitsBadge.textContent = `Units: ${u}`;
      wLabel.textContent = `Stage width (${u})`;
      dLabel.textContent = `Stage depth (${u})`;

      // steps
      if(u === "m"){
        stageW.step = "0.1";
        stageD.step = "0.1";
      }else{
        stageW.step = "0.1";
        stageD.step = "0.1";
      }
    }

    function setStageInputsFromProject(){
      const u = project.units || "ft";
      stageW.value = round1(displayFromFt(project.stageWft, u));
      stageD.value = round1(displayFromFt(project.stageDft, u));
      updateStageMetaText();
    }

    function updateStageMetaText(){
      const u = project.units || "ft";
      const w = round1(displayFromFt(project.stageWft, u));
      const d = round1(displayFromFt(project.stageDft, u));
      stageMetaText.textContent = `Stage: ${w} ${u} x ${d} ${u}`;
      viewTag.textContent = project.audienceView ? "Audience view" : "Stage view";
      labelTop.textContent = project.audienceView ? "AUDIENCE" : "UPSTAGE";
      labelBottom.textContent = project.audienceView ? "UPSTAGE" : "AUDIENCE";
    }

    function renderLibrary(){
      const q = (libSearch.value || "").trim().toLowerCase();
      const c = libCat.value;

      const filtered = LIB.filter(it => {
        const matchesQ = !q || it.name.toLowerCase().includes(q) || it.label.toLowerCase().includes(q);
        const matchesC = (c === "all") || (it.cat === c);
        return matchesQ && matchesC;
      });

      libList.innerHTML = "";
      filtered.forEach(it => {
        const el = document.createElement("div");
        el.className = "libItem";
        el.innerHTML = `
          <div>
            <div class="name">${escapeHtml(it.name)}</div>
            <div class="meta">${escapeHtml(it.cat)} - ${escapeHtml(it.label)}</div>
          </div>
          <button class="button">Add</button>
        `;
        el.querySelector("button").addEventListener("click", () => addItemFromLib(it));
        libList.appendChild(el);
      });

      if(filtered.length === 0){
        const empty = document.createElement("div");
        empty.className = "tiny";
        empty.style.padding = "10px";
        empty.textContent = "No matches. Try a different search.";
        libList.appendChild(empty);
      }
    }

    function addMisc(n){
      const sizes = {
        1: { w: 2.2, h: 1.4, label: "Misc" },
        2: { w: 3.0, h: 1.8, label: "Misc" },
        3: { w: 4.0, h: 2.4, label: "Misc" }
      };
      const s = sizes[n] || sizes[1];
      addItem({
        type: `misc${n}`,
        label: `${s.label} ${n}`,
        wft: s.w,
        hft: s.h,
        color: "#4aa3ff"
      });
    }

    function addItemFromLib(def){
      addItem({
        type: def.id,
        label: def.label,
        wft: def.w,
        hft: def.h,
        color: "#4aa3ff"
      });
    }

    function addItem({type,label,wft,hft,color}){
      const id = project.nextId++;
      const center = getStageCenterFt();
      const item = {
        id,
        type,
        label: label || "Item",
        input: "",
        mix: "",
        notes: "",
        color: color || "#4aa3ff",
        xft: center.x - (wft/2),
        yft: center.y - (hft/2),
        wft,
        hft,
        rot: 0,
        scale: 100
      };
      project.items.push(item);
      selectedIds = new Set([id]);
      primaryId = id;
      saveAndRender();
      openSelectionPanel();
    }

    function renderAll(){
      updateStageMetaText();
      renderItems();
      renderSelectionPanel();
      applyStageTransform();
    }

    function renderItems(){
      stageInner.innerHTML = "";
      const av = !!project.audienceView;

      project.items.forEach(item => {
        const el = document.createElement("div");
        el.className = "item";
        el.dataset.id = String(item.id);

        if(selectedIds.has(item.id)) el.classList.add("selected");

        // position and size in pixels (feet to pixels)
        const { xpx, ypx, wpx, hpx } = itemToPixels(item, av);

        el.style.left = `${xpx}px`;
        el.style.top  = `${ypx}px`;
        el.style.width  = `${wpx}px`;
        el.style.height = `${hpx}px`;

        const rot = (av ? (item.rot + 180) : item.rot);
        const sc = item.scale / 100;
        el.style.transform = `rotate(${rot}deg) scale(${sc})`;

        // color
        el.style.background = hexToRgba(item.color, 0.18);
        el.style.borderColor = hexToRgba(item.color, 0.55);

        el.innerHTML = `
          <div>
            <div class="lbl">${escapeHtml(item.label || "Item")}</div>
            ${item.input || item.mix ? `<div class="subLbl">${escapeHtml([item.input, item.mix].filter(Boolean).join(" - "))}</div>` : ""}
          </div>
          <div class="handles" style="${(primaryId===item.id && selectedIds.size===1) ? "" : "display:none;"}">
            <div class="handle br" data-handle="br" title="Resize"></div>
            <div class="rotateDot" data-handle="rot" title="Rotate"></div>
          </div>
        `;

        // pointerdown for drag
        el.addEventListener("pointerdown", (e) => onItemPointerDown(e, item.id));

        // resize/rotate handles
        const br = el.querySelector(".handle.br");
        const rd = el.querySelector(".rotateDot");
        if(br){
          br.addEventListener("pointerdown", (e) => onResizeDown(e, item.id));
        }
        if(rd){
          rd.addEventListener("pointerdown", (e) => onRotateDown(e, item.id));
        }

        stageInner.appendChild(el);
      });

      // size stageInner to the stage pixel size
      const stageWpx = project.stageWft * PPF;
      const stageDpx = project.stageDft * PPF;
      stageInner.style.width = `${stageWpx}px`;
      stageInner.style.height = `${stageDpx}px`;
      stageInner.style.marginLeft = `${-stageWpx/2}px`;
      stageInner.style.marginTop = `${-stageDpx/2}px`;
    }

    function itemToPixels(item, audienceView){
      // stage coords are in feet from top-left in stage view
      // audience view flips 180, so position mirrors around center
      const stageW = project.stageWft;
      const stageD = project.stageDft;

      let x = item.xft;
      let y = item.yft;
      let w = item.wft;
      let h = item.hft;

      if(audienceView){
        x = (stageW - (item.xft + item.wft));
        y = (stageD - (item.yft + item.hft));
      }

      return {
        xpx: x * PPF,
        ypx: y * PPF,
        wpx: w * PPF,
        hpx: h * PPF
      };
    }

    function applyStageTransform(){
      // Fit the stage into viewport at 100%, then apply view zoom inside the clip.
      const vp = stageViewport.getBoundingClientRect();
      const pad = 0; // already inset by stageViewport
      const vw = Math.max(1, vp.width - pad*2);
      const vh = Math.max(1, vp.height - pad*2);

      const stageWpx = project.stageWft * PPF;
      const stageDpx = project.stageDft * PPF;

      const fitScale = Math.min(vw / stageWpx, vh / stageDpx);

      const vz = (project.viewZoom || 100) / 100;
      const scale = fitScale * vz;

      stageInner.style.transform = `translate(-50%, -50%) scale(${scale})`;
      // NOTE: translate(-50%, -50%) here uses the stageInner itself being positioned at center via left/top 50%.
    }

    function renderSelectionPanel(){
      const item = getPrimaryItem();
      if(!item){
        selBadge.textContent = "No selection";
        selPanel.style.display = "none";
        return;
      }

      selPanel.style.display = "block";
      selBadge.textContent = selectedIds.size > 1 ? `${selectedIds.size} selected` : `Selected: ${item.label || "Item"}`;

      itLabel.value = item.label || "";
      itInput.value = item.input || "";
      itMix.value = item.mix || "";
      itNotes.value = item.notes || "";
      itColor.value = normalizeHex(item.color || "#4aa3ff");

      itScale.value = String(item.scale || 100);
      itScaleVal.textContent = `${item.scale || 100}%`;
    }

    function openSelectionPanel(){
      // on mobile you might want accordions later. For now, just keep it visible.
      renderSelectionPanel();
    }

    // Info panel inputs
    itLabel.addEventListener("input", () => {
      const item = getPrimaryItem();
      if(!item) return;
      item.label = itLabel.value;
      saveAndRender();
    });
    itInput.addEventListener("input", () => {
      const item = getPrimaryItem();
      if(!item) return;
      item.input = itInput.value;
      saveAndRender();
    });
    itMix.addEventListener("input", () => {
      const item = getPrimaryItem();
      if(!item) return;
      item.mix = itMix.value;
      saveAndRender();
    });
    itNotes.addEventListener("input", () => {
      const item = getPrimaryItem();
      if(!item) return;
      item.notes = itNotes.value;
      saveProject(project);
    });
    itColor.addEventListener("input", () => {
      const item = getPrimaryItem();
      if(!item) return;
      item.color = itColor.value;
      saveAndRender();
    });
    itScale.addEventListener("input", () => {
      const item = getPrimaryItem();
      if(!item) return;
      item.scale = safeNum(itScale.value, 100);
      itScaleVal.textContent = `${item.scale}%`;
      saveAndRender();
    });

    rotReset.addEventListener("click", () => {
      const item = getPrimaryItem();
      if(!item) return;
      item.rot = 0;
      saveAndRender();
    });

    scaleReset.addEventListener("click", () => {
      const item = getPrimaryItem();
      if(!item) return;
      item.scale = 100;
      itScale.value = "100";
      itScaleVal.textContent = "100%";
      saveAndRender();
    });

    function onStagePointerDown(e){
      // clicking empty stage clears selection
      if(e.target.closest(".item")) return;

      selectedIds.clear();
      primaryId = null;
      renderAll();
    }

    function onItemPointerDown(e, id){
      // ignore if grabbing handle
      if(e.target && e.target.dataset && e.target.dataset.handle) return;

      e.preventDefault();
      e.stopPropagation();

      const multi = e.shiftKey || e.metaKey || e.ctrlKey;

      if(multi){
        if(selectedIds.has(id)) selectedIds.delete(id);
        else selectedIds.add(id);
        primaryId = id;
      }else{
        selectedIds = new Set([id]);
        primaryId = id;
      }

      renderAll();

      const item = findItem(id);
      if(!item) return;

      const p = clientToStageFt(e.clientX, e.clientY);
      drag = {
        id,
        startX: e.clientX,
        startY: e.clientY,
        itemStartXft: item.xft,
        itemStartYft: item.yft,
        pointerStageXft: p.xft,
        pointerStageYft: p.yft
      };

      e.target.setPointerCapture?.(e.pointerId);
    }

    function onResizeDown(e, id){
      e.preventDefault();
      e.stopPropagation();

      const item = findItem(id);
      if(!item) return;

      selectedIds = new Set([id]);
      primaryId = id;
      renderAll();

      resize = {
        id,
        startX: e.clientX,
        startY: e.clientY,
        w0ft: item.wft,
        h0ft: item.hft
      };
      e.target.setPointerCapture?.(e.pointerId);
    }

    function onRotateDown(e, id){
      e.preventDefault();
      e.stopPropagation();

      const item = findItem(id);
      if(!item) return;

      selectedIds = new Set([id]);
      primaryId = id;
      renderAll();

      rotate = {
        id,
        startX: e.clientX,
        startY: e.clientY,
        a0: item.rot
      };
      e.target.setPointerCapture?.(e.pointerId);
    }

    function onPointerMove(e){
      if(drag){
        const item = findItem(drag.id);
        if(!item) return;

        const delta = screenDeltaToStageDeltaFt(e.clientX - drag.startX, e.clientY - drag.startY);

        // if multi selection, move all selected
        if(selectedIds.size > 1){
          selectedIds.forEach(sid => {
            const it = findItem(sid);
            if(!it) return;
            it.xft = clamp(it.xft + delta.dxft, 0, project.stageWft - it.wft);
            it.yft = clamp(it.yft + delta.dyft, 0, project.stageDft - it.hft);
          });
        }else{
          item.xft = clamp(drag.itemStartXft + delta.dxft, 0, project.stageWft - item.wft);
          item.yft = clamp(drag.itemStartYft + delta.dyft, 0, project.stageDft - item.hft);
        }

        saveProject(project);
        renderItems();
        renderSelectionPanel();
        applyStageTransform();
        return;
      }

      if(resize){
        const item = findItem(resize.id);
        if(!item) return;

        const delta = screenDeltaToStageDeltaFt(e.clientX - resize.startX, e.clientY - resize.startY);
        item.wft = clamp(resize.w0ft + delta.dxft, 0.6, project.stageWft);
        item.hft = clamp(resize.h0ft + delta.dyft, 0.6, project.stageDft);

        // keep inside bounds
        item.xft = clamp(item.xft, 0, project.stageWft - item.wft);
        item.yft = clamp(item.yft, 0, project.stageDft - item.hft);

        saveProject(project);
        renderItems();
        applyStageTransform();
        return;
      }

      if(rotate){
        const item = findItem(rotate.id);
        if(!item) return;

        // simple rotation based on horizontal movement
        const dx = (e.clientX - rotate.startX);
        item.rot = normalizeDeg(rotate.a0 + dx * 0.6);

        saveProject(project);
        renderItems();
        applyStageTransform();
        return;
      }
    }

    function onPointerUp(){
      drag = null;
      resize = null;
      rotate = null;
      saveProject(project);
    }

    function onKeyDown(e){
      // duplicate
      if((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === "d"){
        e.preventDefault();
        duplicateSelection();
        return;
      }

      // delete
      if(e.key === "Delete" || e.key === "Backspace"){
        // do not delete while typing
        const tag = (document.activeElement?.tagName || "").toLowerCase();
        if(tag === "input" || tag === "textarea") return;
        deleteSelection();
        return;
      }

      // nudge (Shift+Arrows)
      if(e.shiftKey && ["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)){
        e.preventDefault();
        nudgeSelection(e.key);
      }

      // escape clears selection
      if(e.key === "Escape"){
        selectedIds.clear();
        primaryId = null;
        renderAll();
      }
    }

    function nudgeSelection(key){
      if(selectedIds.size === 0) return;

      // 0.25 ft per nudge (classic), in meters mode this is still the same internally
      const stepFt = 0.25;

      let dx = 0, dy = 0;
      if(key === "ArrowLeft") dx = -stepFt;
      if(key === "ArrowRight") dx = stepFt;
      if(key === "ArrowUp") dy = -stepFt;
      if(key === "ArrowDown") dy = stepFt;

      selectedIds.forEach(id => {
        const it = findItem(id);
        if(!it) return;
        it.xft = clamp(it.xft + dx, 0, project.stageWft - it.wft);
        it.yft = clamp(it.yft + dy, 0, project.stageDft - it.hft);
      });

      saveAndRender();
    }

    function centerSelection(){
      if(selectedIds.size === 0) return;

      // center bounding box of selected within stage
      const items = [...selectedIds].map(findItem).filter(Boolean);
      if(items.length === 0) return;

      const minX = Math.min(...items.map(i => i.xft));
      const minY = Math.min(...items.map(i => i.yft));
      const maxX = Math.max(...items.map(i => i.xft + i.wft));
      const maxY = Math.max(...items.map(i => i.yft + i.hft));

      const bw = maxX - minX;
      const bh = maxY - minY;

      const targetX = (project.stageWft - bw) / 2;
      const targetY = (project.stageDft - bh) / 2;

      items.forEach(i => {
        i.xft = clamp(i.xft - minX + targetX, 0, project.stageWft - i.wft);
        i.yft = clamp(i.yft - minY + targetY, 0, project.stageDft - i.hft);
      });

      saveAndRender();
    }

    function duplicateSelection(){
      if(selectedIds.size === 0) return;

      const items = [...selectedIds].map(findItem).filter(Boolean);
      if(items.length === 0) return;

      const newIds = [];
      items.forEach(it => {
        const copy = structuredClone(it);
        copy.id = project.nextId++;
        copy.xft = clamp(copy.xft + 0.5, 0, project.stageWft - copy.wft);
        copy.yft = clamp(copy.yft + 0.5, 0, project.stageDft - copy.hft);
        project.items.push(copy);
        newIds.push(copy.id);
      });

      selectedIds = new Set(newIds);
      primaryId = newIds[newIds.length - 1] || null;

      saveAndRender();
    }

    function deleteSelection(){
      if(selectedIds.size === 0) return;
      const ids = new Set(selectedIds);
      project.items = project.items.filter(it => !ids.has(it.id));
      selectedIds.clear();
      primaryId = null;
      saveAndRender();
    }

    function saveAndRender(force=false){
      saveProject(project);
      renderAll();
    }

    // Export / Import
    function exportProject(){
      // keep internal feet + units selection
      const data = {
        version: VERSION,
        exportedAt: new Date().toISOString(),
        project: project
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `stageplot_project_v${VERSION.replaceAll(" ", "_").replaceAll("(", "").replaceAll(")", "").replaceAll(".", "_")}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(() => URL.revokeObjectURL(url), 6000);
    }

    async function importProject(){
      const f = importFile.files && importFile.files[0];
      if(!f) return;

      try{
        const txt = await f.text();
        const json = JSON.parse(txt);

        const incoming = json.project ? json.project : json;

        // minimal validation
        if(!incoming || !Array.isArray(incoming.items)) throw new Error("Invalid project JSON");

        // migrate older projects
        project = migrateProject(incoming);

        // sync controls
        stagePreset.value = project.preset || "custom";
        unitsSelect.value = project.units || "ft";
        viewZoom.value = String(project.viewZoom || 100);
        bandName.value = project.bandName || "";
        showNotes.value = project.showNotes || "";

        applyUnitsUI();
        setStageInputsFromProject();

        selectedIds.clear();
        primaryId = null;

        saveAndRender(true);
        alert("Imported project.");
      }catch(err){
        console.error(err);
        alert("Could not import that file. Make sure it is a StagePlot project JSON.");
      }finally{
        importFile.value = "";
      }
    }

    function migrateProject(p){
      const out = structuredClone(DEFAULTS);

      out.units = (p.units === "m" || p.units === "ft") ? p.units : "ft";
      out.preset = p.preset || "custom";
      out.stageWft = safeNum(p.stageWft, safeNum(p.stageW, 24));
      out.stageDft = safeNum(p.stageDft, safeNum(p.stageD, 16));
      out.audienceView = !!p.audienceView;
      out.viewZoom = safeNum(p.viewZoom, 100);
      out.bandName = p.bandName || "";
      out.showNotes = p.showNotes || "";
      out.nextId = safeNum(p.nextId, 1);

      out.items = (p.items || []).map(it => ({
        id: safeNum(it.id, out.nextId++),
        type: it.type || "item",
        label: it.label || "Item",
        input: it.input || "",
        mix: it.mix || "",
        notes: it.notes || "",
        color: normalizeHex(it.color || "#4aa3ff"),
        xft: safeNum(it.xft, safeNum(it.x, 0)),
        yft: safeNum(it.yft, safeNum(it.y, 0)),
        wft: safeNum(it.wft, safeNum(it.w, 2)),
        hft: safeNum(it.hft, safeNum(it.h, 1.2)),
        rot: safeNum(it.rot, 0),
        scale: safeNum(it.scale, 100)
      }));

      // keep nextId above max
      const maxId = out.items.reduce((m,i) => Math.max(m, i.id), 0);
      out.nextId = Math.max(out.nextId, maxId + 1);

      return out;
    }

    // Helpers - coordinate conversion
    function getStageCenterFt(){
      return { x: project.stageWft/2, y: project.stageDft/2 };
    }

    function clientToStageFt(clientX, clientY){
      // Convert screen coords to stage coords in feet, taking into account fitScale and viewZoom and center translate
      const vp = stageViewport.getBoundingClientRect();
      const x = clientX - vp.left - 10; // inner padding illusion, fine for feel
      const y = clientY - vp.top - 10;

      const vw = vp.width;
      const vh = vp.height;

      const stageWpx = project.stageWft * PPF;
      const stageDpx = project.stageDft * PPF;

      const fitScale = Math.min(vw / stageWpx, vh / stageDpx);
      const vz = (project.viewZoom || 100) / 100;
      const scale = fitScale * vz;

      // stageInner is centered in viewport
      const cx = vw / 2;
      const cy = vh / 2;

      // coordinates relative to stageInner top-left in pixels
      const relXpx = (x - cx) / scale + (stageWpx / 2);
      const relYpx = (y - cy) / scale + (stageDpx / 2);

      return {
        xft: relXpx / PPF,
        yft: relYpx / PPF
      };
    }

    function screenDeltaToStageDeltaFt(dxScreen, dyScreen){
      const vp = stageViewport.getBoundingClientRect();
      const vw = vp.width;
      const vh = vp.height;

      const stageWpx = project.stageWft * PPF;
      const stageDpx = project.stageDft * PPF;

      const fitScale = Math.min(vw / stageWpx, vh / stageDpx);
      const vz = (project.viewZoom || 100) / 100;
      const scale = fitScale * vz;

      return {
        dxft: (dxScreen / scale) / PPF,
        dyft: (dyScreen / scale) / PPF
      };
    }

    // Selection helpers
    function findItem(id){ return project.items.find(it => it.id === id); }
    function getPrimaryItem(){
      if(primaryId != null) return findItem(primaryId);
      const first = selectedIds.values().next().value;
      if(first == null) return null;
      return findItem(first);
    }

    // Storage
    function loadProject(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return structuredClone(DEFAULTS);
        const parsed = JSON.parse(raw);
        return migrateProject(parsed);
      }catch(e){
        console.warn("loadProject failed", e);
        return structuredClone(DEFAULTS);
      }
    }
    function saveProject(p){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(p));
      // autosave badge stays
    }
    function loadUI(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY_UI);
        return raw ? JSON.parse(raw) : {};
      }catch(e){
        return {};
      }
    }
    function saveUI(x){
      localStorage.setItem(STORAGE_KEY_UI, JSON.stringify(x || {}));
    }

    // Unit conversion (display only)
    function displayFromFt(ft, units){
      if(units === "m") return ft / FT_PER_M;
      return ft;
    }
    function ftFromDisplay(val, units){
      if(units === "m") return val * FT_PER_M;
      return val;
    }

    // Utils
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function safeNum(v, fallback){
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    }
    function round1(n){
      const x = Number(n);
      if(!Number.isFinite(x)) return "0";
      return (Math.round(x * 10) / 10).toFixed(1).replace(/\.0$/, "");
    }
    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }
    function normalizeDeg(d){
      let x = d % 360;
      if(x < 0) x += 360;
      return x;
    }
    function normalizeHex(h){
      if(!h) return "#4aa3ff";
      const s = String(h).trim();
      if(/^#[0-9a-fA-F]{6}$/.test(s)) return s;
      if(/^#[0-9a-fA-F]{3}$/.test(s)){
        const r = s[1], g = s[2], b = s[3];
        return `#${r}${r}${g}${g}${b}${b}`;
      }
      return "#4aa3ff";
    }
    function hexToRgba(hex, a){
      const h = normalizeHex(hex);
      const r = parseInt(h.slice(1,3),16);
      const g = parseInt(h.slice(3,5),16);
      const b = parseInt(h.slice(5,7),16);
      return `rgba(${r},${g},${b},${clamp(a,0,1)})`;
    }
  </script>
</body>
</html>